(()=>{function ot(t,i,s,e){this.hash=e,this.p=t,this.n=i,this.d=s,this.lambda_n_acc=0,this.lambda_t_acc=0}function q(t,i,s){return t<i?i:t>s?s:t}function vt(t){return t/180*Math.PI}function lt(t){return t*.02}function yt(t){return t*50}function r(t,i){this.x=t||0,this.y=i||0}r.zero=new r(0,0);r.prototype.toString=function(){return["x:",this.x,"y:",this.y].join(" ")};r.prototype.set=function(t,i){return this.x=t,this.y=i,this};r.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this};r.prototype.duplicate=function(){return new r(this.x,this.y)};r.prototype.equal=function(t){return!(this.x!=t.x||this.y!=t.y)};r.prototype.add=function(t,i){return this.x=t.x+i.x,this.y=t.y+i.y,this};r.prototype.addself=function(t){return this.x+=t.x,this.y+=t.y,this};r.prototype.sub=function(t,i){return this.x=t.x-i.x,this.y=t.y-i.y,this};r.prototype.subself=function(t){return this.x-=t.x,this.y-=t.y,this};r.prototype.scale=function(t){return this.x*=t,this.y*=t,this};r.prototype.scale2=function(t){return this.x*=t.x,this.y*=t.y,this};r.prototype.mad=function(t,i){this.x+=t.x*i,this.y+=t.y*i};r.prototype.neg=function(){return this.x*=-1,this.y*=-1,this};r.prototype.rcp=function(){return this.x=1/this.x,this.y=1/this.y,this};r.prototype.lengthsq=function(){return this.x*this.x+this.y*this.y};r.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};r.prototype.normalize=function(){var t=this.x!=0||this.y!=0?1/Math.sqrt(this.x*this.x+this.y*this.y):0;return this.x*=t,this.y*=t,this};r.prototype.dot=function(t){return this.x*t.x+this.y*t.y};r.prototype.cross=function(t){return this.x*t.y-this.y*t.x};r.prototype.toAngle=function(){return Math.atan2(this.y,this.x)};r.prototype.rotation=function(t){return this.x=Math.cos(t),this.y=Math.sin(t),this};r.prototype.rotate=function(t){var i=Math.cos(t),s=Math.sin(t);return this.set(this.x*i-this.y*s,this.x*s+this.y*i)};r.prototype.lerp=function(t,i,s){return this.add(r.scale(t,1-s),r.scale(i,s))};r.add=function(t,i){return new r(t.x+i.x,t.y+i.y)};r.sub=function(t,i){return new r(t.x-i.x,t.y-i.y)};r.scale=function(t,i){return new r(t.x*i,t.y*i)};r.scale2=function(t,i){return new r(t.x*i.x,t.y*i.y)};r.mad=function(t,i,s){return new r(t.x+i.x*s,t.y+i.y*s)};r.neg=function(t){return new r(-t.x,-t.y)};r.rcp=function(t){return new r(1/t.x,1/t.y)};r.normalize=function(t){var i=t.x!=0||t.y!=0?1/Math.sqrt(t.x*t.x+t.y*t.y):0;return new r(t.x*i,t.y*i)};r.dot=function(t,i){return t.x*i.x+t.y*i.y};r.cross=function(t,i){return t.x*i.y-t.y*i.x};r.toAngle=function(t){return Math.atan2(t.y,t.x)};r.rotation=function(t){return new r(Math.cos(t),Math.sin(t))};r.rotate=function(t,i){var s=Math.cos(i),e=Math.sin(i);return new r(t.x*s-t.y*e,t.x*e+t.y*s)};r.perp=function(t){return new r(-t.y,t.x)};r.rperp=function(t){return new r(t.y,-t.x)};r.dist=function(t,i){var s=i.x-t.x,e=i.y-t.y;return Math.sqrt(s*s+e*e)};r.distsq=function(t,i){var s=i.x-t.x,e=i.y-t.y;return s*s+e*e};r.lerp=function(t,i,s){return r.add(r.scale(t,1-s),r.scale(i,s))};r.truncate=function(t,i){var s=t.duplicate(),e=t.x*t.x+t.y*t.y;return e>i*i&&s.scale(i/Math.sqrt(e)),s};function R(t,i,s){this.x=t||0,this.y=i||0,this.z=s||0}R.zero=new R(0,0,0);R.prototype.toString=function(){return["x:",this.x,"y:",this.y,"z:",this.z].join(" ")};R.prototype.set=function(t,i,s){return this.x=t,this.y=i,this.z=s,this};R.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this};R.prototype.duplicate=function(){return new R(this.x,this.y,this.z)};R.prototype.equal=function(t){return!(this.x!=t.x||this.y!=t.y||this.z!=t.z)};R.prototype.add=function(t,i){return this.x=t.x+i.x,this.y=t.y+i.y,this.z=t.z+i.z,this};R.prototype.addself=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this};R.prototype.sub=function(t,i){return this.x=t.x-i.x,this.y=t.y-i.y,this.z=t.z-i.z,this};R.prototype.subself=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this};R.prototype.scale=function(t){return this.x*=t,this.y*=t,this.z*=t,this};R.prototype.mad=function(t,i){this.x+=t.x*i,this.y+=t.y*i,this.z+=t.z*i};R.prototype.neg=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this};R.prototype.rcp=function(){return this.x=1/this.x,this.y=1/this.y,this.z=1/this.z,this};R.prototype.lengthsq=function(){return this.x*this.x+this.y*this.y+this.z*this.z};R.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};R.prototype.normalize=function(){var t=this.x!=0||this.y!=0||this.z!=0?1/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z):0;return this.x*=t,this.y*=t,this.z*=t,this};R.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z};R.prototype.toVec2=function(){return new r(this.x,this.y)};R.fromVec2=function(t,i){return new R(t.x,t.y,i)};R.truncate=function(t,i){var s=t.duplicate(),e=t.x*t.x+t.y*t.y+t.z*t.z;return e>i*i&&s.scale(i/Math.sqrt(e)),s};function D(t,i,s,e){this._11=t||0,this._12=i||0,this._21=s||0,this._22=e||0}D.zero=new D(0,0,0,0);D.prototype.toString=function(){return["[",this._11,this._12,this_21,this._22,"]"].join(" ")};D.prototype.set=function(t,i,s,e){return this._11=t,this._12=i,this._21=s,this._22=e,this};D.prototype.copy=function(t){return this._11=t._11,this._12=t._12,this._21=t._21,this._22=t._22,this};D.prototype.duplicate=function(){return new D(this._11,this._12,this._21,this._22)};D.prototype.scale=function(t){return this._11*=t,this._12*=t,this._21*=t,this._22*=t,this};D.prototype.mul=function(t){return this.set(this._11*m2._11+this._12*m2._21,this._11*m2._12+this._12*m2._22,this._21*m2._11+this._22*m2._21,this._21*m2._12+this._22*m2._22)};D.prototype.mulvec=function(t){return new r(this._11*t.x+this._12*t.y,this._21*t.x+this._22*t.y)};D.prototype.invert=function(){var t=this._11*this._22-this._12*this._21;return t!=0&&(t=1/t),this.set(this._22*t,-this._12*t,-this._21*t,this._11*t)};D.prototype.solve=function(t){var i=this._11*this._22-this._12*this._21;return i!=0&&(i=1/i),new r(i*(this._22*t.x-this._12*t.y),i*(this._11*t.y-this._21*t.x))};D.mul=function(t,i){return new D(t._11*i._11+t._12*i._21,t._11*i._12+t._12*i._22,t._21*i._11+t._22*i._21,t._21*i._12+t._22*i._22)};function Y(t,i,s,e,o,h,n,a,u){this._11=t||0,this._12=i||0,this._13=s||0,this._21=e||0,this._22=o||0,this._23=h||0,this._31=n||0,this._32=a||0,this._33=u||0}Y.zero=new Y(0,0,0,0,0,0,0,0,0);Y.prototype.toString=function(){return["[",this._11,this._12,this._13,this_21,this._22,this._23,this._31,this._32,this._33,"]"].join(" ")};Y.prototype.set=function(t,i,s,e,o,h,n,a,u){return this._11=t,this._12=i,this._13=s,this._21=e,this._22=o,this._23=h,this._31=n,this._32=a,this._33=u,this};Y.prototype.copy=function(t){return this._11=t._11,this._12=t._12,this._13=t._13,this._21=t._21,this._22=t._22,this._23=t._23,this._31=t._31,this._32=t._32,this._33=t._33,this};Y.prototype.duplicate=function(){return new Y(this._11,this._12,this._13,this._21,this._22,this._23,this._31,this._32,this._33)};Y.prototype.scale=function(t){return this._11*=t,this._12*=t,this._13*=t,this._21*=t,this._22*=t,this._23*=t,this._31*=t,this._32*=t,this._33*=t,this};Y.prototype.mul=function(t){return this.set(this._11*m2._11+this._12*m2._21+this._13*m2._31,this._11*m2._12+this._12*m2._22+this._13*m2._32,this._11*m2._13+this._12*m2._23+this._13*m2._33,this._21*m2._11+this._22*m2._21+this._23*m2._31,this._21*m2._12+this._22*m2._22+this._23*m2._32,this._21*m2._13+this._22*m2._23+this._23*m2._33,this._31*m2._11+this._32*m2._21+this._33*m2._31,this._31*m2._12+this._32*m2._22+this._33*m2._32,this._31*m2._13+this._32*m2._23+this._33*m2._33)};Y.prototype.mulvec=function(t){return new r(this._11*t.x+this._12*t.y+this._13*t.z,this._21*t.x+this._22*t.y+this._23*t.z,this._31*t.x+this._32*t.y+this._33*t.z)};Y.prototype.invert=function(){var t=this._22*this._33-this._23*this._32,i=this._23*this._31-this._21*this._33,s=this._21*this._32-this._22*this._31,e=this._11*t+this._12*i+this._13*s;e!=0&&(e=1/e);var o=this._13*this._32-this._12*this._33,h=this._11*this._33-this._13*this._31,n=this._12*this._31-this._11*this._32,a=this._12*this._23-this._13*this._22,u=this._13*this._21-this._11*this._23,c=this._11*this._22-this._12*this._21;return this.set(t*e,i*e,s*e,o*e,h*e,n*e,a*e,u*e,c*e)};Y.prototype.solve2x2=function(t){var i=this._11*this._22-this._12*this._21;return i!=0&&(i=1/i),new r(i*(this._22*t.x-this._12*t.y),i*(this._11*t.y-this._21*t.x))};Y.prototype.solve=function(t){var i=this._22*this._33-this._23*this._32,s=this._23*this._31-this._21*this._33,e=this._21*this._32-this._22*this._31,o=this._11*i+this._12*s+this._13*e;o!=0&&(o=1/o);var h=this._13*this._32-this._12*this._33,n=this._11*this._33-this._13*this._31,a=this._12*this._31-this._11*this._32,u=this._12*this._23-this._13*this._22,c=this._13*this._21-this._11*this._23,m=this._11*this._22-this._12*this._21;return new R(o*(i*t.x+s*t.y+e*t.z),o*(h*t.x+n*t.y+a*t.z),o*(u*t.x+c*t.y+m*t.z))};Y.mul=function(t,i){return new Y(t._11*i._11+t._12*i._21+t._13*i._31,t._11*i._12+t._12*i._22+t._13*i._32,t._11*i._13+t._12*i._23+t._13*i._33,t._21*i._11+t._22*i._21+t._23*i._31,t._21*i._12+t._22*i._22+t._23*i._32,t._21*i._13+t._22*i._23+t._23*i._33,t._31*i._11+t._32*i._21+t._33*i._31,t._31*i._12+t._32*i._22+t._33*i._32,t._31*i._13+t._32*i._23+t._33*i._33)};var at=function(t,i){this.t=t.duplicate(),this.c=Math.cos(i),this.s=Math.sin(i)};at.prototype.set=function(t,i){return this.t.copy(t),this.c=Math.cos(i),this.s=Math.sin(i),this};at.prototype.setRotation=function(t){return this.c=Math.cos(t),this.s=Math.sin(t),this};at.prototype.setPosition=function(t){return this.t.copy(t),this};at.prototype.identity=function(){return this.t.set(0,0),this.c=1,this.s=0,this};at.prototype.rotate=function(t){return new r(t.x*this.c-t.y*this.s,t.x*this.s+t.y*this.c)};at.prototype.unrotate=function(t){return new r(t.x*this.c+t.y*this.s,-t.x*this.s+t.y*this.c)};at.prototype.transform=function(t){return new r(t.x*this.c-t.y*this.s+this.t.x,t.x*this.s+t.y*this.c+this.t.y)};at.prototype.untransform=function(t){var i=t.x-this.t.x,s=t.y-this.t.y;return new r(i*this.c+s*this.s,-i*this.s+s*this.c)};var O=function(t,i){this.mins=t?new r(t.x,t.y):new r(1/0,1/0),this.maxs=i?new r(i.x,i.y):new r(-1/0,-1/0)};O.prototype.toString=function(){return["mins:",this.mins.toString(),"maxs:",this.maxs.toString()].join(" ")};O.prototype.set=function(t,i){this.mins.set(t.x,t.y),this.maxs.set(i.x,i.y)};O.prototype.copy=function(t){return this.mins.copy(t.mins),this.maxs.copy(t.maxs),this};O.prototype.clear=function(){return this.mins.set(1/0,1/0),this.maxs.set(-1/0,-1/0),this};O.prototype.isEmpty=function(){if(this.mins.x===-1/0||this.maxs.x===1/0||this.mins.y===-1/0||this.maxs.y===1/0||this.mins.x>this.maxs.x||this.mins.y>this.maxs.y)return!0};O.prototype.getCenter=function(){return r.scale(r.add(this.mins,this.maxs),.5)};O.prototype.getExtent=function(){return r.scale(r.sub(this.maxs,this.mins),.5)};O.prototype.getPerimeter=function(){return(maxs.x-mins.x+maxs.y-mins.y)*2};O.prototype.addPoint=function(t){return this.mins.x>t.x&&(this.mins.x=t.x),this.maxs.x<t.x&&(this.maxs.x=t.x),this.mins.y>t.y&&(this.mins.y=t.y),this.maxs.y<t.y&&(this.maxs.y=t.y),this};O.prototype.addBounds=function(t){return this.mins.x>t.mins.x&&(this.mins.x=t.mins.x),this.maxs.x<t.maxs.x&&(this.maxs.x=t.maxs.x),this.mins.y>t.mins.y&&(this.mins.y=t.mins.y),this.maxs.y<t.maxs.y&&(this.maxs.y=t.maxs.y),this};O.prototype.addBounds2=function(t,i){return this.mins.x>t.x&&(this.mins.x=t.x),this.maxs.x<i.x&&(this.maxs.x=i.x),this.mins.y>t.y&&(this.mins.y=t.y),this.maxs.y<i.y&&(this.maxs.y=i.y),this};O.prototype.addExtents=function(t,i,s){return this.mins.x>t.x-i&&(this.mins.x=t.x-i),this.maxs.x<t.x+i&&(this.maxs.x=t.x+i),this.mins.y>t.y-s&&(this.mins.y=t.y-s),this.maxs.y<t.y+s&&(this.maxs.y=t.y+s),this};O.prototype.expand=function(t,i){return this.mins.x-=t,this.mins.y-=i,this.maxs.x+=t,this.maxs.y+=i,this};O.prototype.containPoint=function(t){return!(t.x<this.mins.x||t.x>this.maxs.x||t.y<this.mins.y||t.y>this.maxs.y)};O.prototype.intersectsBounds=function(t){return!(this.mins.x>t.maxs.x||this.maxs.x<t.mins.x||this.mins.y>t.maxs.y||this.maxs.y<t.mins.y)};O.expand=function(e,i,s){var e=new O(e.mins,e.maxs);return e.expand(i,s),e};var L=function(t){arguments.length!=0&&(L.id_counter==null&&(L.id_counter=0),this.id=L.id_counter++,this.type=t,this.e=0,this.u=1,this.density=1,this.bounds=new O)};L.TYPE_CIRCLE=0;L.TYPE_SEGMENT=1;L.TYPE_POLY=2;L.NUM_TYPES=3;L.prototype.translateTo=function(t){switch(console.warn("Unimplemented"),this.type){case L.TYPE_CIRCLE:console.warn("Shape.TYPE_CIRCLE.translateTo: TODO tests",t),this.c.copy(this.body.getLocalPoint(t));break;case L.TYPE_SEGMENT:console.warn("Shape.TYPE_SEGMENT.translateTo: TODO tests",t);var e=r.sub(t,this.centroid()),i=r.add(this.ta,e),s=r.add(this.ta,e);this.a.copy(this.body.getLocalPoint(i)),this.b.copy(this.body.getLocalPoint(s));break;case L.TYPE_POLY:for(var e=r.sub(t,this.centroid()),o=0;o<this.tverts.length;o++){var h=r.add(this.tverts[o],e);this.verts[o].copy(this.body.getLocalPoint(h))}break}this.finishVerts(),this.body.resetMassData(),this.body.awake(!0),this.body.cacheData()};L.prototype.translateWithDelta=function(t){switch(console.warn("Unimplemented"),this.type){case L.TYPE_CIRCLE:var i=r.add(this.tc,t);this.c.copy(this.body.getLocalPoint(i));break;case L.TYPE_SEGMENT:var s=r.add(this.ta,t),e=r.add(this.ta,t);this.a.copy(this.body.getLocalPoint(s)),this.b.copy(this.body.getLocalPoint(e));break;case L.TYPE_POLY:for(var o=this.body.p,h=this.body.a,n=0;n<this.tverts.length;n++){var a=r.add(this.tverts[n],t);this.verts[n].copy(this.body.getLocalPoint(a))}break}this.finishVerts(),this.body.resetMassData(),this.body.awake(!0),this.body.cacheData()};var ut={};(function(){var t=[];function i(v,d,l){t[v*L.NUM_TYPES+d]=l}function s(v,d,l,_,b){var x=d+_,w=r.sub(l,v),g=w.lengthsq();if(g>x*x)return 0;var P=Math.sqrt(g),C=r.mad(v,w,.5+(d-_)*.5/P),N=P!=0?r.scale(w,1/P):r.zero,st=P-x;return b.push(new ot(C,N,st,0)),1}function e(v,d,l){return s(v.tc,v.r,d.tc,d.r,l)}function o(v,d,l){var _=v.r+d.r,b=r.dot(v.tc,d.tn)-r.dot(d.ta,d.tn),x=(b<0?b*-1:b)-_;if(x>0)return 0;var w=r.cross(v.tc,d.tn),g=r.cross(d.ta,d.tn),P=r.cross(d.tb,d.tn);if(w<g)return w<g-_?0:s(v.tc,v.r,d.ta,d.r,l);if(w>P)return w>P+_?0:s(v.tc,v.r,d.tb,d.r,l);var C=b>0?d.tn:r.neg(d.tn);return l.push(new ot(r.mad(v.tc,C,-(v.r+x*.5)),r.neg(C),x,0)),1}function h(v,d,l){for(var _=-999999,b=-1,x=0;x<d.verts.length;x++){var w=d.tplanes[x],g=r.dot(v.tc,w.n)-w.d-v.r;if(g>0)return 0;g>_&&(_=g,b=x)}var P=d.tplanes[b].n,C=d.tverts[b],N=d.tverts[(b+1)%d.verts.length],st=r.cross(C,P),ct=r.cross(N,P),A=r.cross(v.tc,P);return A>st?s(v.tc,v.r,C,0,l):A<ct?s(v.tc,v.r,N,0,l):(l.push(new ot(r.mad(v.tc,P,-(v.r+_*.5)),r.neg(P),_,0)),1)}function n(v,d){var l=r.sub(d,v.ta),_=r.sub(v.tb,v.ta),b=l.dot(_);if(b<=0)return l.dot(l);var x=_.dot(_);return b>=x?l.dot(l)-2*b+x:l.dot(l)-b*b/x}function a(v,d,l){var _=[];_[0]=n(v,d.ta),_[1]=n(v,d.tb),_[2]=n(d,v.ta),_[3]=n(d,v.tb);var b=_[0]<_[1]?0:1,x=_[2]<_[3]?2:3,w=_[b]<_[x]?b:x,g,P,C=r.sub(v.tb,v.ta),N=r.sub(d.tb,d.ta);switch(w){case 0:g=r.dot(r.sub(d.ta,v.ta),C)/r.dot(C,C),g=g<0?0:g>1?1:g,P=0;break;case 1:g=r.dot(r.sub(d.tb,v.ta),C)/r.dot(C,C),g=g<0?0:g>1?1:g,P=1;break;case 2:g=0,P=r.dot(r.sub(v.ta,d.ta),N)/r.dot(N,N),P=P<0?0:P>1?1:P;break;case 3:g=1,P=r.dot(r.sub(v.tb,d.ta),N)/r.dot(N,N),P=P<0?0:P>1?1:P;break}var st=r.mad(v.ta,C,g),ct=r.mad(d.ta,N,P);return s(st,v.r,ct,d.r,l)}function u(v,d,l,_,b){for(var x=r.cross(d.tn,d.ta),w=r.cross(d.tn,d.tb),g=r.scale(d.tn,b),P=0;P<l.verts.length;P++){var C=l.tverts[P];if(r.dot(C,g)<r.dot(d.tn,d.ta)*b+d.r){var N=r.cross(d.tn,C);x>=N&&N>=w&&v.push(new ot(C,g,_,l.id<<16|P))}}}function c(v,d,l){var _=r.dot(v.tn,v.ta),b=d.distanceOnPlane(v.tn,_)-v.r;if(b>0)return 0;var x=d.distanceOnPlane(r.neg(v.tn),-_)-v.r;if(x>0)return 0;for(var w=-999999,g=-1,P=0;P<d.verts.length;P++){var C=d.tplanes[P],N=v.distanceOnPlane(C.n,C.d);if(N>0)return 0;N>w&&(w=N,g=P)}var st=r.neg(d.tplanes[g].n),ct=r.mad(v.ta,st,v.r),A=r.mad(v.tb,st,v.r);if(d.containPoint(ct)&&l.push(new ot(ct,st,w,v.id<<16|0)),d.containPoint(A)&&l.push(new ot(A,st,w,v.id<<16|1)),w-=.1,(b>=w||x>=w)&&(b>x?u(l,v,d,b,1):u(l,v,d,x,-1)),l.length==0){var S=d.tverts[g],k=d.tverts[(g+1)%d.verts.length];if(s(v.ta,v.r,S,0,l)||s(v.tb,v.r,S,0,l)||s(v.ta,v.r,k,0,l)||s(v.tb,v.r,k,0,l))return 1}return l.length}function m(v,d,l){for(var _=-999999,b=-1,x=0;x<l;x++){var w=v.distanceOnPlane(d[x].n,d[x].d);if(w>0)return{dist:0,index:-1};w>_&&(_=w,b=x)}return{dist:_,index:b}}function y(v,d,l,_,b){for(var x=0,w=0;w<d.verts.length;w++){var g=d.tverts[w];l.containPointPartial(g,_)&&(v.push(new ot(g,_,b,d.id<<16|w)),x++)}for(var w=0;w<l.verts.length;w++){var g=l.tverts[w];d.containPointPartial(g,_)&&(v.push(new ot(g,_,b,l.id<<16|w)),x++)}return x}function f(v,d,l,_,b){for(var x=0,w=0;w<d.verts.length;w++){var g=d.tverts[w];l.containPoint(g)&&(v.push(new ot(g,_,b,d.id<<16|w)),x++)}for(var w=0;w<l.verts.length;w++){var g=l.tverts[w];d.containPoint(g)&&(v.push(new ot(g,_,b,l.id<<16|w)),x++)}return x>0?x:y(v,d,l,_,b)}function T(v,d,l){var _=m(d,v.tplanes,v.verts.length);if(_.index==-1)return 0;var b=m(v,d.tplanes,d.verts.length);return b.index==-1?0:_.dist>b.dist?f(l,v,d,v.tplanes[_.index].n,_.dist):f(l,v,d,r.neg(d.tplanes[b.index].n),b.dist)}ut.init=function(){i(L.TYPE_CIRCLE,L.TYPE_CIRCLE,e),i(L.TYPE_CIRCLE,L.TYPE_SEGMENT,o),i(L.TYPE_CIRCLE,L.TYPE_POLY,h),i(L.TYPE_SEGMENT,L.TYPE_SEGMENT,a),i(L.TYPE_SEGMENT,L.TYPE_POLY,c),i(L.TYPE_POLY,L.TYPE_POLY,T)},ut.collide=function(v,d,l){if(v.type>d.type){var _=v;v=d,d=_}return t[v.type*L.NUM_TYPES+d.type](v,d,l)}})();function bt(t,i){return Math.PI*(t*t-i*i)}function xt(t,i,s,e){return t*((s*s+e*e)*.5+i.lengthsq())}function wt(t,i,s){return s*(Math.PI*s+2*r.dist(t,i))}function At(t,i){return r.scale(r.add(t,i),.5)}function gt(t,i,s){var e=r.distsq(s,i),o=r.scale(r.add(i,s),.5);return t*(e/12+o.lengthsq())}function Et(t){for(var i=0,s=0;s<t.length;s++)i+=r.cross(t[s],t[(s+1)%t.length]);return i/2}function Tt(t){for(var i=0,s=new r(0,0),e=0;e<t.length;e++){var o=t[e],h=t[(e+1)%t.length],n=r.cross(o,h);i+=n,s.addself(r.scale(r.add(o,h),n))}return r.scale(s,1/(3*i))}function Lt(t,i,s){for(var e=0,o=0,h=0;h<i.length;h++){var n=r.add(i[h],s),a=r.add(i[(h+1)%i.length],s),u=r.cross(a,n),c=r.dot(n,n)+r.dot(n,a)+r.dot(a,a);e+=u*c,o+=u}return t*e/(6*o)}function Pt(){return!!navigator.userAgent.match(/iPhone|iPod|iPad/gi)}var F=function(t,i,s){L.call(this,L.TYPE_CIRCLE),this.c=new r(t||0,i||0),this.r=s,this.tc=r.zero,this.finishVerts()};F.prototype=new L;F.prototype.constructor=F;F.prototype.finishVerts=function(){this.r=Math.abs(this.r)};F.prototype.duplicate=function(){return new F(this.c.x,this.c.y,this.r)};F.prototype.serialize=function(){return{type:"ShapeCircle",e:this.e,u:this.u,density:this.density,center:this.c,radius:this.r}};F.prototype.recenter=function(t){this.c.subself(t)};F.prototype.transform=function(t){this.c=t.transform(this.c)};F.prototype.untransform=function(t){this.c=t.untransform(this.c)};F.prototype.area=function(){return bt(this.r,0)};F.prototype.centroid=function(){return this.c.duplicate()};F.prototype.inertia=function(t){return xt(t,this.c,this.r,0)};F.prototype.cacheData=function(t){this.tc=t.transform(this.c),this.bounds.mins.set(this.tc.x-this.r,this.tc.y-this.r),this.bounds.maxs.set(this.tc.x+this.r,this.tc.y+this.r)};F.prototype.pointQuery=function(t){return r.distsq(this.tc,t)<this.r*this.r};F.prototype.findVertexByPoint=function(t,i){var s=i*i;return r.distsq(this.tc,t)<s?0:-1};F.prototype.distanceOnPlane=function(t,i){return r.dot(t,this.tc)-this.r-i};var B=function(t,i,s){L.call(this,L.TYPE_SEGMENT),this.a=t.duplicate(),this.b=i.duplicate(),this.r=s,this.n=r.perp(r.sub(i,t)),this.n.normalize(),this.ta=r.zero,this.tb=r.zero,this.tn=r.zero,this.finishVerts()};B.prototype=new L;B.prototype.constructor=B;B.prototype.finishVerts=function(){this.n=r.perp(r.sub(this.b,this.a)),this.n.normalize(),this.r=Math.abs(this.r)};B.prototype.duplicate=function(){return new B(this.a,this.b,this.r)};B.prototype.serialize=function(){return{type:"ShapeSegment",e:this.e,u:this.u,density:this.density,a:this.a,b:this.b,radius:this.r}};B.prototype.recenter=function(t){this.a.subself(t),this.b.subself(t)};B.prototype.transform=function(t){this.a=t.transform(this.a),this.b=t.transform(this.b)};B.prototype.untransform=function(t){this.a=t.untransform(this.a),this.b=t.untransform(this.b)};B.prototype.area=function(){return wt(this.a,this.b,this.r)};B.prototype.centroid=function(){return At(this.a,this.b)};B.prototype.inertia=function(t){return gt(t,this.a,this.b)};B.prototype.cacheData=function(t){if(this.ta=t.transform(this.a),this.tb=t.transform(this.b),this.tn=r.perp(r.sub(this.tb,this.ta)).normalize(),this.ta.x<this.tb.x)var i=this.ta.x,s=this.tb.x;else var i=this.tb.x,s=this.ta.x;if(this.ta.y<this.tb.y)var e=this.ta.y,o=this.tb.y;else var e=this.tb.y,o=this.ta.y;this.bounds.mins.set(i-this.r,e-this.r),this.bounds.maxs.set(s+this.r,o+this.r)};B.prototype.pointQuery=function(t){if(!this.bounds.containPoint(t))return!1;var i=r.dot(this.tn,t)-r.dot(this.ta,this.tn),s=Math.abs(i);if(s>this.r)return!1;var e=r.cross(t,this.tn),o=r.cross(this.ta,this.tn),h=r.cross(this.tb,this.tn);return e<=o?e<o-this.r?!1:r.distsq(this.ta,t)<this.r*this.r:e>h?e>h+this.r?!1:r.distsq(this.tb,t)<this.r*this.r:!0};B.prototype.findVertexByPoint=function(t,i){var s=i*i;return r.distsq(this.ta,t)<s?0:r.distsq(this.tb,t)<s?1:-1};B.prototype.distanceOnPlane=function(t,i){var s=r.dot(t,this.ta)-this.r,e=r.dot(t,this.tb)-this.r;return Math.min(s,e)-i};var z=function(t){if(L.call(this,L.TYPE_POLY),this.verts=[],this.planes=[],this.tverts=[],this.tplanes=[],t)for(var i=0;i<t.length;i++)this.verts[i]=t[i].duplicate(),this.tverts[i]=this.verts[i],this.tplanes[i]={},this.tplanes[i].n=r.zero,this.tplanes[i].d=0;this.finishVerts()};z.prototype=new L;z.prototype.constructor=z;z.prototype.finishVerts=function(){if(this.verts.length<2){this.convexity=!1,this.planes=[];return}this.convexity=!0,this.tverts=[],this.tplanes=[];for(var t=0;t<this.verts.length;t++){var i=this.verts[t],s=this.verts[(t+1)%this.verts.length],e=r.normalize(r.perp(r.sub(i,s)));this.planes[t]={},this.planes[t].n=e,this.planes[t].d=r.dot(e,i),this.tverts[t]=this.verts[t],this.tplanes[t]={},this.tplanes[t].n=r.zero,this.tplanes[t].d=0}for(var t=0;t<this.verts.length;t++){var s=this.verts[(t+2)%this.verts.length],e=this.planes[t].n,o=this.planes[t].d;r.dot(e,s)-o>0&&(this.convexity=!1)}};z.prototype.duplicate=function(){return new z(this.verts)};z.prototype.serialize=function(){return{type:"ShapePoly",e:this.e,u:this.u,density:this.density,verts:this.verts}};z.prototype.recenter=function(t){for(var i=0;i<this.verts.length;i++)this.verts[i].subself(t)};z.prototype.transform=function(t){for(var i=0;i<this.verts.length;i++)this.verts[i]=t.transform(this.verts[i])};z.prototype.untransform=function(t){for(var i=0;i<this.verts.length;i++)this.verts[i]=t.untransform(this.verts[i])};z.prototype.area=function(){return Et(this.verts)};z.prototype.centroid=function(){return Tt(this.verts)};z.prototype.inertia=function(t){return Lt(t,this.verts,r.zero)};z.prototype.cacheData=function(t){this.bounds.clear();var i=this.verts.length;if(i!=0){for(var s=0;s<i;s++)this.tverts[s]=t.transform(this.verts[s]);if(i<2){this.bounds.addPoint(this.tverts[0]);return}for(var s=0;s<i;s++){var e=this.tverts[s],o=this.tverts[(s+1)%i],h=r.normalize(r.perp(r.sub(e,o)));this.tplanes[s].n=h,this.tplanes[s].d=r.dot(h,e),this.bounds.addPoint(e)}}};z.prototype.pointQuery=function(t){return this.bounds.containPoint(t)?this.containPoint(t):!1};z.prototype.findVertexByPoint=function(t,i){for(var s=i*i,e=0;e<this.tverts.length;e++)if(r.distsq(this.tverts[e],t)<s)return e;return-1};z.prototype.findEdgeByPoint=function(t,i){for(var s=i*i,e=this.tverts.length,o=0;o<this.tverts.length;o++){var h=this.tverts[o],n=this.tverts[(o+1)%e],a=this.tplanes[o].n,u=r.cross(h,a),c=r.cross(n,a),m=r.cross(t,a);if(m>u){if(r.distsq(h,t)<s)return o}else if(m<c){if(r.distsq(n,t)<s)return o}else{var y=r.dot(a,t)-r.dot(a,h);if(y*y<s)return o}}return-1};z.prototype.distanceOnPlane=function(t,i){for(var s=999999,e=0;e<this.verts.length;e++)s=Math.min(s,r.dot(t,this.tverts[e]));return s-i};z.prototype.containPoint=function(t){for(var i=0;i<this.verts.length;i++){var s=this.tplanes[i];if(r.dot(s.n,t)-s.d>0)return!1}return!0};z.prototype.containPointPartial=function(t,i){for(var s=0;s<this.verts.length;s++){var e=this.tplanes[s];if(!(r.dot(e.n,i)<1e-4)&&r.dot(e.n,t)-e.d>0)return!1}return!0};var St=function(t,i,s){var e=[new r(t.x,t.y),new r(i.x,i.y),new r(s.x,s.y)];return new z(e)},Mt=function(t,i,s,e){t=t||0,i=i||0;var o=s*.5,h=e*.5,n=[new r(-o+t,+h+i),new r(-o+t,-h+i),new r(+o+t,-h+i),new r(+o+t,+h+i)];return new z(n)};var E=function(t,i,s){E.id_counter==null&&(E.id_counter=0),this.id=E.id_counter++,this.name="body"+this.id,this.type=t,i=i||new r(0,0),s=s||0,this.xf=new at(i,s),this.centroid=new r(0,0),this.p=new r(i.x,i.y),this.v=new r(0,0),this.f=new r(0,0),this.a=s,this.w=0,this.t=0,this.linearDamping=0,this.angularDamping=0,this.sleepTime=0,this.awaked=!1,this.shapeArr=[],this.jointArr=[],this.jointHash={},this.bounds=new O,this.fixedRotation=!1,this.categoryBits=1,this.maskBits=65535,this.stepCount=0};E.STATIC=0;E.KINETIC=1;E.DYNAMIC=2;E.prototype.duplicate=function(){for(var t=new E(this.type,this.xf.t,this.a),i=0;i<this.shapeArr.length;i++)t.addShape(this.shapeArr[i].duplicate());return t.resetMassData(),t};E.prototype.serialize=function(){for(var t=[],i=0;i<this.shapeArr.length;i++)t.push(this.shapeArr[i].serialize());return{type:["static","kinetic","dynamic"][this.type],name:this.name,position:this.xf.t,angle:this.xf.a,shapes:t}};E.prototype.isStatic=function(){return this.type==E.STATIC};E.prototype.isDynamic=function(){return this.type==E.DYNAMIC};E.prototype.isKinetic=function(){return this.type==E.KINETIC};E.prototype.setType=function(t){t!=this.type&&(this.f.set(0,0),this.v.set(0,0),this.t=0,this.w=0,this.type=t,this.awake(!0))};E.prototype.addShape=function(t){t.body=this,this.shapeArr.push(t),this.awake(!0),this.cacheData()};E.prototype.removeShape=function(t){var i=this.shapeArr.indexOf(t);i!=-1&&(this.shapeArr.splice(i,1),t.body=void 0,this.awake(!0),this.cacheData())};E.prototype.setMass=function(t){this.m=t,this.m_inv=t>0?1/t:0};E.prototype.setInertia=function(t){this.i=t,this.i_inv=t>0?1/t:0};E.prototype.setTransform=function(t,i){this.xf.set(t,i),this.p=this.xf.transform(this.centroid),this.a=i};E.prototype.syncTransform=function(){this.xf.setRotation(this.a),this.xf.setPosition(r.sub(this.p,this.xf.rotate(this.centroid)))};E.prototype.getWorldPoint=function(t){return this.xf.transform(t)};E.prototype.getWorldVector=function(t){return this.xf.rotate(t)};E.prototype.getLocalPoint=function(t){return this.xf.untransform(t)};E.prototype.getLocalVector=function(t){return this.xf.unrotate(t)};E.prototype.setFixedRotation=function(t){this.fixedRotation=t,this.resetMassData()};E.prototype.resetMassData=function(){if(this.centroid.set(0,0),this.m=0,this.m_inv=0,this.i=0,this.i_inv=0,!this.isDynamic()){this.p=this.xf.transform(this.centroid);return}for(var t=new r(0,0),i=0,s=0,e=0;e<this.shapeArr.length;e++){var o=this.shapeArr[e],h=o.centroid(),n=o.area()*o.density,a=o.inertia(n);t.mad(h,n),i+=n,s+=a}this.centroid.copy(r.scale(t,1/i)),this.setMass(i),this.fixedRotation||this.setInertia(s-i*r.dot(this.centroid,this.centroid));var u=this.p;this.p=this.xf.transform(this.centroid),this.v.mad(r.perp(r.sub(this.p,u)),this.w)};E.prototype.resetJointAnchors=function(){for(var t=0;t<this.jointArr.length;t++){var i=this.jointArr[t];if(i){var s=i.getWorldAnchor1(),e=i.getWorldAnchor2();i.setWorldAnchor1(s),i.setWorldAnchor2(e)}}};E.prototype.cacheData=function(){this.bounds.clear();for(var t=0;t<this.shapeArr.length;t++){var i=this.shapeArr[t];i.cacheData(this.xf),this.bounds.addBounds(i.bounds)}};E.prototype.updateVelocity=function(t,i,s){this.v=r.mad(this.v,r.mad(t,this.f,this.m_inv),i),this.w=this.w+this.t*this.i_inv*i,this.v.scale(q(1-i*(s+this.linearDamping),0,1)),this.w*=q(1-i*(s+this.angularDamping),0,1),this.f.set(0,0),this.t=0};E.prototype.updatePosition=function(t){this.p.addself(r.scale(this.v,t)),this.a+=this.w*t};E.prototype.resetForce=function(){this.f.set(0,0),this.t=0};E.prototype.applyForce=function(t,i){this.isDynamic()&&(this.isAwake()||this.awake(!0),this.f.addself(t),this.t+=r.cross(r.sub(i,this.p),t))};E.prototype.applyForceToCenter=function(t){this.isDynamic()&&(this.isAwake()||this.awake(!0),this.f.addself(t))};E.prototype.applyTorque=function(t){this.isDynamic()&&(this.isAwake()||this.awake(!0),this.t+=t)};E.prototype.applyLinearImpulse=function(t,i){this.isDynamic()&&(this.isAwake()||this.awake(!0),this.v.mad(t,this.m_inv),this.w+=r.cross(r.sub(i,this.p),t)*this.i_inv)};E.prototype.applyAngularImpulse=function(t){this.isDynamic()&&(this.isAwake()||this.awake(!0),this.w+=t*this.i_inv)};E.prototype.kineticEnergy=function(){var t=this.v.dot(this.v),i=this.w*this.w;return .5*(this.m*t+this.i*i)};E.prototype.isAwake=function(){return this.awaked};E.prototype.awake=function(t){this.awaked=t,t?this.sleepTime=0:(this.v.set(0,0),this.w=0,this.f.set(0,0),this.t=0)};E.prototype.isCollidable=function(t){if(this==t||!this.isDynamic()&&!t.isDynamic()||!(this.maskBits&t.categoryBits)||!(t.maskBits&this.categoryBits))return!1;for(var i=0;i<this.jointArr.length;i++){var s=this.jointArr[i];if(s&&!s.collideConnected&&t.jointHash[s.id]!=null)return!1}return!0};E.prototype.translateWithDelta=function(t){var i=this.xf.t.duplicate();i.x+=t.x,i.y+=t.y,this.setTransform(i,this.a),this.resetJointAnchors(),this.awake(!0),this.cacheData()};var p=function(t,i,s,e){arguments.length!=0&&(p.id_counter==null&&(p.id_counter=0),this.id=p.id_counter++,this.type=t,this.body1=i,this.body2=s,this.collideConnected=e,this.maxForce=9999999999,this.breakable=!1)};p.TYPE_ANGLE=p.prototype.TYPE_ANGLE=0;p.TYPE_REVOLUTE=p.prototype.TYPE_REVOLUTE=1;p.TYPE_WELD=p.prototype.TYPE_WELD=2;p.TYPE_WHEEL=p.prototype.TYPE_WHEEL=3;p.TYPE_PRISMATIC=p.prototype.TYPE_PRISMATIC=4;p.TYPE_DISTANCE=p.prototype.TYPE_DISTANCE=5;p.TYPE_ROPE=p.prototype.TYPE_ROPE=6;p.TYPE_MOUSE=p.prototype.TYPE_MOUSE=7;p.LINEAR_SLOP=8e-4;p.ANGULAR_SLOP=vt(2);p.MAX_LINEAR_CORRECTION=.5;p.MAX_ANGULAR_CORRECTION=vt(8);p.LIMIT_STATE_INACTIVE=0;p.LIMIT_STATE_AT_LOWER=1;p.LIMIT_STATE_AT_UPPER=2;p.LIMIT_STATE_EQUAL_LIMITS=3;p.prototype.getWorldAnchor1=function(){return this.body1.getWorldPoint(this.anchor1)};p.prototype.getWorldAnchor2=function(){return this.body2.getWorldPoint(this.anchor2)};p.prototype.setWorldAnchor1=function(t){this.anchor1=this.body1.getLocalPoint(t)};p.prototype.setWorldAnchor2=function(t){this.anchor2=this.body2.getLocalPoint(t)};function $(t,i){this.shape1=t,this.shape2=i,this.contactArr=[],this.e=1,this.u=1}$.COLLISION_SLOP=8e-4;$.BAUMGARTE=.28;$.MAX_LINEAR_CORRECTION=1;$.prototype.update=function(t){for(var i=0;i<t.length;i++){for(var s=t[i],e=-1,o=0;o<this.contactArr.length;o++)if(s.hash==this.contactArr[o].hash){e=o;break}e>-1&&(s.lambda_n_acc=this.contactArr[e].lambda_n_acc,s.lambda_t_acc=this.contactArr[e].lambda_t_acc)}this.contactArr=t};$.prototype.initSolver=function(t){for(var i=this.shape1.body,s=this.shape2.body,e=i.m_inv+s.m_inv,o=0;o<this.contactArr.length;o++){var h=this.contactArr[o];h.r1=r.sub(h.p,i.p),h.r2=r.sub(h.p,s.p),h.r1_local=i.xf.unrotate(h.r1),h.r2_local=s.xf.unrotate(h.r2);var n=h.n,a=r.perp(h.n),u=r.cross(h.r1,n),c=r.cross(h.r2,n),m=e+i.i_inv*u*u+s.i_inv*c*c;h.emn=m==0?0:1/m;var y=r.cross(h.r1,a),f=r.cross(h.r2,a),T=e+i.i_inv*y*y+s.i_inv*f*f;h.emt=T==0?0:1/T;var v=r.mad(i.v,r.perp(h.r1),i.w),d=r.mad(s.v,r.perp(h.r2),s.w),l=r.sub(d,v);h.bounce=r.dot(l,h.n)*this.e}};$.prototype.warmStart=function(){for(var t=this.shape1.body,i=this.shape2.body,s=0;s<this.contactArr.length;s++){var e=this.contactArr[s],o=e.n,h=e.lambda_n_acc,n=e.lambda_t_acc,a=new r(h*o.x-n*o.y,n*o.x+h*o.y);t.v.mad(a,-t.m_inv),t.w-=r.cross(e.r1,a)*t.i_inv,i.v.mad(a,i.m_inv),i.w+=r.cross(e.r2,a)*i.i_inv}};$.prototype.solveVelocityConstraints=function(){for(var t=this.shape1.body,i=this.shape2.body,s=t.m_inv,e=t.i_inv,o=i.m_inv,h=i.i_inv,n=0;n<this.contactArr.length;n++){var a=this.contactArr[n],u=a.n,c=r.perp(u),m=a.r1,y=a.r2,f=r.mad(t.v,r.perp(m),t.w),T=r.mad(i.v,r.perp(y),i.w),v=r.sub(T,f),d=-a.emn*(r.dot(u,v)+a.bounce),l=a.lambda_n_acc;a.lambda_n_acc=Math.max(l+d,0),d=a.lambda_n_acc-l;var _=-a.emt*r.dot(c,v),b=a.lambda_n_acc*this.u,x=a.lambda_t_acc;a.lambda_t_acc=q(x+_,-b,b),_=a.lambda_t_acc-x;var w=new r(d*u.x-_*u.y,_*u.x+d*u.y);t.v.mad(w,-s),t.w-=r.cross(m,w)*e,i.v.mad(w,o),i.w+=r.cross(y,w)*h}};$.prototype.solvePositionConstraints=function(){for(var t=this.shape1.body,i=this.shape2.body,s=t.m_inv,e=t.i_inv,o=i.m_inv,h=i.i_inv,n=s+o,a=0,u=0;u<this.contactArr.length;u++){var c=this.contactArr[u],m=c.n,y=r.rotate(c.r1_local,t.a),f=r.rotate(c.r2_local,i.a),T=r.add(t.p,y),v=r.add(i.p,f),d=r.sub(v,T),l=r.dot(d,m)+c.d,_=q($.BAUMGARTE*(l+$.COLLISION_SLOP),-$.MAX_LINEAR_CORRECTION,0);if(_!=0){a=Math.max(a,-l);var b=r.cross(y,m),x=r.cross(f,m),w=n+t.i_inv*b*b+i.i_inv*x*x,g=w==0?0:-_/w,P=r.scale(m,g);t.p.mad(P,-s),t.a-=b*g*e,i.p.mad(P,o),i.a+=x*g*h}}return a<=$.COLLISION_SLOP*3};var V={};function I(t){this.renderer=t,this.bodyArr=[],this.jointArr=[],this.jointHash={},this.numContacts=0,this.contactSolverArr=[],this.postSolve=function(i){},this.gravity=new r(0,0),this.damping=0}I.TIME_TO_SLEEP=.5;I.SLEEP_LINEAR_TOLERANCE=.5;I.SLEEP_ANGULAR_TOLERANCE=vt(2);I.prototype.clear=function(){for(L.id_counter=0,E.id_counter=0,p.id_counter=0;this.jointArr.length;)this.removeJoint(this.jointArr[this.jointArr.length-1]);for(;this.bodyArr.length;)this.removeBody(this.bodyArr[this.bodyArr.length-1]);this.bodyArr=[],this.jointArr=[],this.jointHash={},this.contactSolverArr=[],this.stepCount=0};I.prototype.toJSON=function(t){for(var i=[],s=0;s<this.bodyArr.length;s++)this.bodyArr[s]&&i.push(this.bodyArr[s].serialize());for(var e=[],s=0;s<this.jointArr.length;s++)this.jointArr[s]&&e.push(this.jointHash[s].serialize());return{bodies:i,joints:e}};I.prototype.create=function(t){var i=JSON.parse(t);this.clear();for(var s=0;s<i.bodies.length;s++){for(var e=i.bodies[s],o={static:E.STATIC,kinetic:E.KINETIC,dynamic:E.DYNAMIC}[e.type],h=new E(o,e.position.x,e.position.y,e.angle),n=0;n<e.shapes.length;n++){var a=e.shapes[n],u;switch(a.type){case"ShapeCircle":u=new F(a.center.x,a.center.y,a.radius);break;case"ShapeSegment":u=new B(a.a,a.b,a.radius);break;case"ShapePoly":u=new z(a.verts);break}u.e=a.e,u.u=a.u,u.density=a.density,h.addShape(u)}h.resetMassData(),this.addBody(h)}for(var s=0;s<i.joints.length;s++){var c=i.joints[s],m=this.bodyArr.find(v=>v.id===c.body1.id),y=this.bodyArr.find(v=>v.id===c.body2.id),f;switch(c.type){case"AngleJoint":f=new AngleJoint(m,y);break;case"RevoluteJoint":f=new RevoluteJoint(m,y,c.anchor),f.enableLimit(c.limitEnabled),f.setLimits(c.limitLowerAngle,c.limitUpperAngle),f.enableMotor(c.motorEnabled),f.setMotorSpeed(c.motorSpeed),f.setMaxMotorTorque(c.maxMotorTorque);break;case"WeldJoint":f=new WeldJoint(m,y,c.anchor),f.setSpringFrequencyHz(c.frequencyHz),f.setSpringDampingRatio(c.dampingRatio);break;case"WheelJoint":f=new WheelJoint(m,y,c.anchor1,c.anchor2),f.enableMotor(c.motorEnabled),f.setMotorSpeed(c.motorSpeed),f.setMaxMotorTorque(c.maxMotorTorque);break;case"PrismaticJoint":f=new PrismaticJoint(m,y,c.anchor1,c.anchor2);break;case"DistanceJoint":f=new DistanceJoint(m,y,c.anchor1,c.anchor2),f.setSpringFrequencyHz(c.frequencyHz),f.setSpringDampingRatio(c.dampingRatio);break;case"RopeJoint":f=new RopeJoint(m,y,c.anchor1,c.anchor2);break}f.collideConnected=c.collideConnected,f.maxForce=c.maxForce,f.breakable=c.breakable,this.addJoint(f)}};I.prototype.addBody=function(t){var i;this.bodyArr.find(s=>s.id===t.id)||(this.bodyArr.push(t),(i=this.renderer)==null||i.addBody(t),t.awake(!0),t.world=this,t.cacheData())};I.prototype.removeBody=function(t){var e;var i=this.bodyArr.findIndex(o=>o.id===t.id);if(i!==-1){(e=this.renderer)==null||e.removeBody(t);for(var s=0;s<t.jointArr.length;s++)this.removeJoint(t.jointArr[s]);t.world=null,this.bodyArr.splice(i,1)}};I.prototype.addJoint=function(t){this.jointHash[t.id]==null&&(this.jointHash[t.id]=t,t.body1.jointHash[t.id]=t,t.body2.jointHash[t.id]=t,this.jointArr.push(t),t.body1.jointArr.push(t),t.body2.jointArr.push(t),t.body1.awake(!0),t.body2.awake(!0),this.renderer.addJoint(t))};I.prototype.removeJoint=function(t){if(this.jointHash[t.id]!=null){delete this.jointHash[t.id],delete t.body1.jointHash[t.id],delete t.body2.jointHash[t.id];var i=this.jointArr.findIndex(s=>s.id===t.id);this.jointArr.splice(i,1);var i=t.body1.jointArr.findIndex(s=>s.id===t.id);t.body1.jointArr.splice(i,1);var i=t.body2.jointArr.findIndex(s=>s.id===t.id);t.body2.jointArr.splice(i,1),t.body1.awake(!0),t.body2.awake(!0),this.renderer.removeJoint(t)}};I.prototype.findShapeByPoint=function(t,i){for(var s,e=0;e<this.bodyArr.length;e++){var o=this.bodyArr[e];if(o)for(var h=0;h<o.shapeArr.length;h++){var n=o.shapeArr[h];if(n.pointQuery(t)){if(!i)return n;s||(s=n),n==i&&(i=null)}}}return s};I.prototype.findBodyByPoint=function(t,i){for(var s,e=0;e<this.bodyArr.length;e++){var o=this.bodyArr[e];if(o)for(var h=0;h<o.shapeArr.length;h++){var n=o.shapeArr[h];if(n.pointQuery(t)){if(!i)return n.body;s||(s=n.body),n.body==i&&(i=null);break}}}return s};I.prototype.shapeById=function(t){for(var i,s=0;s<this.bodyArr.length;s++){var e=this.bodyArr[s];if(e){for(var o=0;o<e.shapeArr.length;o++)if(e.shapeArr[o].id==t)return e.shapeArr[o]}}return null};I.prototype.jointById=function(t){var i=this.jointHash[t];return i!=null?this.jointArr[i]:null};I.prototype.findVertexByPoint=function(t,i,s){var e=-1;s=s||-1;for(var o=0;o<this.bodyArr.length;o++){var h=this.bodyArr[o];if(h)for(var n=0;n<h.shapeArr.length;n++){var a=h.shapeArr[n],u=a.findVertexByPoint(t,i);if(u!=-1){var c=a.id<<16|u;if(s==-1)return c;e==-1&&(e=c),c==s&&(s=-1)}}}return e};I.prototype.findEdgeByPoint=function(t,i,s){var e=-1;s=s||-1;for(var o=0;o<this.bodyArr.length;o++){var h=this.bodyArr[o];if(h)for(var n=0;n<h.shapeArr.length;n++){var a=h.shapeArr[n];if(a.type==L.TYPE_POLY){var u=a.findEdgeByPoint(t,i);if(u!=-1){var c=a.id<<16|u;if(s==-1)return c;e==-1&&(e=c),c==s&&(s=-1)}}}}return e};I.prototype.findJointByPoint=function(t,i,s){var e=-1,o=i*i;s=s||-1;for(var h=0;h<this.jointArr.length;h++){var n=this.jointArr[h];if(n){var a=-1;if(r.distsq(t,n.getWorldAnchor1())<o?a=n.id<<16|0:r.distsq(t,n.getWorldAnchor2())<o&&(a=n.id<<16|1),a!=-1){if(s==-1)return a;e==-1&&(e=a),a==s&&(s=-1)}}}return e};I.prototype.findContactSolver=function(t,i){for(var s=0;s<this.contactSolverArr.length;s++){var e=this.contactSolverArr[s];if(t==e.shape1&&i==e.shape2)return e}return null};I.prototype.genTemporalContactSolvers=function(){var t=Date.now(),i=[];this.numContacts=0;for(var s=0;s<this.bodyArr.length;s++){var e=this.bodyArr[s];if(e){e.stepCount=this.stepCount;for(var o=0;o<this.bodyArr.length;o++){var h=this.bodyArr[o];if(h&&e.stepCount!=h.stepCount){var n=e.isAwake()&&!e.isStatic(),a=h.isAwake()&&!h.isStatic();if(!(!n&&!a)&&e.isCollidable(h)&&e.bounds.intersectsBounds(h.bounds))for(var u=0;u<e.shapeArr.length;u++)for(var c=0;c<h.shapeArr.length;c++){var m=e.shapeArr[u],y=h.shapeArr[c],f=[];if(ut.collide(m,y,f)){if(m.type>y.type){var T=m;m=y,y=T}this.numContacts+=f.length;var v=this.findContactSolver(m,y);if(v)v.update(f),i.push(v);else{e.awake(!0),h.awake(!0);var d=new $(m,y);d.contactArr=f,d.e=Math.max(m.e,y.e),d.u=Math.sqrt(m.u*y.u),i.push(d)}}}}}}}return V.timeCollision=Date.now()-t,i};I.prototype.initSolver=function(t,i,s){for(var e=Date.now(),o=0;o<this.contactSolverArr.length;o++)this.contactSolverArr[o].initSolver(i);for(var o=0;o<this.jointArr.length;o++)this.jointArr[o]&&this.jointArr[o].initSolver(t,s);if(s)for(var o=0;o<this.contactSolverArr.length;o++)this.contactSolverArr[o].warmStart();V.timeInitSolver=Date.now()-e};I.prototype.velocitySolver=function(t){for(var i=Date.now(),s=0;s<t;s++){for(var e=0;e<this.jointArr.length;e++)this.jointArr[e].solveVelocityConstraints();for(var e=0;e<this.contactSolverArr.length;e++)this.contactSolverArr[e].solveVelocityConstraints()}V.timeVelocitySolver=Date.now()-i};I.prototype.positionSolver=function(t){var i=Date.now(),s=!1;V.positionIterations=0;for(var e=0;e<t;e++){for(var o=!0,h=!0,n=0;n<this.contactSolverArr.length;n++){var a=this.contactSolverArr[n].solvePositionConstraints();o=a&&o}for(var n=0;n<this.jointArr.length;n++)if(this.jointArr[n]){var u=this.jointArr[n].solvePositionConstraints();h=u&&h}if(o&&h){s=!0;break}V.positionIterations++}return V.timePositionSolver=Date.now()-i,s};I.prototype.step=function(t,i,s,e,o){var h=1/t;this.stepCount++,this.contactSolverArr=this.genTemporalContactSolvers(),this.initSolver(t,h,e);for(var n=0;n<this.bodyArr.length;n++){var a=this.bodyArr[n];a&&a.isDynamic()&&a.isAwake()&&a.updateVelocity(this.gravity,t,this.damping)}for(var n=0;n<this.jointArr.length;n++){var u=this.jointArr[n];if(u){var c=u.body1,m=u.body2,y=c.isAwake()&&!c.isStatic(),f=m.isAwake()&&!m.isStatic();y^f&&(y||c.awake(!0),f||m.awake(!0))}}this.velocitySolver(i);for(var n=0;n<this.bodyArr.length;n++){var a=this.bodyArr[n];a&&a.isDynamic()&&a.isAwake()&&a.updatePosition(t)}for(var n=0;n<this.jointArr.length;n++){var u=this.jointArr[n];u&&u.breakable&&u.getReactionForce(h).lengthsq()>=u.maxForce*u.maxForce&&this.removeJoint(u)}for(var T=this.positionSolver(s),n=0;n<this.bodyArr.length;n++){var a=this.bodyArr[n];a&&a.syncTransform()}for(var n=0;n<this.contactSolverArr.length;n++){var v=this.contactSolverArr[n];this.postSolve(v)}for(var n=0;n<this.bodyArr.length;n++){var a=this.bodyArr[n];a&&a.isDynamic()&&a.isAwake()&&a.cacheData()}if(o){for(var d=999999,l=I.SLEEP_LINEAR_TOLERANCE*I.SLEEP_LINEAR_TOLERANCE,_=I.SLEEP_ANGULAR_TOLERANCE*I.SLEEP_ANGULAR_TOLERANCE,n=0;n<this.bodyArr.length;n++){var a=this.bodyArr[n];a&&a.isDynamic()&&(a.w*a.w>_||a.v.dot(a.v)>l?(a.sleepTime=0,d=0):(a.sleepTime+=t,d=Math.min(d,a.sleepTime)))}if(T&&d>=I.TIME_TO_SLEEP)for(var n=0;n<this.bodyArr.length;n++){var a=this.bodyArr[n];a&&a.awake(!1)}}};I.prototype.getBounds=function(){for(var t=new O,i=0;i<this.bodyArr.length;i++)for(var s=0;s<this.bodyArr[i].shapeArr.length;s++)t.addBounds(this.bodyArr[i].shapeArr[s].bounds);return t};var Z=function(t,i,s){arguments.length!=0&&(p.call(this,p.TYPE_MOUSE,t,i,!0),this.anchor1=this.body1.getLocalPoint(s),this.anchor2=this.body2.getLocalPoint(s),this.gamma=0,this.beta_c=0,this.frequencyHz=5,this.dampingRatio=.9,this.lambda_acc=new r(0,0))};Z.prototype=new p;Z.prototype.constructor=Z;Z.prototype.setSpringFrequencyHz=function(t){this.frequencyHz=t};Z.prototype.setSpringDampingRatio=function(t){this.dampingRatio=t};Z.prototype.initSolver=function(t,i){var s=this.body1,e=this.body2;this.maxImpulse=this.maxForce*t;var o=2*Math.PI*this.frequencyHz,h=e.m*(o*o),n=e.m*2*this.dampingRatio*o;this.gamma=(n+h*t)*t,this.gamma=this.gamma==0?0:1/this.gamma;var a=t*h*this.gamma;this.r2=e.xf.rotate(r.sub(this.anchor2,e.centroid));var u=this.r2,c=u.y*e.i_inv,m=e.m_inv+u.y*c+this.gamma,y=-u.x*c,f=e.m_inv+u.x*u.x*e.i_inv+this.gamma;this.em_inv=new D(m,y,y,f);var T=r.sub(r.add(e.p,this.r2),s.p);this.beta_c=r.scale(T,a),e.w*=.98,i?(e.v.mad(this.lambda_acc,e.m_inv),e.w+=r.cross(this.r2,this.lambda_acc)*e.i_inv):this.lambda_acc.set(0,0)};Z.prototype.solveVelocityConstraints=function(){var t=this.body2,i=r.mad(t.v,r.perp(this.r2),t.w),s=r.mad(this.beta_c,this.lambda_acc,this.gamma),e=this.em_inv.solve(r.add(i,s).neg()),o=this.lambda_acc.duplicate();this.lambda_acc.addself(e);var h=this.lambda_acc.lengthsq();h>this.maxImpulse*this.maxImpulse&&this.lambda_acc.scale(this.maxImpulse/Math.sqrt(h)),e=r.sub(this.lambda_acc,o),t.v.mad(e,t.m_inv),t.w+=r.cross(this.r2,e)*t.i_inv};Z.prototype.solvePositionConstraints=function(){return!0};Z.prototype.getReactionForce=function(t){return r.scale(this.lambda_acc,t)};Z.prototype.getReactionTorque=function(t){return 0};var pt=Symbol("app"),dt=Symbol("pause"),nt=Symbol("events"),It=["beforeRenderBody","beforeRenderShape","beforeRenderFrame","afterRenderFrame"],Rt=(t,i,s,e)=>Object.defineProperty(t,i,{get(){return this[s]},set:e});function et(t,i){this.renderer=t,this[pt]=i,this[nt]={},this.settings=Object.assign({gravity:new r(0,-10),frameRateHz:60,velocityIterations:8,positionIterations:4,warmStarting:!0,allowSleep:!0,backgroundColor:"rgb(95, 105, 118)",jointAnchorColor:"#11cf00"},i.settings||{});let s=this.camera=Object.assign({},i.camera||{}),e={showJoints:!0};Object.defineProperty(this.settings,"showJoints",{get(){return e.showJoints},set(o){t.joints_group.visible=e.showJoints=o}}),ut.init(),this.world=new I(t),this.resetScene(),Rt(this,"app",pt,o=>{this[pt]=o,this.settings=Object.assign(this.settings,o.settings||{}),this.camera=Object.assign(this.camera,o.camera||{}),this.resetScene(),this[dt]&&this.start()}),Rt(this,"pause",dt,o=>{o?this[dt]=!0:this.start()}),this.onResize=()=>{this.renderer.resize(),this[dt]&&this.drawFrame(0)},window.addEventListener("resize",this.onResize),window.addEventListener("orientationchange",this.onResize),this.onResize(),this.start()}et.prototype.start=function(){this[dt]=!1;let t=()=>{this.runFrame(),this[dt]||window.requestAnimationFrame(t)};window.requestAnimationFrame(t)};et.prototype.destroy=function(){window.removeEventListener("resize",this.onResize),window.removeEventListener("orientationchange",this.onResize),this[dt]=!0,this.world.clear()};et.prototype.resetScene=function(){this.world.clear(),this.world.gravity.copy(this.settings.gravity),this[pt].init(this.world,this),this.initFrame()};et.prototype.initFrame=function(){this.time={fps:0,fps_frameCount:0,fps_time:0,frameCount:0,lastTime:Date.now(),timeDelta:0}};et.prototype.runFrame=function(){var t=Date.now(),i=(t-this.time.lastTime)/1e3;i=Math.floor(i*60+.5)/60,this.time.lastTime=t;var s=1/this.settings.frameRateHz;this.time.timeDelta+=i,this[dt]&&(this.time.timeDelta=s),V.timeStep=0,V.stepCount=0;for(var e=4;e>0&&this.time.timeDelta>=s;e--){var o=Date.now();this.world.step(s,this.settings.velocityIterations,this.settings.positionIterations,this.settings.warmStarting,this.settings.allowSleep),V.timeStep+=Date.now()-o,V.stepCount++,this.time.timeDelta-=s}this.time.timeDelta>s&&(this.time.timeDelta=0),this[pt].runFrame&&this[pt].runFrame(),V.stepCount>0&&this.render(i),this.time.frameCount++,this.time.fps_frameCount++,this.time.fps_time+=i,this.time.fps_time>=1&&(this.time.fps=this.time.fps_frameCount/this.time.fps_time,this.time.fps_time-=1,this.time.fps_frameCount=0)};et.prototype.render=function(t){var i=Date.now();this.drawFrame(t),V.timeDrawFrame=Date.now()-i};et.prototype.redraw=function(){this.drawFrame(0)};et.prototype.drawFrame=function(t=0){var e,o,h,n,a,u,c;(o=(e=this[nt])==null?void 0:e.beforeRenderFrame)==null||o.forEach(m=>m(t));for(var i=0;i<this.world.bodyArr.length;i++){var s=this.world.bodyArr[i];(n=(h=this[nt])==null?void 0:h.beforeRenderBody)==null||n.forEach(m=>m(s)),this.renderer.updateBody(s)}for(var i=0;i<this.world.jointArr.length;i++)(a=this.renderer)==null||a.updateJoint(this.world.jointArr[i]);(c=(u=this[nt])==null?void 0:u.afterRenderFrame)==null||c.forEach(m=>m(t))};et.prototype.on=function(t,i){if(!It.includes(t))throw'Unknown event "'.concat(t,'"');if(this[nt][t]){if(this[nt][t].find(s=>s===i))return}else this[nt][t]=[];this[nt][t].push(i)};et.prototype.off=function(t,i){if(!It.includes(t))throw'Unknown event "'.concat(t,'"');if(!this[nt][t])return;let s=this[nt][t].findIndex(e=>e===i);s!==-1&&this[nt][t].splice(s,1)};var Nt=lt(Pt()?8:4),j=Symbol("events"),Ct=["mousedown","mouseup","mousemove"];function ft(t,i){if(this.settings=Object.assign({pick:!0,zoom:!0},i||{}),this.runner=t,this.runner.interaction=this,this.SELECTABLE_LINE_DIST_THREHOLD=Nt,this.state={mouseDown:!1,pointerDownMoving:!1},this.mouseJoint=null,this.mouseBody=new E(E.KINETIC),this.mouseBody.resetMassData(),this.runner.world.addBody(this.mouseBody),this[j]={},!this.runner.renderer.two)return;var s=this.runner.renderer,e=this;let{Two:o,two:h,stage:n,camera:a}=s;var u=h.renderer.domElement,c=new o.Vector,m={},y=0,f=!1;let T=(A,S)=>{var X,G;e.removeJoint();let k=a.screenToWorld(A,S),J=new r(k.x,-k.y);f=t.world.findBodyByPoint(J);var W=!1;(G=(X=this[j])==null?void 0:X.mousedown)!=null&&G.length&&(this[j].mousedown.forEach(ht=>{ht(f,new r(A,S),J)&&(W=!0)}),this.runner.pause&&this.runner.drawFrame(0)),W?(f=void 0,this.state.mouseDown=!1):this.settings.pick&&f&&(f.isStatic()?f=void 0:v(J))},v=A=>{e.mouseBody.p.copy(A),e.mouseBody.syncTransform(),e.mouseJoint=new Z(e.mouseBody,f,A),e.mouseJoint.maxForce=f.m*5e4,t.world.addJoint(e.mouseJoint)},d=A=>{this.state.mouseDown=!0,this.state.pointerDownMoving=!1,c.x=A.clientX,c.y=A.clientY,T(A.offsetX,A.offsetY)},l=A=>{var J,W;if(this.state.mouseDown)if(this.state.pointerDownMoving=!0,f){let X=a.screenToWorld(A.offsetX,A.offsetY),G=new r(X.x,-X.y);e.mouseBody.p.copy(G),e.mouseBody.syncTransform()}else{var S=A.clientX-c.x,k=A.clientY-c.y;a.translateSurface(S,k),c.set(A.clientX,A.clientY)}if((W=(J=this[j])==null?void 0:J.mousemove)!=null&&W.length){let X=t.renderer.canvas.getBoundingClientRect(),G=a.screenToWorld(A.offsetX,A.offsetY),ht=new r(G.x,-G.y);this[j].mousemove.forEach(mt=>mt(new r(A.offsetX,A.offsetY),ht)),this.runner.pause&&this.runner.drawFrame(0)}},_=A=>{var J,W;if((W=(J=this[j])==null?void 0:J.mouseup)!=null&&W.length){let X=t.renderer.canvas.getBoundingClientRect();var S=A.offsetX-X.left,k=A.offsetY-X.top;let G=a.screenToWorld(S,k),ht=new r(G.x,-G.y);this[j].mouseup.forEach(mt=>mt(A.type=="mouseleave"?void 0:t.world.findBodyByPoint(ht),new r(S,k),ht,this.state.pointerDownMoving))}this.state.mouseDown=!1,e.removeJoint()},b=A=>{_(A)},x=A=>{var S=(A.wheelDeltaY||-A.deltaY)/1e3,k=u.getBoundingClientRect();a.zoomBy(S,A.clientX-k.left,A.clientY-k.top),A.preventDefault()},w=A=>{switch(A.touches.length){case 2:st(A);break;case 1:C(A);break}A.preventDefault()},g=A=>{switch(A.touches.length){case 2:ct(A);break;case 1:N(A);break}A.preventDefault()},P=A=>{e.removeJoint(),m={};var S=A.touches[0];S&&(c.x=S.clientX,c.y=S.clientY),A.preventDefault()},C=A=>{var S=A.touches[0];c.x=S.clientX,c.y=S.clientY;var k=t.renderer.canvas.getBoundingClientRect();T(c.x-k.left,c.y-k.top)},N=A=>{var S=A.touches[0];if(f){let W=t.renderer.canvas.getBoundingClientRect(),X=a.screenToWorld(S.clientX-W.left,S.clientY-W.top),G=new r(X.x,-X.y);e.mouseBody.p.copy(G),e.mouseBody.syncTransform()}else{var k=S.clientX-c.x,J=S.clientY-c.y;a.translateSurface(k,J),c.set(S.clientX,S.clientY)}},st=A=>{var[S,k]=A.touches,J=k.clientX-S.clientX,W=k.clientY-S.clientY;y=Math.sqrt(J*J+W*W),c.x=J/2+S.clientX,c.y=W/2+S.clientY},ct=A=>{var[S,k]=A.touches,J=k.clientX-S.clientX,W=k.clientY-S.clientY,X=J/2+S.clientX,G=W/2+S.clientY;a.translateSurface(X-c.x,G-c.y),c.x=X,c.y=G;var ht=Math.sqrt(J*J+W*W),mt=ht-y,_t=u.getBoundingClientRect();a.zoomBy(mt/250,c.x-_t.left,c.y-_t.top),y=ht};u.addEventListener("mousedown",d,!1),u.addEventListener("mouseleave",b,!1),u.addEventListener("mousewheel",x,!1),u.addEventListener("wheel",x,!1),u.addEventListener("touchstart",w,!1),u.addEventListener("touchmove",g,!1),u.addEventListener("touchend",P,!1),u.addEventListener("touchcancel",P,!1),u.addEventListener("mousemove",l,!1),window.addEventListener("mouseup",_,!1)}ft.prototype.destroy=function(){this.removeJoint(),this.runner.world.removeBody(this.mouseBody)};ft.prototype.removeJoint=function(){this.mouseJoint&&(this.runner.world.removeJoint(this.mouseJoint),this.mouseJoint=null)};ft.prototype.on=function(t,i){if(!Ct.includes(t))throw'Unknown event "'.concat(t,'"');if(this[j][t]){if(this[j][t].find(s=>s===i))return}else this[j][t]=[];this[j][t].push(i)};ft.prototype.off=function(t,i){if(!Ct.includes(t))throw'Unknown event "'.concat(t,'"');if(!this[j][t])return;let s=this[j][t].findIndex(e=>e===i);s!==-1&&this[j][t].splice(s,1)};var tt=function(t,i,s,e){p.call(this,p.TYPE_ROPE,t,i,!0),this.anchor1=this.body1.getLocalPoint(s),this.anchor2=this.body2.getLocalPoint(e),this.maxDistance=r.dist(s,e),this.lambda_acc=0};tt.prototype=new p;tt.prototype.constructor=tt;tt.prototype.setWorldAnchor1=function(t){this.anchor1=this.body1.getLocalPoint(t),this.maxDistance=r.dist(t,this.getWorldAnchor2())};tt.prototype.setWorldAnchor2=function(t){this.anchor2=this.body2.getLocalPoint(t),this.maxDistance=r.dist(t,this.getWorldAnchor1())};tt.prototype.serialize=function(){return{type:"RopeJoint",body1:this.body1.id,body2:this.body2.id,anchor1:this.body1.getWorldPoint(this.anchor1),anchor2:this.body2.getWorldPoint(this.anchor2),collideConnected:this.collideConnected,maxForce:this.maxForce,breakable:this.breakable}};tt.prototype.initSolver=function(t,i){var s=this.body1,e=this.body2;this.maxImpulse=this.maxForce*t,this.r1=s.xf.rotate(r.sub(this.anchor1,s.centroid)),this.r2=e.xf.rotate(r.sub(this.anchor2,e.centroid));var o=r.sub(r.add(e.p,this.r2),r.add(s.p,this.r1));this.distance=o.length();var h=this.distance-this.maxDistance;h>0?(this.cdt=0,this.limitState=p.LIMIT_STATE_AT_UPPER):(this.cdt=h/t,this.limitState=p.LIMIT_STATE_INACTIVE),this.distance>p.LINEAR_SLOP?this.u=r.scale(o,1/this.distance):this.u=r.zero,this.s1=r.cross(this.r1,this.u),this.s2=r.cross(this.r2,this.u);var n=s.m_inv+e.m_inv+s.i_inv*this.s1*this.s1+e.i_inv*this.s2*this.s2;if(this.em=n==0?0:1/n,i){var a=r.scale(this.u,this.lambda_acc);s.v.mad(a,-s.m_inv),s.w-=this.s1*this.lambda_acc*s.i_inv,e.v.mad(a,e.m_inv),e.w+=this.s2*this.lambda_acc*e.i_inv}else this.lambda_acc=0};tt.prototype.solveVelocityConstraints=function(){var t=this.body1,i=this.body2,s=this.u.dot(r.sub(i.v,t.v))+this.s2*i.w-this.s1*t.w,e=-this.em*(s+this.cdt),o=this.lambda_acc;this.lambda_acc=Math.min(o+e,0),e=this.lambda_acc-o;var h=r.scale(this.u,e);t.v.mad(h,-t.m_inv),t.w-=this.s1*e*t.i_inv,i.v.mad(h,i.m_inv),i.w+=this.s2*e*i.i_inv};tt.prototype.solvePositionConstraints=function(){var t=this.body1,i=this.body2,s=r.rotate(r.sub(this.anchor1,t.centroid),t.a),e=r.rotate(r.sub(this.anchor2,i.centroid),i.a),o=r.sub(r.add(i.p,e),r.add(t.p,s)),h=o.length(),n=r.scale(o,1/h),a=h-this.maxDistance,u=q(a,0,p.MAX_LINEAR_CORRECTION),c=r.cross(s,n),m=r.cross(e,n),y=t.m_inv+i.m_inv+t.i_inv*c*c+i.i_inv*m*m,f=y==0?0:-u/y,T=r.scale(n,f);return t.p.mad(T,-t.m_inv),t.a-=c*f*t.i_inv,i.p.mad(T,i.m_inv),i.a+=m*f*i.i_inv,a<p.LINEAR_SLOP};tt.prototype.getReactionForce=function(t){return r.scale(this.u,this.lambda_acc*t)};tt.prototype.getReactionTorque=function(t){return 0};var Q=function(t,i,s){p.call(this,p.TYPE_WELD,t,i,!1),this.anchor1=this.body1.getLocalPoint(s),this.anchor2=this.body2.getLocalPoint(s),this.gamma=0,this.beta_c=0,this.frequencyHz=0,this.dampingRatio=0,this.lambda_acc=new R(0,0,0)};Q.prototype=new p;Q.prototype.constructor=Q;Q.prototype.setWorldAnchor1=function(t){this.anchor1=this.body1.getLocalPoint(t),this.anchor2=this.body2.getLocalPoint(t)};Q.prototype.setWorldAnchor2=function(t){this.anchor1=this.body1.getLocalPoint(t),this.anchor2=this.body2.getLocalPoint(t)};Q.prototype.serialize=function(){return{type:"WeldJoint",body1:this.body1.id,body2:this.body2.id,anchor1:this.body1.getWorldPoint(this.anchor1),anchor2:this.body2.getWorldPoint(this.anchor2),collideConnected:this.collideConnected,maxForce:this.maxForce,breakable:this.breakable,frequencyHz:this.frequencyHz,dampingRatio:this.dampingRatio}};Q.prototype.setSpringFrequencyHz=function(t){this.frequencyHz=t};Q.prototype.setSpringDampingRatio=function(t){this.dampingRatio=t};Q.prototype.initSolver=function(t,i){var s=this.body1,e=this.body2;this.maxImpulse=this.maxForce*t,this.r1=s.xf.rotate(r.sub(this.anchor1,s.centroid)),this.r2=e.xf.rotate(r.sub(this.anchor2,e.centroid));var o=s.m_inv+e.m_inv,h=this.r1,n=this.r2,a=h.x*s.i_inv,u=h.y*s.i_inv,c=n.x*e.i_inv,m=n.y*e.i_inv,y=o+h.y*u+n.y*m,f=-h.x*u-n.x*m,T=-u-m,v=o+h.x*a+n.x*c,d=a+c,l=s.i_inv+e.i_inv;if(this.em_inv=new Y(y,f,T,f,v,d,T,d,l),this.frequencyHz>0){var _=l>0?1/l:0,b=2*Math.PI*this.frequencyHz,x=_*b*b,w=_*2*this.dampingRatio*b;this.gamma=(w+x*t)*t,this.gamma=this.gamma==0?0:1/this.gamma;var g=t*x*this.gamma,P=e.a-s.a;this.beta_c=g*P,this.em_inv._33+=this.gamma}else this.gamma=0,this.beta_c=0;if(i){var C=new r(this.lambda_acc.x,this.lambda_acc.y),N=this.lambda_acc.z;s.v.mad(C,-s.m_inv),s.w-=(r.cross(this.r1,C)+N)*s.i_inv,e.v.mad(C,e.m_inv),e.w+=(r.cross(this.r2,C)+N)*e.i_inv}else this.lambda_acc.set(0,0,0)};Q.prototype.solveVelocityConstraints=function(){var t=this.body1,i=this.body2;if(this.frequencyHz>0){var s=i.w-t.w,e=-(s+this.beta_c+this.gamma*this.lambda_acc.z)/this.em_inv._33;t.w-=e*t.i_inv,i.w+=e*i.i_inv;var o=r.mad(t.v,r.perp(this.r1),t.w),h=r.mad(i.v,r.perp(this.r2),i.w),n=r.sub(h,o),a=this.em_inv.solve2x2(n.neg());this.lambda_acc.x+=a.x,this.lambda_acc.y+=a.y,this.lambda_acc.z+=e,t.v.mad(a,-t.m_inv),t.w-=r.cross(this.r1,a)*t.i_inv,i.v.mad(a,i.m_inv),i.w+=r.cross(this.r2,a)*i.i_inv}else{var o=r.mad(t.v,r.perp(this.r1),t.w),h=r.mad(i.v,r.perp(this.r2),i.w),n=r.sub(h,o),s=i.w-t.w,u=R.fromVec2(n,s),c=this.em_inv.solve(u.neg());this.lambda_acc.addself(c);var a=new r(c.x,c.y);t.v.mad(a,-t.m_inv),t.w-=(r.cross(this.r1,a)+c.z)*t.i_inv,i.v.mad(a,i.m_inv),i.w+=(r.cross(this.r2,a)+c.z)*i.i_inv}};Q.prototype.solvePositionConstraints=function(){var t=this.body1,i=this.body2,s=r.rotate(r.sub(this.anchor1,t.centroid),t.a),e=r.rotate(r.sub(this.anchor2,i.centroid),i.a),o=t.m_inv+i.m_inv,h=s.x*t.i_inv,n=s.y*t.i_inv,a=e.x*i.i_inv,u=e.y*i.i_inv,c=o+s.y*n+e.y*u,m=-s.x*n-e.x*u,y=-n-u,f=o+s.x*h+e.x*a,T=h+a,v=t.i_inv+i.i_inv,d=new Y(c,m,y,m,f,T,y,T,v);if(this.frequencyHz>0){var l=r.sub(r.add(i.p,e),r.add(t.p,s)),_=0,b=r.truncate(l,p.MAX_LINEAR_CORRECTION),x=d.solve2x2(b.neg());t.p.mad(x,-t.m_inv),t.a-=r.cross(s,x)*t.i_inv,i.p.mad(x,i.m_inv),i.a+=r.cross(e,x)*i.i_inv}else{var l=r.sub(r.add(i.p,e),r.add(t.p,s)),_=i.a-t.a,b=R.fromVec2(r.truncate(l,p.MAX_LINEAR_CORRECTION),q(_,-p.MAX_ANGULAR_CORRECTION,p.MAX_ANGULAR_CORRECTION)),w=d.solve(b.neg()),x=new r(w.x,w.y);t.p.mad(x,-t.m_inv),t.a-=(r.cross(s,x)+w.z)*t.i_inv,i.p.mad(x,i.m_inv),i.a+=(r.cross(e,x)+w.z)*i.i_inv}return l.length()<p.LINEAR_SLOP&&Math.abs(_)<=p.ANGULAR_SLOP};Q.prototype.getReactionForce=function(t){return r.scale(this.lambda_acc.toVec2(),t)};Q.prototype.getReactionTorque=function(t){return this.lambda_acc.z*t};var U=function(t,i,s,e){p.call(this,p.TYPE_WHEEL,t,i,!0),this.anchor1=this.body1.getLocalPoint(s),this.anchor2=this.body2.getLocalPoint(e);var o=r.sub(e,s);this.restLength=o.length(),this.u_local=this.body1.getLocalVector(r.normalize(o)),this.n_local=r.perp(this.u_local),this.lambda_acc=0,this.motorLambda_acc=0,this.springLambda_acc=0,this.motorEnabled=!1,this.motorSpeed=0,this.maxMotorTorque=0,this.gamma=0,this.beta_c=0,this.frequencyHz=0,this.dampingRatio=0};U.prototype=new p;U.prototype.constructor=U;U.prototype.setWorldAnchor1=function(t){this.anchor1=this.body1.getLocalPoint(t);var i=r.sub(this.getWorldAnchor2(),t);this.u_local=this.body1.getLocalVector(r.normalize(i)),this.n_local=r.perp(this.u_local)};U.prototype.setWorldAnchor2=function(t){this.anchor2=this.body2.getLocalPoint(t);var i=r.sub(t,this.getWorldAnchor1());this.u_local=this.body1.getLocalVector(r.normalize(i)),this.n_local=r.perp(this.u_local)};U.prototype.serialize=function(){return{type:"WheelJoint",body1:this.body1.id,body2:this.body2.id,anchor1:this.body1.getWorldPoint(this.anchor1),anchor2:this.body2.getWorldPoint(this.anchor2),collideConnected:this.collideConnected,maxForce:this.maxForce,breakable:this.breakable,motorEnabled:this.motorEnabled,motorSpeed:this.motorSpeed,maxMotorTorque:this.maxMotorTorque,frequencyHz:this.frequencyHz,dampingRatio:this.dampingRatio}};U.prototype.setSpringFrequencyHz=function(t){this.frequencyHz=t};U.prototype.setSpringDampingRatio=function(t){this.dampingRatio=t};U.prototype.enableMotor=function(t){this.motorEnabled=t};U.prototype.setMotorSpeed=function(t){this.motorSpeed=t};U.prototype.setMaxMotorTorque=function(t){this.maxMotorTorque=t};U.prototype.initSolver=function(t,i){var s=this.body1,e=this.body2;this.maxImpulse=this.maxForce*t,this.r1=s.xf.rotate(r.sub(this.anchor1,s.centroid)),this.r2=e.xf.rotate(r.sub(this.anchor2,e.centroid));var o=r.add(s.p,this.r1),h=r.add(e.p,this.r2),n=r.sub(h,o);this.r1_d=r.add(this.r1,n),this.n=r.rotate(this.n_local,s.a),this.sn1=r.cross(this.r1_d,this.n),this.sn2=r.cross(this.r2,this.n);var a=s.m_inv+e.m_inv+s.i_inv*this.sn1*this.sn1+e.i_inv*this.sn2*this.sn2;if(this.em=a>0?1/a:a,this.frequencyHz>0){this.u=r.rotate(this.u_local,s.a),this.su1=r.cross(this.r1_d,this.u),this.su2=r.cross(this.r2,this.u);var u=s.m_inv+e.m_inv+s.i_inv*this.su1*this.su1+e.i_inv*this.su2*this.su2,c=u==0?0:1/u,m=2*Math.PI*this.frequencyHz,y=c*m*m,f=c*2*this.dampingRatio*m;this.gamma=(f+y*t)*t,this.gamma=this.gamma==0?0:1/this.gamma;var T=t*y*this.gamma,v=r.dot(n,this.u)-this.restLength;this.beta_c=T*v,u=u+this.gamma,this.springEm=u==0?0:1/u}else this.gamma=0,this.beta_c=0,this.springLambda_acc=0;if(this.motorEnabled){this.maxMotorImpulse=this.maxMotorTorque*t;var d=s.i_inv+e.i_inv;this.motorEm=d>0?1/d:d}else this.motorEm=0,this.motorLambda_acc=0;if(i){var l=r.scale(this.n,this.lambda_acc),_=this.sn1*this.lambda_acc+this.motorLambda_acc,b=this.sn2*this.lambda_acc+this.motorLambda_acc;this.frequencyHz>0&&(l.addself(r.scale(this.u,this.springLambda_acc)),_+=this.su1*this.springLambda_acc,b+=this.su2*this.springLambda_acc),s.v.mad(l,-s.m_inv),s.w-=_*s.i_inv,e.v.mad(l,e.m_inv),e.w+=b*e.i_inv}else this.lambda_acc=0,this.springLambda_acc=0,this.motorLambda_acc=0};U.prototype.solveVelocityConstraints=function(){var t=this.body1,i=this.body2;if(this.frequencyHz>0){var o=this.u.dot(r.sub(i.v,t.v))+this.su2*i.w-this.su1*t.w,s=this.beta_c+this.gamma*this.springLambda_acc,h=-this.springEm*(o+s);this.springLambda_acc+=h;var n=r.scale(this.u,h);t.v.mad(n,-t.m_inv),t.w-=this.su1*h*t.i_inv,i.v.mad(n,i.m_inv),i.w+=this.su2*h*i.i_inv}if(this.motorEnabled){var o=i.w-t.w-this.motorSpeed,h=-this.motorEm*o,e=this.motorLambda_acc;this.motorLambda_acc=q(this.motorLambda_acc+h,-this.maxMotorImpulse,this.maxMotorImpulse),h=this.motorLambda_acc-e,t.w-=h*t.i_inv,i.w+=h*i.i_inv}var o=this.n.dot(r.sub(i.v,t.v))+this.sn2*i.w-this.sn1*t.w,h=-this.em*o;this.lambda_acc+=h;var n=r.scale(this.n,h);t.v.mad(n,-t.m_inv),t.w-=this.sn1*h*t.i_inv,i.v.mad(n,i.m_inv),i.w+=this.sn2*h*i.i_inv};U.prototype.solvePositionConstraints=function(){var t=this.body1,i=this.body2,s=r.rotate(r.sub(this.anchor1,t.centroid),t.a),e=r.rotate(r.sub(this.anchor2,i.centroid),i.a),o=r.add(t.p,s),h=r.add(i.p,e),n=r.sub(h,o),a=r.add(s,n),u=r.rotate(this.n_local,t.a),c=r.dot(u,n),m=q(c,-p.MAX_LINEAR_CORRECTION,p.MAX_LINEAR_CORRECTION),y=r.cross(a,u),f=r.cross(e,u),T=t.m_inv+i.m_inv+t.i_inv*y*y+i.i_inv*f*f,v=T==0?0:1/T,d=v*-m,l=r.scale(u,d);return t.p.mad(l,-t.m_inv),t.a-=y*d*t.i_inv,i.p.mad(l,i.m_inv),i.a+=f*d*i.i_inv,Math.abs(c)<p.LINEAR_SLOP};U.prototype.getReactionForce=function(t){return r.scale(this.n,this.lambda_acc*t)};U.prototype.getReactionTorque=function(t){return 0};var it=function(t,i){p.call(this,p.TYPE_ANGLE,t,i,!0),this.anchor1=new r(0,0),this.anchor2=new r(0,0),this.refAngle=i.a-t.a,this.lambda_acc=0};it.prototype=new p;it.prototype.constructor=it;it.prototype.setWorldAnchor1=function(t){this.anchor1=new r(0,0)};it.prototype.setWorldAnchor2=function(t){this.anchor2=new r(0,0)};it.prototype.serialize=function(){return{type:"AngleJoint",body1:this.body1.id,body2:this.body2.id,collideConnected:this.collideConnected}};it.prototype.initSolver=function(t,i){var s=this.body1,e=this.body2;this.maxImpulse=this.maxForce*t;var o=s.i_inv+e.i_inv;this.em=o==0?0:1/o,i?(s.w-=this.lambda_acc*s.i_inv,e.w+=this.lambda_acc*e.i_inv):this.lambda_acc=0};it.prototype.solveVelocityConstraints=function(){var t=this.body1,i=this.body2,s=i.w-t.w,e=-this.em*s;this.lambda_acc+=e,t.w-=e*t.i_inv,i.w+=e*i.i_inv};it.prototype.solvePositionConstraints=function(){var t=this.body1,i=this.body2,s=i.a-t.a-this.refAngle,e=q(s,-p.MAX_ANGULAR_CORRECTION,p.MAX_ANGULAR_CORRECTION),o=this.em*-e;return t.a-=o*t.i_inv,i.a+=o*i.i_inv,Math.abs(s)<p.ANGULAR_SLOP};it.prototype.getReactionForce=function(t){return r.zero};it.prototype.getReactionTorque=function(t){return this.lambda_acc*t};var K=function(t,i,s,e){p.call(this,p.TYPE_DISTANCE,t,i,!0),this.anchor1=this.body1.getLocalPoint(s),this.anchor2=this.body2.getLocalPoint(e),this.restLength=r.dist(s,e),this.gamma=0,this.beta_c=0,this.frequencyHz=0,this.dampingRatio=0,this.lambda_acc=0};K.prototype=new p;K.prototype.constructor=K;K.prototype.setWorldAnchor1=function(t){this.anchor1=this.body1.getLocalPoint(t),this.restLength=r.dist(t,this.getWorldAnchor2())};K.prototype.setWorldAnchor2=function(t){this.anchor2=this.body2.getLocalPoint(t),this.restLength=r.dist(t,this.getWorldAnchor1())};K.prototype.serialize=function(){return{type:"DistanceJoint",body1:this.body1.id,body2:this.body2.id,anchor1:this.body1.getWorldPoint(this.anchor1),anchor2:this.body2.getWorldPoint(this.anchor2),collideConnected:this.collideConnected,maxForce:this.maxForce,breakable:this.breakable,frequencyHz:this.frequencyHz,dampingRatio:this.dampingRatio}};K.prototype.setSpringFrequencyHz=function(t){this.frequencyHz=t};K.prototype.setSpringDampingRatio=function(t){this.dampingRatio=t};K.prototype.initSolver=function(t,i){var s=this.body1,e=this.body2;this.maxImpulse=this.maxForce*t,this.r1=s.xf.rotate(r.sub(this.anchor1,s.centroid)),this.r2=e.xf.rotate(r.sub(this.anchor2,e.centroid));var o=r.sub(r.add(e.p,this.r2),r.add(s.p,this.r1)),h=o.length();h>p.LINEAR_SLOP?this.u=r.scale(o,1/h):this.u=r.zero,this.s1=r.cross(this.r1,this.u),this.s2=r.cross(this.r2,this.u);var n=s.m_inv+e.m_inv+s.i_inv*this.s1*this.s1+e.i_inv*this.s2*this.s2;if(this.em=n==0?0:1/n,this.frequencyHz>0){var a=2*Math.PI*this.frequencyHz,u=this.em*a*a,c=this.em*2*this.dampingRatio*a;this.gamma=(c+u*t)*t,this.gamma=this.gamma==0?0:1/this.gamma;var m=t*u*this.gamma,y=h-this.restLength;this.beta_c=m*y,n=n+this.gamma,this.em=n==0?0:1/n}else this.gamma=0,this.beta_c=0;if(i){var f=r.scale(this.u,this.lambda_acc);s.v.mad(f,-s.m_inv),s.w-=this.s1*this.lambda_acc*s.i_inv,e.v.mad(f,e.m_inv),e.w+=this.s2*this.lambda_acc*e.i_inv}else this.lambda_acc=0};K.prototype.solveVelocityConstraints=function(){var t=this.body1,i=this.body2,s=this.u.dot(r.sub(i.v,t.v))+this.s2*i.w-this.s1*t.w,e=this.beta_c+this.gamma*this.lambda_acc,o=-this.em*(s+e);this.lambda_acc+=o;var h=r.scale(this.u,o);t.v.mad(h,-t.m_inv),t.w-=this.s1*o*t.i_inv,i.v.mad(h,i.m_inv),i.w+=this.s2*o*i.i_inv};K.prototype.solvePositionConstraints=function(){if(this.frequencyHz>0)return!0;var t=this.body1,i=this.body2,s=r.rotate(r.sub(this.anchor1,t.centroid),t.a),e=r.rotate(r.sub(this.anchor2,i.centroid),i.a),o=r.sub(r.add(i.p,e),r.add(t.p,s)),h=o.length(),n=r.scale(o,1/h),a=h-this.restLength,u=q(a,-p.MAX_LINEAR_CORRECTION,p.MAX_LINEAR_CORRECTION),c=r.cross(s,n),m=r.cross(e,n),y=t.m_inv+i.m_inv+t.i_inv*c*c+i.i_inv*m*m,f=y==0?0:-u/y,T=r.scale(n,f);return t.p.mad(T,-t.m_inv),t.a-=c*f*t.i_inv,i.p.mad(T,i.m_inv),i.a+=m*f*i.i_inv,Math.abs(a)<p.LINEAR_SLOP};K.prototype.getReactionForce=function(t){return r.scale(this.u,this.lambda_acc*t)};K.prototype.getReactionTorque=function(t){return 0};var H=function(t,i,s){p.call(this,p.TYPE_REVOLUTE,t,i,!1),this.anchor1=this.body1.getLocalPoint(s),this.anchor2=this.body2.getLocalPoint(s),this.refAngle=i.a-t.a,this.lambda_acc=new R(0,0,0),this.motorLambda_acc=0,this.limitEnabled=!1,this.limitLowerAngle=0,this.limitUpperAngle=0,this.limitState=p.LIMIT_STATE_INACTIVE,this.motorEnabled=!1,this.motorSpeed=0,this.maxMotorTorque=0};H.prototype=new p;H.prototype.constructor=H;H.prototype.setWorldAnchor1=function(t){this.anchor1=this.body1.getLocalPoint(t),this.anchor2=this.body2.getLocalPoint(t)};H.prototype.setWorldAnchor2=function(t){this.anchor1=this.body1.getLocalPoint(t),this.anchor2=this.body2.getLocalPoint(t)};H.prototype.serialize=function(){return{type:"RevoluteJoint",body1:this.body1.id,body2:this.body2.id,anchor:this.body1.getWorldPoint(this.anchor1),collideConnected:this.collideConnected,maxForce:this.maxForce,breakable:this.breakable,limitEnabled:this.limitEnabled,limitLowerAngle:this.limitLowerAngle,limitUpperAngle:this.limitUpperAngle,motorEnabled:this.motorEnabled,motorSpeed:this.motorSpeed,maxMotorTorque:this.maxMotorTorque}};H.prototype.enableMotor=function(t){this.motorEnabled=t};H.prototype.setMotorSpeed=function(t){this.motorSpeed=t};H.prototype.setMaxMotorTorque=function(t){this.maxMotorTorque=t};H.prototype.enableLimit=function(t){this.limitEnabled=t};H.prototype.setLimits=function(t,i){this.limitLowerAngle=t,this.limitUpperAngle=i};H.prototype.initSolver=function(t,i){var s=this.body1,e=this.body2;if(this.maxImpulse=this.maxForce*t,this.motorEnabled?this.maxMotorImpulse=this.maxMotorTorque*t:this.motorLambda_acc=0,this.limitEnabled){var o=e.a-s.a-this.refAngle;Math.abs(this.limitUpperAngle-this.limitLowerAngle)<p.ANGULAR_SLOP?this.limitState=p.LIMIT_STATE_EQUAL_LIMITS:o<=this.limitLowerAngle?(this.limitState!=p.LIMIT_STATE_AT_LOWER&&(this.lambda_acc.z=0),this.limitState=p.LIMIT_STATE_AT_LOWER):o>=this.limitUpperAngle?(this.limitState!=p.LIMIT_STATE_AT_UPPER&&(this.lambda_acc.z=0),this.limitState=p.LIMIT_STATE_AT_UPPER):(this.limitState=p.LIMIT_STATE_INACTIVE,this.lambda_acc.z=0)}else this.limitState=p.LIMIT_STATE_INACTIVE;this.r1=s.xf.rotate(r.sub(this.anchor1,s.centroid)),this.r2=e.xf.rotate(r.sub(this.anchor2,e.centroid));var h=s.m_inv+e.m_inv,n=this.r1,a=this.r2,u=n.x*s.i_inv,c=n.y*s.i_inv,m=a.x*e.i_inv,y=a.y*e.i_inv,f=h+n.y*c+a.y*y,T=-n.x*c-a.x*y,v=-c-y,d=h+n.x*u+a.x*m,l=u+m,_=s.i_inv+e.i_inv;if(this.em_inv=new Y(f,T,v,T,d,l,v,l,_),_!=0&&(this.em2=1/_),i){var b=new r(this.lambda_acc.x,this.lambda_acc.y),x=this.lambda_acc.z+this.motorLambda_acc;s.v.mad(b,-s.m_inv),s.w-=(r.cross(this.r1,b)+x)*s.i_inv,e.v.mad(b,e.m_inv),e.w+=(r.cross(this.r2,b)+x)*e.i_inv}else this.lambda_acc.set(0,0,0),this.motorLambda_acc=0};H.prototype.solveVelocityConstraints=function(){var t=this.body1,i=this.body2;if(this.motorEnabled&&this.limitState!=p.LIMIT_STATE_EQUAL_LIMITS){var s=i.w-t.w-this.motorSpeed,e=-this.em2*s,o=this.motorLambda_acc;this.motorLambda_acc=q(this.motorLambda_acc+e,-this.maxMotorImpulse,this.maxMotorImpulse),e=this.motorLambda_acc-o,t.w-=e*t.i_inv,i.w+=e*i.i_inv}if(this.limitEnabled&&this.limitState!=p.LIMIT_STATE_INACTIVE){var h=r.mad(t.v,r.perp(this.r1),t.w),n=r.mad(i.v,r.perp(this.r2),i.w),a=r.sub(n,h),u=i.w-t.w,s=R.fromVec2(a,u),e=this.em_inv.solve(s.neg());if(this.limitState==p.LIMIT_STATE_EQUAL_LIMITS)this.lambda_acc.addself(e);else if(this.limitState==p.LIMIT_STATE_AT_LOWER||this.limitState==p.LIMIT_STATE_AT_UPPER){var c=this.lambda_acc.z+e.z,m=this.limitState==p.LIMIT_STATE_AT_LOWER&&c<0,y=this.limitState==p.LIMIT_STATE_AT_UPPER&&c>0;if(m||y){var f=r.add(a,r.scale(new r(this.em_inv._13,this.em_inv._23),c)),T=this.em_inv.solve2x2(f.neg());e.x=T.x,e.y=T.y,e.z=-this.lambda_acc.z,this.lambda_acc.x+=e.x,this.lambda_acc.y+=e.y,this.lambda_acc.z=0}else this.lambda_acc.addself(e)}var v=new r(e.x,e.y);t.v.mad(v,-t.m_inv),t.w-=(r.cross(this.r1,v)+e.z)*t.i_inv,i.v.mad(v,i.m_inv),i.w+=(r.cross(this.r2,v)+e.z)*i.i_inv}else{var h=r.mad(t.v,r.perp(this.r1),t.w),n=r.mad(i.v,r.perp(this.r2),i.w),s=r.sub(n,h),e=this.em_inv.solve2x2(s.neg());this.lambda_acc.addself(R.fromVec2(e,0)),t.v.mad(e,-t.m_inv),t.w-=r.cross(this.r1,e)*t.i_inv,i.v.mad(e,i.m_inv),i.w+=r.cross(this.r2,e)*i.i_inv}};H.prototype.solvePositionConstraints=function(){var t=this.body1,i=this.body2,s=0,e=0;if(this.limitEnabled&&this.limitState!=p.LIMIT_STATE_INACTIVE){var o=i.a-t.a-this.refAngle,h=0;if(this.limitState==p.LIMIT_STATE_EQUAL_LIMITS){var n=q(o-this.limitLowerAngle,-p.MAX_ANGULAR_CORRECTION,p.MAX_ANGULAR_CORRECTION);s=Math.abs(n),h=-this.em2*n}else if(this.limitState==p.LIMIT_STATE_AT_LOWER){var n=o-this.limitLowerAngle;s=-n,n=q(n+p.ANGULAR_SLOP,-p.MAX_ANGULAR_CORRECTION,0),h=-this.em2*n}else if(this.limitState==p.LIMIT_STATE_AT_UPPER){var n=o-this.limitUpperAngle;s=n,n=q(n-p.ANGULAR_SLOP,0,p.MAX_ANGULAR_CORRECTION),h=-this.em2*n}t.a-=h*t.i_inv,i.a+=h*i.i_inv}{var a=r.rotate(r.sub(this.anchor1,t.centroid),t.a),u=r.rotate(r.sub(this.anchor2,i.centroid),i.a),n=r.sub(r.add(i.p,u),r.add(t.p,a)),c=r.truncate(n,p.MAX_LINEAR_CORRECTION);e=c.length();var m=t.m_inv+i.m_inv,y=a.y*t.i_inv,f=u.y*i.i_inv,T=m+a.y*y+u.y*f,v=-a.x*y-u.x*f,d=m+a.x*a.x*t.i_inv+u.x*u.x*i.i_inv,l=new D(T,v,v,d),_=l.solve(c.neg());t.p.mad(_,-t.m_inv),t.a-=r.cross(a,_)*t.i_inv,i.p.mad(_,i.m_inv),i.a+=r.cross(u,_)*i.i_inv}return e<p.LINEAR_SLOP&&s<p.ANGULAR_SLOP};H.prototype.getReactionForce=function(t){return r.scale(this.lambda_acc,t)};H.prototype.getReactionTorque=function(t){return 0};var rt=function(t,i,s,e){p.call(this,p.TYPE_PRISMATIC,t,i,!0),this.anchor1=this.body1.getLocalPoint(s),this.anchor2=this.body2.getLocalPoint(e);var o=r.sub(e,s);this.n_local=this.body1.getLocalVector(r.normalize(r.perp(o))),this.da=i.a-t.a,this.lambda_acc=new r(0,0)};rt.prototype=new p;rt.prototype.constructor=rt;rt.prototype.setWorldAnchor1=function(t){this.anchor1=this.body1.getLocalPoint(t);var i=r.sub(this.getWorldAnchor2(),t);this.n_local=this.body1.getLocalVector(r.normalize(r.perp(i)))};rt.prototype.setWorldAnchor2=function(t){this.anchor2=this.body2.getLocalPoint(t);var i=r.sub(t,this.getWorldAnchor1());this.n_local=this.body1.getLocalVector(r.normalize(r.perp(i)))};rt.prototype.serialize=function(){return{type:"PrismaticJoint",body1:this.body1.id,body2:this.body2.id,anchor1:this.body1.getWorldPoint(this.anchor1),anchor2:this.body2.getWorldPoint(this.anchor2),collideConnected:this.collideConnected,maxForce:this.maxForce,breakable:this.breakable}};rt.prototype.initSolver=function(t,i){var s=this.body1,e=this.body2;this.maxImpulse=this.maxForce*t,this.r1=s.xf.rotate(r.sub(this.anchor1,s.centroid)),this.r2=e.xf.rotate(r.sub(this.anchor2,e.centroid));var o=r.add(s.p,this.r1),h=r.add(e.p,this.r2),n=r.sub(h,o);this.r1_d=r.add(this.r1,n),this.n=r.normalize(r.perp(n)),this.s1=r.cross(this.r1_d,this.n),this.s2=r.cross(this.r2,this.n);var a=this.s1,u=this.s2,c=a*s.i_inv,m=u*e.i_inv,y=s.m_inv+e.m_inv+a*c+u*m,f=c+m,T=s.i_inv+e.i_inv;if(this.em_inv=new D(y,f,f,T),i){var v=r.scale(this.n,this.lambda_acc.x);s.v.mad(v,-s.m_inv),s.w-=(this.s1*this.lambda_acc.x+this.lambda_acc.y)*s.i_inv,e.v.mad(v,e.m_inv),e.w+=(this.s2*this.lambda_acc.x+this.lambda_acc.y)*e.i_inv}else this.lambda_acc.set(0,0)};rt.prototype.solveVelocityConstraints=function(){var t=this.body1,i=this.body2,s=this.n.dot(r.sub(i.v,t.v))+this.s2*i.w-this.s1*t.w,e=i.w-t.w,o=this.em_inv.solve(new r(-s,-e));this.lambda_acc.addself(o);var h=r.scale(this.n,o.x);t.v.mad(h,-t.m_inv),t.w-=(this.s1*o.x+o.y)*t.i_inv,i.v.mad(h,i.m_inv),i.w+=(this.s2*o.x+o.y)*i.i_inv};rt.prototype.solvePositionConstraints=function(){var t=this.body1,i=this.body2,s=r.rotate(r.sub(this.anchor1,t.centroid),t.a),e=r.rotate(r.sub(this.anchor2,i.centroid),i.a),o=r.add(t.p,s),h=r.add(i.p,e),n=r.sub(h,o),a=r.add(s,n),u=r.rotate(this.n_local,t.a),c=r.dot(u,n),m=i.a-t.a-this.da,y=new r;y.x=q(c,-p.MAX_LINEAR_CORRECTION,p.MAX_LINEAR_CORRECTION),y.y=q(m,-p.MAX_ANGULAR_CORRECTION,p.MAX_ANGULAR_CORRECTION);var f=r.cross(a,u),T=r.cross(e,u),v=f*t.i_inv,d=T*i.i_inv,l=t.m_inv+i.m_inv+f*v+T*d,_=v+d,b=t.i_inv+i.i_inv,x=new D(l,_,_,b),w=x.solve(y.neg()),g=r.scale(u,w.x);return t.p.mad(g,-t.m_inv),t.a-=(r.cross(a,g)+w.y)*t.i_inv,i.p.mad(g,i.m_inv),i.a+=(r.cross(e,g)+w.y)*i.i_inv,Math.abs(c)<=p.LINEAR_SLOP&&Math.abs(m)<=p.ANGULAR_SLOP};rt.prototype.getReactionForce=function(t){return r.scale(this.n,this.lambda_acc.x*t)};rt.prototype.getReactionTorque=function(t){return this.lambda_acc.y*t};function zt(t,i,s=1e3,e=0,o=300){var h=performance.now(),n=h+s,a;function u(c){var m=c-h;if(m>=s)return cancelAnimationFrame(a);t(e+(o-e)*i(m/s)),a=requestAnimationFrame(u)}return a=requestAnimationFrame(u)}function Ot(t,i,s=1e3,e){var o=performance.now(),h=o+s,n,a=new Array(e[0].length);function u(c){var m=c-o;if(m>=s)return cancelAnimationFrame(n);var y=i(m/s);e.forEach((f,T)=>a[T]=f[0]+(f[1]-f[0])*y),t(...a),n=requestAnimationFrame(u)}return n=requestAnimationFrame(u)}var M={};M.linear=function(t){return t};M.inQuad=function(t){return t*t};M.outQuad=function(t){return t*(2-t)};M.inOutQuad=function(t){return t*=2,t<1?.5*t*t:-.5*(--t*(t-2)-1)};M.inCube=function(t){return t*t*t};M.outCube=function(t){return--t*t*t+1};M.inOutCube=function(t){return t*=2,t<1?.5*t*t*t:.5*((t-=2)*t*t+2)};M.inQuart=function(t){return t*t*t*t};M.outQuart=function(t){return 1- --t*t*t*t};M.inOutQuart=function(t){return t*=2,t<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)};M.inQuint=function(t){return t*t*t*t*t};M.outQuint=function(t){return--t*t*t*t*t+1};M.inOutQuint=function(t){return t*=2,t<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)};M.inSine=function(t){return 1-Math.cos(t*Math.PI/2)};M.outSine=function(t){return Math.sin(t*Math.PI/2)};M.inOutSine=function(t){return .5*(1-Math.cos(Math.PI*t))};M.inExpo=function(t){return t==0?0:Math.pow(1024,t-1)};M.outExpo=function(t){return t==1?t:1-Math.pow(2,-10*t)};M.inOutExpo=function(t){return t==0?0:t==1?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(-Math.pow(2,-10*(t-1))+2)};M.inCirc=function(t){return 1-Math.sqrt(1-t*t)};M.outCirc=function(t){return Math.sqrt(1- --t*t)};M.inOutCirc=function(t){return t*=2,t<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)};M.inBack=function(t){var i=1.70158;return t*t*((i+1)*t-i)};M.outBack=function(t){var i=1.70158;return--t*t*((i+1)*t+i)+1};M.inOutBack=function(t){var i=2.5949095;return(t*=2)<1?.5*(t*t*((i+1)*t-i)):.5*((t-=2)*t*((i+1)*t+i)+2)};M.inBounce=function(t){return 1-M.outBounce(1-t)};M.outBounce=function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375};M.inOutBounce=function(t){return t<.5?M.inBounce(t*2)*.5:M.outBounce(t*2-1)*.5+.5};M.inElastic=function(t){var i,s=.1,e=.4;return t===0?0:t===1?1:(!s||s<1?(s=1,i=e/4):i=e*Math.asin(1/s)/(2*Math.PI),-(s*Math.pow(2,10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/e)))};M.outElastic=function(t){var i,s=.1,e=.4;return t===0?0:t===1?1:(!s||s<1?(s=1,i=e/4):i=e*Math.asin(1/s)/(2*Math.PI),s*Math.pow(2,-10*t)*Math.sin((t-i)*(2*Math.PI)/e)+1)};M.inOutElastic=function(t){var i,s=.1,e=.4;return t===0?0:t===1?1:(!s||s<1?(s=1,i=e/4):i=e*Math.asin(1/s)/(2*Math.PI),(t*=2)<1?-.5*(s*Math.pow(2,10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/e)):s*Math.pow(2,-10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/e)*.5+1)};var qt={Interaction:ft,Runner:et,World:I,Body:E,Shape:L,ShapeBox:Mt,ShapePoly:z,ShapeCircle:F,ShapeTriangle:St,ShapeSegment:B,RopeJoint:tt,WeldJoint:Q,WheelJoint:U,AngleJoint:it,MouseJoint:Z,DistanceJoint:K,RevoluteJoint:H,PrismaticJoint:rt,Bounds:O,collision:ut,stats:V,pixel2meter:lt,meter2pixel:yt,vec2:r,deg2rad:vt,animate:zt,animateBatch:Ot,easings:M};window.Newton=qt;})();

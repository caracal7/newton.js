function G(t,i,s,e){this.hash=e,this.p=t,this.n=i,this.d=s,this.lambda_n_acc=0,this.lambda_t_acc=0}Math.clamp=function(t,i,s){return t<i?i:t>s?s:t};Math.log2=function(t){return Math.log(t)/Math.log(2)};function it(t){return t/180*Math.PI}function nt(t){return t*.02}function B(t){return t*50}function r(t,i){this.x=t||0,this.y=i||0}r.zero=new r(0,0);r.prototype.toString=function(){return["x:",this.x,"y:",this.y].join(" ")};r.prototype.set=function(t,i){return this.x=t,this.y=i,this};r.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this};r.prototype.duplicate=function(){return new r(this.x,this.y)};r.prototype.equal=function(t){return!(this.x!=t.x||this.y!=t.y)};r.prototype.add=function(t,i){return this.x=t.x+i.x,this.y=t.y+i.y,this};r.prototype.addself=function(t){return this.x+=t.x,this.y+=t.y,this};r.prototype.sub=function(t,i){return this.x=t.x-i.x,this.y=t.y-i.y,this};r.prototype.subself=function(t){return this.x-=t.x,this.y-=t.y,this};r.prototype.scale=function(t){return this.x*=t,this.y*=t,this};r.prototype.scale2=function(t){return this.x*=t.x,this.y*=t.y,this};r.prototype.mad=function(t,i){this.x+=t.x*i,this.y+=t.y*i};r.prototype.neg=function(){return this.x*=-1,this.y*=-1,this};r.prototype.rcp=function(){return this.x=1/this.x,this.y=1/this.y,this};r.prototype.lengthsq=function(){return this.x*this.x+this.y*this.y};r.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};r.prototype.normalize=function(){var t=this.x!=0||this.y!=0?1/Math.sqrt(this.x*this.x+this.y*this.y):0;return this.x*=t,this.y*=t,this};r.prototype.dot=function(t){return this.x*t.x+this.y*t.y};r.prototype.cross=function(t){return this.x*t.y-this.y*t.x};r.prototype.toAngle=function(){return Math.atan2(this.y,this.x)};r.prototype.rotation=function(t){return this.x=Math.cos(t),this.y=Math.sin(t),this};r.prototype.rotate=function(t){var i=Math.cos(t),s=Math.sin(t);return this.set(this.x*i-this.y*s,this.x*s+this.y*i)};r.prototype.lerp=function(t,i,s){return this.add(r.scale(t,1-s),r.scale(i,s))};r.add=function(t,i){return new r(t.x+i.x,t.y+i.y)};r.sub=function(t,i){return new r(t.x-i.x,t.y-i.y)};r.scale=function(t,i){return new r(t.x*i,t.y*i)};r.scale2=function(t,i){return new r(t.x*i.x,t.y*i.y)};r.mad=function(t,i,s){return new r(t.x+i.x*s,t.y+i.y*s)};r.neg=function(t){return new r(-t.x,-t.y)};r.rcp=function(t){return new r(1/t.x,1/t.y)};r.normalize=function(t){var i=t.x!=0||t.y!=0?1/Math.sqrt(t.x*t.x+t.y*t.y):0;return new r(t.x*i,t.y*i)};r.dot=function(t,i){return t.x*i.x+t.y*i.y};r.cross=function(t,i){return t.x*i.y-t.y*i.x};r.toAngle=function(t){return Math.atan2(t.y,t.x)};r.rotation=function(t){return new r(Math.cos(t),Math.sin(t))};r.rotate=function(t,i){var s=Math.cos(i),e=Math.sin(i);return new r(t.x*s-t.y*e,t.x*e+t.y*s)};r.perp=function(t){return new r(-t.y,t.x)};r.rperp=function(t){return new r(t.y,-t.x)};r.dist=function(t,i){var s=i.x-t.x,e=i.y-t.y;return Math.sqrt(s*s+e*e)};r.distsq=function(t,i){var s=i.x-t.x,e=i.y-t.y;return s*s+e*e};r.lerp=function(t,i,s){return r.add(r.scale(t,1-s),r.scale(i,s))};r.truncate=function(t,i){var s=t.duplicate(),e=t.x*t.x+t.y*t.y;return e>i*i&&s.scale(i/Math.sqrt(e)),s};function S(t,i,s){this.x=t||0,this.y=i||0,this.z=s||0}S.zero=new S(0,0,0);S.prototype.toString=function(){return["x:",this.x,"y:",this.y,"z:",this.z].join(" ")};S.prototype.set=function(t,i,s){return this.x=t,this.y=i,this.z=s,this};S.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this};S.prototype.duplicate=function(){return new S(this.x,this.y,this.z)};S.prototype.equal=function(t){return!(this.x!=t.x||this.y!=t.y||this.z!=t.z)};S.prototype.add=function(t,i){return this.x=t.x+i.x,this.y=t.y+i.y,this.z=t.z+i.z,this};S.prototype.addself=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this};S.prototype.sub=function(t,i){return this.x=t.x-i.x,this.y=t.y-i.y,this.z=t.z-i.z,this};S.prototype.subself=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this};S.prototype.scale=function(t){return this.x*=t,this.y*=t,this.z*=t,this};S.prototype.mad=function(t,i){this.x+=t.x*i,this.y+=t.y*i,this.z+=t.z*i};S.prototype.neg=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this};S.prototype.rcp=function(){return this.x=1/this.x,this.y=1/this.y,this.z=1/this.z,this};S.prototype.lengthsq=function(){return this.x*this.x+this.y*this.y+this.z*this.z};S.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};S.prototype.normalize=function(){var t=this.x!=0||this.y!=0||this.z!=0?1/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z):0;return this.x*=t,this.y*=t,this.z*=t,this};S.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z};S.prototype.toVec2=function(){return new r(this.x,this.y)};S.fromVec2=function(t,i){return new S(t.x,t.y,i)};S.truncate=function(t,i){var s=t.duplicate(),e=t.x*t.x+t.y*t.y+t.z*t.z;return e>i*i&&s.scale(i/Math.sqrt(e)),s};function z(t,i,s,e){this._11=t||0,this._12=i||0,this._21=s||0,this._22=e||0}z.zero=new z(0,0,0,0);z.prototype.toString=function(){return["[",this._11,this._12,this_21,this._22,"]"].join(" ")};z.prototype.set=function(t,i,s,e){return this._11=t,this._12=i,this._21=s,this._22=e,this};z.prototype.copy=function(t){return this._11=t._11,this._12=t._12,this._21=t._21,this._22=t._22,this};z.prototype.duplicate=function(){return new z(this._11,this._12,this._21,this._22)};z.prototype.scale=function(t){return this._11*=t,this._12*=t,this._21*=t,this._22*=t,this};z.prototype.mul=function(t){return this.set(this._11*m2._11+this._12*m2._21,this._11*m2._12+this._12*m2._22,this._21*m2._11+this._22*m2._21,this._21*m2._12+this._22*m2._22)};z.prototype.mulvec=function(t){return new r(this._11*t.x+this._12*t.y,this._21*t.x+this._22*t.y)};z.prototype.invert=function(){var t=this._11*this._22-this._12*this._21;return t!=0&&(t=1/t),this.set(this._22*t,-this._12*t,-this._21*t,this._11*t)};z.prototype.solve=function(t){var i=this._11*this._22-this._12*this._21;return i!=0&&(i=1/i),new r(i*(this._22*t.x-this._12*t.y),i*(this._11*t.y-this._21*t.x))};z.mul=function(t,i){return new z(t._11*i._11+t._12*i._21,t._11*i._12+t._12*i._22,t._21*i._11+t._22*i._21,t._21*i._12+t._22*i._22)};function q(t,i,s,e,o,n,a,h,d){this._11=t||0,this._12=i||0,this._13=s||0,this._21=e||0,this._22=o||0,this._23=n||0,this._31=a||0,this._32=h||0,this._33=d||0}q.zero=new q(0,0,0,0,0,0,0,0,0);q.prototype.toString=function(){return["[",this._11,this._12,this._13,this_21,this._22,this._23,this._31,this._32,this._33,"]"].join(" ")};q.prototype.set=function(t,i,s,e,o,n,a,h,d){return this._11=t,this._12=i,this._13=s,this._21=e,this._22=o,this._23=n,this._31=a,this._32=h,this._33=d,this};q.prototype.copy=function(t){return this._11=t._11,this._12=t._12,this._13=t._13,this._21=t._21,this._22=t._22,this._23=t._23,this._31=t._31,this._32=t._32,this._33=t._33,this};q.prototype.duplicate=function(){return new q(this._11,this._12,this._13,this._21,this._22,this._23,this._31,this._32,this._33)};q.prototype.scale=function(t){return this._11*=t,this._12*=t,this._13*=t,this._21*=t,this._22*=t,this._23*=t,this._31*=t,this._32*=t,this._33*=t,this};q.prototype.mul=function(t){return this.set(this._11*m2._11+this._12*m2._21+this._13*m2._31,this._11*m2._12+this._12*m2._22+this._13*m2._32,this._11*m2._13+this._12*m2._23+this._13*m2._33,this._21*m2._11+this._22*m2._21+this._23*m2._31,this._21*m2._12+this._22*m2._22+this._23*m2._32,this._21*m2._13+this._22*m2._23+this._23*m2._33,this._31*m2._11+this._32*m2._21+this._33*m2._31,this._31*m2._12+this._32*m2._22+this._33*m2._32,this._31*m2._13+this._32*m2._23+this._33*m2._33)};q.prototype.mulvec=function(t){return new r(this._11*t.x+this._12*t.y+this._13*t.z,this._21*t.x+this._22*t.y+this._23*t.z,this._31*t.x+this._32*t.y+this._33*t.z)};q.prototype.invert=function(){var t=this._22*this._33-this._23*this._32,i=this._23*this._31-this._21*this._33,s=this._21*this._32-this._22*this._31,e=this._11*t+this._12*i+this._13*s;e!=0&&(e=1/e);var o=this._13*this._32-this._12*this._33,n=this._11*this._33-this._13*this._31,a=this._12*this._31-this._11*this._32,h=this._12*this._23-this._13*this._22,d=this._13*this._21-this._11*this._23,v=this._11*this._22-this._12*this._21;return this.set(t*e,i*e,s*e,o*e,n*e,a*e,h*e,d*e,v*e)};q.prototype.solve2x2=function(t){var i=this._11*this._22-this._12*this._21;return i!=0&&(i=1/i),new r(i*(this._22*t.x-this._12*t.y),i*(this._11*t.y-this._21*t.x))};q.prototype.solve=function(t){var i=this._22*this._33-this._23*this._32,s=this._23*this._31-this._21*this._33,e=this._21*this._32-this._22*this._31,o=this._11*i+this._12*s+this._13*e;o!=0&&(o=1/o);var n=this._13*this._32-this._12*this._33,a=this._11*this._33-this._13*this._31,h=this._12*this._31-this._11*this._32,d=this._12*this._23-this._13*this._22,v=this._13*this._21-this._11*this._23,p=this._11*this._22-this._12*this._21;return new S(o*(i*t.x+s*t.y+e*t.z),o*(n*t.x+a*t.y+h*t.z),o*(d*t.x+v*t.y+p*t.z))};q.mul=function(t,i){return new q(t._11*i._11+t._12*i._21+t._13*i._31,t._11*i._12+t._12*i._22+t._13*i._32,t._11*i._13+t._12*i._23+t._13*i._33,t._21*i._11+t._22*i._21+t._23*i._31,t._21*i._12+t._22*i._22+t._23*i._32,t._21*i._13+t._22*i._23+t._23*i._33,t._31*i._11+t._32*i._21+t._33*i._31,t._31*i._12+t._32*i._22+t._33*i._32,t._31*i._13+t._32*i._23+t._33*i._33)};var Z=function(t,i){this.t=t.duplicate(),this.c=Math.cos(i),this.s=Math.sin(i)};Z.prototype.set=function(t,i){return this.t.copy(t),this.c=Math.cos(i),this.s=Math.sin(i),this};Z.prototype.setRotation=function(t){return this.c=Math.cos(t),this.s=Math.sin(t),this};Z.prototype.setPosition=function(t){return this.t.copy(t),this};Z.prototype.identity=function(){return this.t.set(0,0),this.c=1,this.s=0,this};Z.prototype.rotate=function(t){return new r(t.x*this.c-t.y*this.s,t.x*this.s+t.y*this.c)};Z.prototype.unrotate=function(t){return new r(t.x*this.c+t.y*this.s,-t.x*this.s+t.y*this.c)};Z.prototype.transform=function(t){return new r(t.x*this.c-t.y*this.s+this.t.x,t.x*this.s+t.y*this.c+this.t.y)};Z.prototype.untransform=function(t){var i=t.x-this.t.x,s=t.y-this.t.y;return new r(i*this.c+s*this.s,-i*this.s+s*this.c)};var M=function(t,i){this.mins=t?new r(t.x,t.y):new r(999999,999999),this.maxs=i?new r(i.x,i.y):new r(-999999,-999999)};M.prototype.toString=function(){return["mins:",this.mins.toString(),"maxs:",this.maxs.toString()].join(" ")};M.prototype.set=function(t,i){this.mins.set(t.x,t.y),this.maxs.set(i.x,i.y)};M.prototype.copy=function(t){return this.mins.copy(t.mins),this.maxs.copy(t.maxs),this};M.prototype.clear=function(){return this.mins.set(999999,999999),this.maxs.set(-999999,-999999),this};M.prototype.isEmpty=function(){if(this.mins.x>this.maxs.x||this.mins.y>this.maxs.y)return!0};M.prototype.getCenter=function(){return r.scale(r.add(this.mins,this.maxs),.5)};M.prototype.getExtent=function(){return r.scale(r.sub(this.maxs,this.mins),.5)};M.prototype.getPerimeter=function(){return(maxs.x-mins.x+maxs.y-mins.y)*2};M.prototype.addPoint=function(t){return this.mins.x>t.x&&(this.mins.x=t.x),this.maxs.x<t.x&&(this.maxs.x=t.x),this.mins.y>t.y&&(this.mins.y=t.y),this.maxs.y<t.y&&(this.maxs.y=t.y),this};M.prototype.addBounds=function(t){return this.mins.x>t.mins.x&&(this.mins.x=t.mins.x),this.maxs.x<t.maxs.x&&(this.maxs.x=t.maxs.x),this.mins.y>t.mins.y&&(this.mins.y=t.mins.y),this.maxs.y<t.maxs.y&&(this.maxs.y=t.maxs.y),this};M.prototype.addBounds2=function(t,i){return this.mins.x>t.x&&(this.mins.x=t.x),this.maxs.x<i.x&&(this.maxs.x=i.x),this.mins.y>t.y&&(this.mins.y=t.y),this.maxs.y<i.y&&(this.maxs.y=i.y),this};M.prototype.addExtents=function(t,i,s){return this.mins.x>t.x-i&&(this.mins.x=t.x-i),this.maxs.x<t.x+i&&(this.maxs.x=t.x+i),this.mins.y>t.y-s&&(this.mins.y=t.y-s),this.maxs.y<t.y+s&&(this.maxs.y=t.y+s),this};M.prototype.expand=function(t,i){return this.mins.x-=t,this.mins.y-=i,this.maxs.x+=t,this.maxs.y+=i,this};M.prototype.containPoint=function(t){return!(t.x<this.mins.x||t.x>this.maxs.x||t.y<this.mins.y||t.y>this.maxs.y)};M.prototype.intersectsBounds=function(t){return!(this.mins.x>t.maxs.x||this.maxs.x<t.mins.x||this.mins.y>t.maxs.y||this.maxs.y<t.mins.y)};M.expand=function(e,i,s){var e=new M(e.mins,e.maxs);return e.expand(i,s),e};function ct(t,i,s,e){var o=t-s,n=i-e;return Math.sqrt(o*o+n*n)}var P=function(t){arguments.length!=0&&(P.id_counter==null&&(P.id_counter=0),this.id=P.id_counter++,this.type=t,this.e=0,this.u=1,this.density=1,this.bounds=new M)};P.TYPE_CIRCLE=0;P.TYPE_SEGMENT=1;P.TYPE_POLY=2;P.NUM_TYPES=3;var j={};(function(){var t=[];function i(u,c,m){t[u*P.NUM_TYPES+c]=m}function s(u,c,m,y,b){var x=c+y,w=r.sub(m,u),g=w.lengthsq();if(g>x*x)return 0;var E=Math.sqrt(g),R=r.mad(u,w,.5+(c-y)*.5/E),C=E!=0?r.scale(w,1/E):r.zero,K=E-x;return b.push(new G(R,C,K,0)),1}function e(u,c,m){return s(u.tc,u.r,c.tc,c.r,m)}function o(u,c,m){var y=u.r+c.r,b=r.dot(u.tc,c.tn)-r.dot(c.ta,c.tn),x=(b<0?b*-1:b)-y;if(x>0)return 0;var w=r.cross(u.tc,c.tn),g=r.cross(c.ta,c.tn),E=r.cross(c.tb,c.tn);if(w<g)return w<g-y?0:s(u.tc,u.r,c.ta,c.r,m);if(w>E)return w>E+y?0:s(u.tc,u.r,c.tb,c.r,m);var R=b>0?c.tn:r.neg(c.tn);return m.push(new G(r.mad(u.tc,R,-(u.r+x*.5)),r.neg(R),x,0)),1}function n(u,c,m){for(var y=-999999,b=-1,x=0;x<c.verts.length;x++){var w=c.tplanes[x],g=r.dot(u.tc,w.n)-w.d-u.r;if(g>0)return 0;g>y&&(y=g,b=x)}var E=c.tplanes[b].n,R=c.tverts[b],C=c.tverts[(b+1)%c.verts.length],K=r.cross(R,E),st=r.cross(C,E),ot=r.cross(u.tc,E);return ot>K?s(u.tc,u.r,R,0,m):ot<st?s(u.tc,u.r,C,0,m):(m.push(new G(r.mad(u.tc,E,-(u.r+y*.5)),r.neg(E),y,0)),1)}function a(u,c){var m=r.sub(c,u.ta),y=r.sub(u.tb,u.ta),b=m.dot(y);if(b<=0)return m.dot(m);var x=y.dot(y);return b>=x?m.dot(m)-2*b+x:m.dot(m)-b*b/x}function h(u,c,m){var y=[];y[0]=a(u,c.ta),y[1]=a(u,c.tb),y[2]=a(c,u.ta),y[3]=a(c,u.tb);var b=y[0]<y[1]?0:1,x=y[2]<y[3]?2:3,w=y[b]<y[x]?b:x,g,E,R=r.sub(u.tb,u.ta),C=r.sub(c.tb,c.ta);switch(w){case 0:g=r.dot(r.sub(c.ta,u.ta),R)/r.dot(R,R),g=g<0?0:g>1?1:g,E=0;break;case 1:g=r.dot(r.sub(c.tb,u.ta),R)/r.dot(R,R),g=g<0?0:g>1?1:g,E=1;break;case 2:g=0,E=r.dot(r.sub(u.ta,c.ta),C)/r.dot(C,C),E=E<0?0:E>1?1:E;break;case 3:g=1,E=r.dot(r.sub(u.tb,c.ta),C)/r.dot(C,C),E=E<0?0:E>1?1:E;break}var K=r.mad(u.ta,R,g),st=r.mad(c.ta,C,E);return s(K,u.r,st,c.r,m)}function d(u,c,m,y,b){for(var x=r.cross(c.tn,c.ta),w=r.cross(c.tn,c.tb),g=r.scale(c.tn,b),E=0;E<m.verts.length;E++){var R=m.tverts[E];if(r.dot(R,g)<r.dot(c.tn,c.ta)*b+c.r){var C=r.cross(c.tn,R);x>=C&&C>=w&&u.push(new G(R,g,y,m.id<<16|E))}}}function v(u,c,m){var y=r.dot(u.tn,u.ta),b=c.distanceOnPlane(u.tn,y)-u.r;if(b>0)return 0;var x=c.distanceOnPlane(r.neg(u.tn),-y)-u.r;if(x>0)return 0;for(var w=-999999,g=-1,E=0;E<c.verts.length;E++){var R=c.tplanes[E],C=u.distanceOnPlane(R.n,R.d);if(C>0)return 0;C>w&&(w=C,g=E)}var K=r.neg(c.tplanes[g].n),st=r.mad(u.ta,K,u.r),ot=r.mad(u.tb,K,u.r);if(c.containPoint(st)&&m.push(new G(st,K,w,u.id<<16|0)),c.containPoint(ot)&&m.push(new G(ot,K,w,u.id<<16|1)),w-=.1,(b>=w||x>=w)&&(b>x?d(m,u,c,b,1):d(m,u,c,x,-1)),m.length==0){var dt=c.tverts[g],ut=c.tverts[(g+1)%c.verts.length];if(s(u.ta,u.r,dt,0,m)||s(u.tb,u.r,dt,0,m)||s(u.ta,u.r,ut,0,m)||s(u.tb,u.r,ut,0,m))return 1}return m.length}function p(u,c,m){for(var y=-999999,b=-1,x=0;x<m;x++){var w=u.distanceOnPlane(c[x].n,c[x].d);if(w>0)return{dist:0,index:-1};w>y&&(y=w,b=x)}return{dist:y,index:b}}function _(u,c,m,y,b){for(var x=0,w=0;w<c.verts.length;w++){var g=c.tverts[w];m.containPointPartial(g,y)&&(u.push(new G(g,y,b,c.id<<16|w)),x++)}for(var w=0;w<m.verts.length;w++){var g=m.tverts[w];c.containPointPartial(g,y)&&(u.push(new G(g,y,b,m.id<<16|w)),x++)}return x}function f(u,c,m,y,b){for(var x=0,w=0;w<c.verts.length;w++){var g=c.tverts[w];m.containPoint(g)&&(u.push(new G(g,y,b,c.id<<16|w)),x++)}for(var w=0;w<m.verts.length;w++){var g=m.tverts[w];c.containPoint(g)&&(u.push(new G(g,y,b,m.id<<16|w)),x++)}return x>0?x:_(u,c,m,y,b)}function T(u,c,m){var y=p(c,u.tplanes,u.verts.length);if(y.index==-1)return 0;var b=p(u,c.tplanes,c.verts.length);return b.index==-1?0:y.dist>b.dist?f(m,u,c,u.tplanes[y.index].n,y.dist):f(m,u,c,r.neg(c.tplanes[b.index].n),b.dist)}j.init=function(){i(P.TYPE_CIRCLE,P.TYPE_CIRCLE,e),i(P.TYPE_CIRCLE,P.TYPE_SEGMENT,o),i(P.TYPE_CIRCLE,P.TYPE_POLY,n),i(P.TYPE_SEGMENT,P.TYPE_SEGMENT,h),i(P.TYPE_SEGMENT,P.TYPE_POLY,v),i(P.TYPE_POLY,P.TYPE_POLY,T)},j.collide=function(u,c,m){if(u.type>c.type){var y=u;u=c,c=y}return t[u.type*P.NUM_TYPES+c.type](u,c,m)}})();function vt(t,i){return Math.PI*(t*t-i*i)}function lt(t,i,s,e){return t*((s*s+e*e)*.5+i.lengthsq())}function mt(t,i,s){return s*(Math.PI*s+2*r.dist(t,i))}function pt(t,i){return r.scale(r.add(t,i),.5)}function ft(t,i,s){var e=r.distsq(s,i),o=r.scale(r.add(i,s),.5);return t*(e/12+o.lengthsq())}function yt(t){for(var i=0,s=0;s<t.length;s++)i+=r.cross(t[s],t[(s+1)%t.length]);return i/2}function _t(t){for(var i=0,s=new r(0,0),e=0;e<t.length;e++){var o=t[e],n=t[(e+1)%t.length],a=r.cross(o,n);i+=a,s.addself(r.scale(r.add(o,n),a))}return r.scale(s,1/(3*i))}function bt(t,i,s){for(var e=0,o=0,n=0;n<i.length;n++){var a=r.add(i[n],s),h=r.add(i[(n+1)%i.length],s),d=r.cross(h,a),v=r.dot(a,a)+r.dot(a,h)+r.dot(h,h);e+=d*v,o+=d}return t*e/(6*o)}var O=function(t,i,s){P.call(this,P.TYPE_CIRCLE),this.c=new r(t||0,i||0),this.r=s,this.tc=r.zero,this.finishVerts()};O.prototype=new P;O.prototype.constructor=O;O.prototype.finishVerts=function(){this.r=Math.abs(this.r)};O.prototype.duplicate=function(){return new O(this.c.x,this.c.y,this.r)};O.prototype.serialize=function(){return{type:"ShapeCircle",e:this.e,u:this.u,density:this.density,center:this.c,radius:this.r}};O.prototype.recenter=function(t){this.c.subself(t)};O.prototype.transform=function(t){this.c=t.transform(this.c)};O.prototype.untransform=function(t){this.c=t.untransform(this.c)};O.prototype.area=function(){return vt(this.r,0)};O.prototype.centroid=function(){return this.c.duplicate()};O.prototype.inertia=function(t){return lt(t,this.c,this.r,0)};O.prototype.cacheData=function(t){this.tc=t.transform(this.c),this.bounds.mins.set(this.tc.x-this.r,this.tc.y-this.r),this.bounds.maxs.set(this.tc.x+this.r,this.tc.y+this.r)};O.prototype.pointQuery=function(t){return r.distsq(this.tc,t)<this.r*this.r};O.prototype.findVertexByPoint=function(t,i){var s=i*i;return r.distsq(this.tc,t)<s?0:-1};O.prototype.distanceOnPlane=function(t,i){return r.dot(t,this.tc)-this.r-i};var N=function(t,i,s){P.call(this,P.TYPE_SEGMENT),this.a=t.duplicate(),this.b=i.duplicate(),this.r=s,this.n=r.perp(r.sub(i,t)),this.n.normalize(),this.ta=r.zero,this.tb=r.zero,this.tn=r.zero,this.finishVerts()};N.prototype=new P;N.prototype.constructor=N;N.prototype.finishVerts=function(){this.n=r.perp(r.sub(this.b,this.a)),this.n.normalize(),this.r=Math.abs(this.r)};N.prototype.duplicate=function(){return new N(this.a,this.b,this.r)};N.prototype.serialize=function(){return{type:"ShapeSegment",e:this.e,u:this.u,density:this.density,a:this.a,b:this.b,radius:this.r}};N.prototype.recenter=function(t){this.a.subself(t),this.b.subself(t)};N.prototype.transform=function(t){this.a=t.transform(this.a),this.b=t.transform(this.b)};N.prototype.untransform=function(t){this.a=t.untransform(this.a),this.b=t.untransform(this.b)};N.prototype.area=function(){return mt(this.a,this.b,this.r)};N.prototype.centroid=function(){return pt(this.a,this.b)};N.prototype.inertia=function(t){return ft(t,this.a,this.b)};N.prototype.cacheData=function(t){if(this.ta=t.transform(this.a),this.tb=t.transform(this.b),this.tn=r.perp(r.sub(this.tb,this.ta)).normalize(),this.ta.x<this.tb.x)var i=this.ta.x,s=this.tb.x;else var i=this.tb.x,s=this.ta.x;if(this.ta.y<this.tb.y)var e=this.ta.y,o=this.tb.y;else var e=this.tb.y,o=this.ta.y;this.bounds.mins.set(i-this.r,e-this.r),this.bounds.maxs.set(s+this.r,o+this.r)};N.prototype.pointQuery=function(t){if(!this.bounds.containPoint(t))return!1;var i=r.dot(this.tn,t)-r.dot(this.ta,this.tn),s=Math.abs(i);if(s>this.r)return!1;var e=r.cross(t,this.tn),o=r.cross(this.ta,this.tn),n=r.cross(this.tb,this.tn);return e<=o?e<o-this.r?!1:r.distsq(this.ta,t)<this.r*this.r:e>n?e>n+this.r?!1:r.distsq(this.tb,t)<this.r*this.r:!0};N.prototype.findVertexByPoint=function(t,i){var s=i*i;return r.distsq(this.ta,t)<s?0:r.distsq(this.tb,t)<s?1:-1};N.prototype.distanceOnPlane=function(t,i){var s=r.dot(t,this.ta)-this.r,e=r.dot(t,this.tb)-this.r;return Math.min(s,e)-i};var I=function(t){if(P.call(this,P.TYPE_POLY),this.verts=[],this.planes=[],this.tverts=[],this.tplanes=[],t)for(var i=0;i<t.length;i++)this.verts[i]=t[i].duplicate(),this.tverts[i]=this.verts[i],this.tplanes[i]={},this.tplanes[i].n=r.zero,this.tplanes[i].d=0;this.finishVerts()};I.prototype=new P;I.prototype.constructor=I;I.prototype.finishVerts=function(){if(this.verts.length<2){this.convexity=!1,this.planes=[];return}this.convexity=!0,this.tverts=[],this.tplanes=[];for(var t=0;t<this.verts.length;t++){var i=this.verts[t],s=this.verts[(t+1)%this.verts.length],e=r.normalize(r.perp(r.sub(i,s)));this.planes[t]={},this.planes[t].n=e,this.planes[t].d=r.dot(e,i),this.tverts[t]=this.verts[t],this.tplanes[t]={},this.tplanes[t].n=r.zero,this.tplanes[t].d=0}for(var t=0;t<this.verts.length;t++){var s=this.verts[(t+2)%this.verts.length],e=this.planes[t].n,o=this.planes[t].d;r.dot(e,s)-o>0&&(this.convexity=!1)}};I.prototype.duplicate=function(){return new I(this.verts)};I.prototype.serialize=function(){return{type:"ShapePoly",e:this.e,u:this.u,density:this.density,verts:this.verts}};I.prototype.recenter=function(t){for(var i=0;i<this.verts.length;i++)this.verts[i].subself(t)};I.prototype.transform=function(t){for(var i=0;i<this.verts.length;i++)this.verts[i]=t.transform(this.verts[i])};I.prototype.untransform=function(t){for(var i=0;i<this.verts.length;i++)this.verts[i]=t.untransform(this.verts[i])};I.prototype.area=function(){return yt(this.verts)};I.prototype.centroid=function(){return _t(this.verts)};I.prototype.inertia=function(t){return bt(t,this.verts,r.zero)};I.prototype.cacheData=function(t){this.bounds.clear();var i=this.verts.length;if(i!=0){for(var s=0;s<i;s++)this.tverts[s]=t.transform(this.verts[s]);if(i<2){this.bounds.addPoint(this.tverts[0]);return}for(var s=0;s<i;s++){var e=this.tverts[s],o=this.tverts[(s+1)%i],n=r.normalize(r.perp(r.sub(e,o)));this.tplanes[s].n=n,this.tplanes[s].d=r.dot(n,e),this.bounds.addPoint(e)}}};I.prototype.pointQuery=function(t){return this.bounds.containPoint(t)?this.containPoint(t):!1};I.prototype.findVertexByPoint=function(t,i){for(var s=i*i,e=0;e<this.tverts.length;e++)if(r.distsq(this.tverts[e],t)<s)return e;return-1};I.prototype.findEdgeByPoint=function(t,i){for(var s=i*i,e=this.tverts.length,o=0;o<this.tverts.length;o++){var n=this.tverts[o],a=this.tverts[(o+1)%e],h=this.tplanes[o].n,d=r.cross(n,h),v=r.cross(a,h),p=r.cross(t,h);if(p>d){if(r.distsq(n,t)<s)return o}else if(p<v){if(r.distsq(a,t)<s)return o}else{var _=r.dot(h,t)-r.dot(h,n);if(_*_<s)return o}}return-1};I.prototype.distanceOnPlane=function(t,i){for(var s=999999,e=0;e<this.verts.length;e++)s=Math.min(s,r.dot(t,this.tverts[e]));return s-i};I.prototype.containPoint=function(t){for(var i=0;i<this.verts.length;i++){var s=this.tplanes[i];if(r.dot(s.n,t)-s.d>0)return!1}return!0};I.prototype.containPointPartial=function(t,i){for(var s=0;s<this.verts.length;s++){var e=this.tplanes[s];if(!(r.dot(e.n,i)<1e-4)&&r.dot(e.n,t)-e.d>0)return!1}return!0};var xt=function(t,i,s){var e=[new r(t.x,t.y),new r(i.x,i.y),new r(s.x,s.y)];return new I(e)},wt=function(t,i,s,e){t=t||0,i=i||0;var o=s*.5,n=e*.5,a=[new r(-o+t,+n+i),new r(-o+t,-n+i),new r(+o+t,-n+i),new r(+o+t,+n+i)];return new I(a)};var A=function(t,i,s){A.id_counter==null&&(A.id_counter=0),this.id=A.id_counter++,this.name="body"+this.id,this.type=t,i=i||new r(0,0),s=s||0,this.xf=new Z(i,s),this.centroid=new r(0,0),this.p=new r(i.x,i.y),this.v=new r(0,0),this.f=new r(0,0),this.a=s,this.w=0,this.t=0,this.linearDamping=0,this.angularDamping=0,this.sleepTime=0,this.awaked=!1,this.shapeArr=[],this.jointArr=[],this.jointHash={},this.bounds=new M,this.fixedRotation=!1,this.categoryBits=1,this.maskBits=65535,this.stepCount=0};A.STATIC=0;A.KINETIC=1;A.DYNAMIC=2;A.prototype.duplicate=function(){for(var t=new A(this.type,this.xf.t,this.a),i=0;i<this.shapeArr.length;i++)t.addShape(this.shapeArr[i].duplicate());return t.resetMassData(),t};A.prototype.serialize=function(){for(var t=[],i=0;i<this.shapeArr.length;i++){var s=this.shapeArr[i].serialize();t.push(s)}return{type:["static","kinetic","dynamic"][this.type],name:this.name,position:this.xf.t,angle:this.xf.a,shapes:t}};A.prototype.isStatic=function(){return this.type==A.STATIC};A.prototype.isDynamic=function(){return this.type==A.DYNAMIC};A.prototype.isKinetic=function(){return this.type==A.KINETIC};A.prototype.setType=function(t){t!=this.type&&(this.f.set(0,0),this.v.set(0,0),this.t=0,this.w=0,this.type=t,this.awake(!0))};A.prototype.addShape=function(t){t.body=this,this.shapeArr.push(t)};A.prototype.removeShape=function(t){var i=this.shapeArr.indexOf(t);i!=-1&&(this.shapeArr.splice(i,1),t.body=void 0)};A.prototype.setMass=function(t){this.m=t,this.m_inv=t>0?1/t:0};A.prototype.setInertia=function(t){this.i=t,this.i_inv=t>0?1/t:0};A.prototype.setTransform=function(t,i){this.xf.set(t,i),this.p=this.xf.transform(this.centroid),this.a=i};A.prototype.syncTransform=function(){this.xf.setRotation(this.a),this.xf.setPosition(r.sub(this.p,this.xf.rotate(this.centroid)))};A.prototype.getWorldPoint=function(t){return this.xf.transform(t)};A.prototype.getWorldVector=function(t){return this.xf.rotate(t)};A.prototype.getLocalPoint=function(t){return this.xf.untransform(t)};A.prototype.getLocalVector=function(t){return this.xf.unrotate(t)};A.prototype.setFixedRotation=function(t){this.fixedRotation=t,this.resetMassData()};A.prototype.resetMassData=function(){if(this.centroid.set(0,0),this.m=0,this.m_inv=0,this.i=0,this.i_inv=0,!this.isDynamic()){this.p=this.xf.transform(this.centroid);return}for(var t=new r(0,0),i=0,s=0,e=0;e<this.shapeArr.length;e++){var o=this.shapeArr[e],n=o.centroid(),a=o.area()*o.density,h=o.inertia(a);t.mad(n,a),i+=a,s+=h}this.centroid.copy(r.scale(t,1/i)),this.setMass(i),this.fixedRotation||this.setInertia(s-i*r.dot(this.centroid,this.centroid));var d=this.p;this.p=this.xf.transform(this.centroid),this.v.mad(r.perp(r.sub(this.p,d)),this.w)};A.prototype.resetJointAnchors=function(){for(var t=0;t<this.jointArr.length;t++){var i=this.jointArr[t];if(i){var s=i.getWorldAnchor1(),e=i.getWorldAnchor2();i.setWorldAnchor1(s),i.setWorldAnchor2(e)}}};A.prototype.cacheData=function(){this.bounds.clear();for(var t=0;t<this.shapeArr.length;t++){var i=this.shapeArr[t];i.cacheData(this.xf),this.bounds.addBounds(i.bounds)}};A.prototype.updateVelocity=function(t,i,s){this.v=r.mad(this.v,r.mad(t,this.f,this.m_inv),i),this.w=this.w+this.t*this.i_inv*i,this.v.scale(Math.clamp(1-i*(s+this.linearDamping),0,1)),this.w*=Math.clamp(1-i*(s+this.angularDamping),0,1),this.f.set(0,0),this.t=0};A.prototype.updatePosition=function(t){this.p.addself(r.scale(this.v,t)),this.a+=this.w*t};A.prototype.resetForce=function(){this.f.set(0,0),this.t=0};A.prototype.applyForce=function(t,i){this.isDynamic()&&(this.isAwake()||this.awake(!0),this.f.addself(t),this.t+=r.cross(r.sub(i,this.p),t))};A.prototype.applyForceToCenter=function(t){this.isDynamic()&&(this.isAwake()||this.awake(!0),this.f.addself(t))};A.prototype.applyTorque=function(t){this.isDynamic()&&(this.isAwake()||this.awake(!0),this.t+=t)};A.prototype.applyLinearImpulse=function(t,i){this.isDynamic()&&(this.isAwake()||this.awake(!0),this.v.mad(t,this.m_inv),this.w+=r.cross(r.sub(i,this.p),t)*this.i_inv)};A.prototype.applyAngularImpulse=function(t){this.isDynamic()&&(this.isAwake()||this.awake(!0),this.w+=t*this.i_inv)};A.prototype.kineticEnergy=function(){var t=this.v.dot(this.v),i=this.w*this.w;return .5*(this.m*t+this.i*i)};A.prototype.isAwake=function(){return this.awaked};A.prototype.awake=function(t){this.awaked=t,t?this.sleepTime=0:(this.v.set(0,0),this.w=0,this.f.set(0,0),this.t=0)};A.prototype.isCollidable=function(t){if(this==t||!this.isDynamic()&&!t.isDynamic()||!(this.maskBits&t.categoryBits)||!(t.maskBits&this.categoryBits))return!1;for(var i=0;i<this.jointArr.length;i++){var s=this.jointArr[i];if(s&&!s.collideConnected&&t.jointHash[s.id]!=null)return!1}return!0};var l=function(t,i,s,e){arguments.length!=0&&(l.id_counter==null&&(l.id_counter=0),this.id=l.id_counter++,this.type=t,this.body1=i,this.body2=s,this.collideConnected=e,this.maxForce=9999999999,this.breakable=!1)};l.TYPE_ANGLE=0;l.TYPE_REVOLUTE=1;l.TYPE_WELD=2;l.TYPE_WHEEL=3;l.TYPE_PRISMATIC=4;l.TYPE_DISTANCE=5;l.TYPE_ROPE=6;l.TYPE_MOUSE=7;l.LINEAR_SLOP=8e-4;l.ANGULAR_SLOP=it(2);l.MAX_LINEAR_CORRECTION=.5;l.MAX_ANGULAR_CORRECTION=it(8);l.LIMIT_STATE_INACTIVE=0;l.LIMIT_STATE_AT_LOWER=1;l.LIMIT_STATE_AT_UPPER=2;l.LIMIT_STATE_EQUAL_LIMITS=3;l.prototype.getWorldAnchor1=function(){return this.body1.getWorldPoint(this.anchor1)};l.prototype.getWorldAnchor2=function(){return this.body2.getWorldPoint(this.anchor2)};l.prototype.setWorldAnchor1=function(t){this.anchor1=this.body1.getLocalPoint(t)};l.prototype.setWorldAnchor2=function(t){this.anchor2=this.body2.getLocalPoint(t)};function J(t,i){this.shape1=t,this.shape2=i,this.contactArr=[],this.e=1,this.u=1}J.COLLISION_SLOP=8e-4;J.BAUMGARTE=.28;J.MAX_LINEAR_CORRECTION=1;J.prototype.update=function(t){for(var i=0;i<t.length;i++){for(var s=t[i],e=-1,o=0;o<this.contactArr.length;o++)if(s.hash==this.contactArr[o].hash){e=o;break}e>-1&&(s.lambda_n_acc=this.contactArr[e].lambda_n_acc,s.lambda_t_acc=this.contactArr[e].lambda_t_acc)}this.contactArr=t};J.prototype.initSolver=function(t){for(var i=this.shape1.body,s=this.shape2.body,e=i.m_inv+s.m_inv,o=0;o<this.contactArr.length;o++){var n=this.contactArr[o];n.r1=r.sub(n.p,i.p),n.r2=r.sub(n.p,s.p),n.r1_local=i.xf.unrotate(n.r1),n.r2_local=s.xf.unrotate(n.r2);var a=n.n,h=r.perp(n.n),d=r.cross(n.r1,a),v=r.cross(n.r2,a),p=e+i.i_inv*d*d+s.i_inv*v*v;n.emn=p==0?0:1/p;var _=r.cross(n.r1,h),f=r.cross(n.r2,h),T=e+i.i_inv*_*_+s.i_inv*f*f;n.emt=T==0?0:1/T;var u=r.mad(i.v,r.perp(n.r1),i.w),c=r.mad(s.v,r.perp(n.r2),s.w),m=r.sub(c,u);n.bounce=r.dot(m,n.n)*this.e}};J.prototype.warmStart=function(){for(var t=this.shape1.body,i=this.shape2.body,s=0;s<this.contactArr.length;s++){var e=this.contactArr[s],o=e.n,n=e.lambda_n_acc,a=e.lambda_t_acc,h=new r(n*o.x-a*o.y,a*o.x+n*o.y);t.v.mad(h,-t.m_inv),t.w-=r.cross(e.r1,h)*t.i_inv,i.v.mad(h,i.m_inv),i.w+=r.cross(e.r2,h)*i.i_inv}};J.prototype.solveVelocityConstraints=function(){for(var t=this.shape1.body,i=this.shape2.body,s=t.m_inv,e=t.i_inv,o=i.m_inv,n=i.i_inv,a=0;a<this.contactArr.length;a++){var h=this.contactArr[a],d=h.n,v=r.perp(d),p=h.r1,_=h.r2,f=r.mad(t.v,r.perp(p),t.w),T=r.mad(i.v,r.perp(_),i.w),u=r.sub(T,f),c=-h.emn*(r.dot(d,u)+h.bounce),m=h.lambda_n_acc;h.lambda_n_acc=Math.max(m+c,0),c=h.lambda_n_acc-m;var y=-h.emt*r.dot(v,u),b=h.lambda_n_acc*this.u,x=h.lambda_t_acc;h.lambda_t_acc=Math.clamp(x+y,-b,b),y=h.lambda_t_acc-x;var w=new r(c*d.x-y*d.y,y*d.x+c*d.y);t.v.mad(w,-s),t.w-=r.cross(p,w)*e,i.v.mad(w,o),i.w+=r.cross(_,w)*n}};J.prototype.solvePositionConstraints=function(){for(var t=this.shape1.body,i=this.shape2.body,s=t.m_inv,e=t.i_inv,o=i.m_inv,n=i.i_inv,a=s+o,h=0,d=0;d<this.contactArr.length;d++){var v=this.contactArr[d],p=v.n,_=r.rotate(v.r1_local,t.a),f=r.rotate(v.r2_local,i.a),T=r.add(t.p,_),u=r.add(i.p,f),c=r.sub(u,T),m=r.dot(c,p)+v.d,y=Math.clamp(J.BAUMGARTE*(m+J.COLLISION_SLOP),-J.MAX_LINEAR_CORRECTION,0);if(y!=0){h=Math.max(h,-m);var b=r.cross(_,p),x=r.cross(f,p),w=a+t.i_inv*b*b+i.i_inv*x*x,g=w==0?0:-y/w,E=r.scale(p,g);t.p.mad(E,-s),t.a-=b*g*e,i.p.mad(E,o),i.a+=x*g*n}}return h<=J.COLLISION_SLOP*3};var W={};function L(){this.bodyArr=[],this.bodyHash={},this.jointArr=[],this.jointHash={},this.numContacts=0,this.contactSolverArr=[],this.postSolve=function(t){},this.gravity=new r(0,0),this.damping=0}L.TIME_TO_SLEEP=.5;L.SLEEP_LINEAR_TOLERANCE=.5;L.SLEEP_ANGULAR_TOLERANCE=it(2);L.prototype.clear=function(){P.id_counter=0,A.id_counter=0,l.id_counter=0;for(var t=0;t<this.bodyArr.length;t++)this.bodyArr[t]&&this.removeBody(this.bodyArr[t]);this.bodyArr=[],this.bodyHash={},this.jointArr=[],this.jointHash={},this.contactSolverArr=[],this.stepCount=0};L.prototype.toJSON=function(t){for(var i=[],s=0;s<this.bodyArr.length;s++)this.bodyArr[s]&&i.push(this.bodyArr[s].serialize());for(var e=[],s=0;s<this.jointArr.length;s++)this.jointArr[s]&&e.push(this.jointHash[s].serialize());return{bodies:i,joints:e}};L.prototype.create=function(t){var i=JSON.parse(t);this.clear();for(var s=0;s<i.bodies.length;s++){for(var e=i.bodies[s],o={static:A.Static,kinetic:A.KINETIC,dynamic:A.DYNAMIC}[e.type],n=new A(o,e.position.x,e.position.y,e.angle),a=0;a<e.shapes.length;a++){var h=e.shapes[a],d;switch(h.type){case"ShapeCircle":d=new O(h.center.x,h.center.y,h.radius);break;case"ShapeSegment":d=new N(h.a,h.b,h.radius);break;case"ShapePoly":d=new I(h.verts);break}d.e=h.e,d.u=h.u,d.density=h.density,n.addShape(d)}n.resetMassData(),this.addBody(n)}for(var s=0;s<i.joints.length;s++){var v=i.joints[s],p=this.bodyArr[this.bodyHash[v.body1]],_=this.bodyArr[this.bodyHash[v.body2]],f;switch(v.type){case"AngleJoint":f=new AngleJoint(p,_);break;case"RevoluteJoint":f=new RevoluteJoint(p,_,v.anchor),f.enableLimit(v.limitEnabled),f.setLimits(v.limitLowerAngle,v.limitUpperAngle),f.enableMotor(v.motorEnabled),f.setMotorSpeed(v.motorSpeed),f.setMaxMotorTorque(v.maxMotorTorque);break;case"WeldJoint":f=new WeldJoint(p,_,v.anchor),f.setSpringFrequencyHz(v.frequencyHz),f.setSpringDampingRatio(v.dampingRatio);break;case"WheelJoint":f=new WheelJoint(p,_,v.anchor1,v.anchor2),f.enableMotor(v.motorEnabled),f.setMotorSpeed(v.motorSpeed),f.setMaxMotorTorque(v.maxMotorTorque);break;case"PrismaticJoint":f=new PrismaticJoint(p,_,v.anchor1,v.anchor2);break;case"DistanceJoint":f=new DistanceJoint(p,_,v.anchor1,v.anchor2),f.setSpringFrequencyHz(v.frequencyHz),f.setSpringDampingRatio(v.dampingRatio);break;case"RopeJoint":f=new RopeJoint(p,_,v.anchor1,v.anchor2);break}f.collideConnected=v.collideConnected,f.maxForce=v.maxForce,f.breakable=v.breakable,this.addJoint(f)}};L.prototype.addBody=function(t){if(this.bodyHash[t.id]==null){var i=this.bodyArr.push(t)-1;this.bodyHash[t.id]=i,t.awake(!0),t.world=this,t.cacheData()}};L.prototype.removeBody=function(t){if(this.bodyHash[t.id]!=null){for(var i=0;i<t.jointArr.length;i++)t.jointArr[i]&&this.removeJoint(t.jointArr[i]);t.world=null;var s=this.bodyHash[t.id];delete this.bodyHash[t.id],delete this.bodyArr[s]}};L.prototype.addJoint=function(t){if(this.jointHash[t.id]==null){t.body1.awake(!0),t.body2.awake(!0);var i=this.jointArr.push(t)-1;this.jointHash[t.id]=i;var i=t.body1.jointArr.push(t)-1;t.body1.jointHash[t.id]=i;var i=t.body2.jointArr.push(t)-1;t.body2.jointHash[t.id]=i}};L.prototype.removeJoint=function(t){if(this.jointHash[t.id]!=null){t.body1.awake(!0),t.body2.awake(!0);var i=t.body1.jointHash[t.id];delete t.body1.jointHash[t.id],delete t.body1.jointArr[i];var i=t.body2.jointHash[t.id];delete t.body2.jointHash[t.id],delete t.body2.jointArr[i];var i=this.jointHash[t.id];delete this.jointHash[t.id],delete this.jointArr[i]}};L.prototype.findShapeByPoint=function(t,i){for(var s,e=0;e<this.bodyArr.length;e++){var o=this.bodyArr[e];if(o)for(var n=0;n<o.shapeArr.length;n++){var a=o.shapeArr[n];if(a.pointQuery(t)){if(!i)return a;s||(s=a),a==i&&(i=null)}}}return s};L.prototype.findBodyByPoint=function(t,i){for(var s,e=0;e<this.bodyArr.length;e++){var o=this.bodyArr[e];if(o)for(var n=0;n<o.shapeArr.length;n++){var a=o.shapeArr[n];if(a.pointQuery(t)){if(!i)return a.body;s||(s=a.body),a.body==i&&(i=null);break}}}return s};L.prototype.shapeById=function(t){for(var i,s=0;s<this.bodyArr.length;s++){var e=this.bodyArr[s];if(e){for(var o=0;o<e.shapeArr.length;o++)if(e.shapeArr[o].id==t)return e.shapeArr[o]}}return null};L.prototype.jointById=function(t){var i=this.jointHash[t];return i!=null?this.jointArr[i]:null};L.prototype.findVertexByPoint=function(t,i,s){var e=-1;s=s||-1;for(var o=0;o<this.bodyArr.length;o++){var n=this.bodyArr[o];if(n)for(var a=0;a<n.shapeArr.length;a++){var h=n.shapeArr[a],d=h.findVertexByPoint(t,i);if(d!=-1){var v=h.id<<16|d;if(s==-1)return v;e==-1&&(e=v),v==s&&(s=-1)}}}return e};L.prototype.findEdgeByPoint=function(t,i,s){var e=-1;s=s||-1;for(var o=0;o<this.bodyArr.length;o++){var n=this.bodyArr[o];if(n)for(var a=0;a<n.shapeArr.length;a++){var h=n.shapeArr[a];if(h.type==P.TYPE_POLY){var d=h.findEdgeByPoint(t,i);if(d!=-1){var v=h.id<<16|d;if(s==-1)return v;e==-1&&(e=v),v==s&&(s=-1)}}}}return e};L.prototype.findJointByPoint=function(t,i,s){var e=-1,o=i*i;s=s||-1;for(var n=0;n<this.jointArr.length;n++){var a=this.jointArr[n];if(a){var h=-1;if(r.distsq(t,a.getWorldAnchor1())<o?h=a.id<<16|0:r.distsq(t,a.getWorldAnchor2())<o&&(h=a.id<<16|1),h!=-1){if(s==-1)return h;e==-1&&(e=h),h==s&&(s=-1)}}}return e};L.prototype.findContactSolver=function(t,i){for(var s=0;s<this.contactSolverArr.length;s++){var e=this.contactSolverArr[s];if(t==e.shape1&&i==e.shape2)return e}return null};L.prototype.genTemporalContactSolvers=function(){var t=Date.now(),i=[];this.numContacts=0;for(var s=0;s<this.bodyArr.length;s++){var e=this.bodyArr[s];if(e){e.stepCount=this.stepCount;for(var o=0;o<this.bodyArr.length;o++){var n=this.bodyArr[o];if(n&&e.stepCount!=n.stepCount){var a=e.isAwake()&&!e.isStatic(),h=n.isAwake()&&!n.isStatic();if(!(!a&&!h)&&e.isCollidable(n)&&e.bounds.intersectsBounds(n.bounds))for(var d=0;d<e.shapeArr.length;d++)for(var v=0;v<n.shapeArr.length;v++){var p=e.shapeArr[d],_=n.shapeArr[v],f=[];if(j.collide(p,_,f)){if(p.type>_.type){var T=p;p=_,_=T}this.numContacts+=f.length;var u=this.findContactSolver(p,_);if(u)u.update(f),i.push(u);else{e.awake(!0),n.awake(!0);var c=new J(p,_);c.contactArr=f,c.e=Math.max(p.e,_.e),c.u=Math.sqrt(p.u*_.u),i.push(c)}}}}}}}return W.timeCollision=Date.now()-t,i};L.prototype.initSolver=function(t,i,s){for(var e=Date.now(),o=0;o<this.contactSolverArr.length;o++)this.contactSolverArr[o].initSolver(i);for(var o=0;o<this.jointArr.length;o++)this.jointArr[o]&&this.jointArr[o].initSolver(t,s);if(s)for(var o=0;o<this.contactSolverArr.length;o++)this.contactSolverArr[o].warmStart();W.timeInitSolver=Date.now()-e};L.prototype.velocitySolver=function(t){for(var i=Date.now(),s=0;s<t;s++){for(var e=0;e<this.jointArr.length;e++)this.jointArr[e]&&this.jointArr[e].solveVelocityConstraints();for(var e=0;e<this.contactSolverArr.length;e++)this.contactSolverArr[e].solveVelocityConstraints()}W.timeVelocitySolver=Date.now()-i};L.prototype.positionSolver=function(t){var i=Date.now(),s=!1;W.positionIterations=0;for(var e=0;e<t;e++){for(var o=!0,n=!0,a=0;a<this.contactSolverArr.length;a++){var h=this.contactSolverArr[a].solvePositionConstraints();o=h&&o}for(var a=0;a<this.jointArr.length;a++)if(this.jointArr[a]){var d=this.jointArr[a].solvePositionConstraints();n=d&&n}if(o&&n){s=!0;break}W.positionIterations++}return W.timePositionSolver=Date.now()-i,s};L.prototype.step=function(t,i,s,e,o){var n=1/t;this.stepCount++,this.contactSolverArr=this.genTemporalContactSolvers(),this.initSolver(t,n,e);for(var a=0;a<this.bodyArr.length;a++){var h=this.bodyArr[a];h&&h.isDynamic()&&h.isAwake()&&h.updateVelocity(this.gravity,t,this.damping)}for(var a=0;a<this.jointArr.length;a++){var d=this.jointArr[a];if(d){var v=d.body1,p=d.body2,_=v.isAwake()&&!v.isStatic(),f=p.isAwake()&&!p.isStatic();_^f&&(_||v.awake(!0),f||p.awake(!0))}}this.velocitySolver(i);for(var a=0;a<this.bodyArr.length;a++){var h=this.bodyArr[a];h&&h.isDynamic()&&h.isAwake()&&h.updatePosition(t)}for(var a=0;a<this.jointArr.length;a++){var d=this.jointArr[a];d&&d.breakable&&d.getReactionForce(n).lengthsq()>=d.maxForce*d.maxForce&&this.removeJoint(d)}for(var T=this.positionSolver(s),a=0;a<this.bodyArr.length;a++){var h=this.bodyArr[a];h&&h.syncTransform()}for(var a=0;a<this.contactSolverArr.length;a++){var u=this.contactSolverArr[a];this.postSolve(u)}for(var a=0;a<this.bodyArr.length;a++){var h=this.bodyArr[a];h&&h.isDynamic()&&h.isAwake()&&h.cacheData()}if(o){for(var c=999999,m=L.SLEEP_LINEAR_TOLERANCE*L.SLEEP_LINEAR_TOLERANCE,y=L.SLEEP_ANGULAR_TOLERANCE*L.SLEEP_ANGULAR_TOLERANCE,a=0;a<this.bodyArr.length;a++){var h=this.bodyArr[a];h&&h.isDynamic()&&(h.w*h.w>y||h.v.dot(h.v)>m?(h.sleepTime=0,c=0):(h.sleepTime+=t,c=Math.min(c,h.sleepTime)))}if(T&&c>=L.TIME_TO_SLEEP)for(var a=0;a<this.bodyArr.length;a++){var h=this.bodyArr[a];h&&h.awake(!1)}}};var Y=function(t,i,s){arguments.length!=0&&(l.call(this,l.TYPE_MOUSE,t,i,!0),this.anchor1=this.body1.getLocalPoint(s),this.anchor2=this.body2.getLocalPoint(s),this.gamma=0,this.beta_c=0,this.frequencyHz=5,this.dampingRatio=.9,this.lambda_acc=new r(0,0))};Y.prototype=new l;Y.prototype.constructor=Y;Y.prototype.setSpringFrequencyHz=function(t){this.frequencyHz=t};Y.prototype.setSpringDampingRatio=function(t){this.dampingRatio=t};Y.prototype.initSolver=function(t,i){var s=this.body1,e=this.body2;this.maxImpulse=this.maxForce*t;var o=2*Math.PI*this.frequencyHz,n=e.m*(o*o),a=e.m*2*this.dampingRatio*o;this.gamma=(a+n*t)*t,this.gamma=this.gamma==0?0:1/this.gamma;var h=t*n*this.gamma;this.r2=e.xf.rotate(r.sub(this.anchor2,e.centroid));var d=this.r2,v=d.y*e.i_inv,p=e.m_inv+d.y*v+this.gamma,_=-d.x*v,f=e.m_inv+d.x*d.x*e.i_inv+this.gamma;this.em_inv=new z(p,_,_,f);var T=r.sub(r.add(e.p,this.r2),s.p);this.beta_c=r.scale(T,h),e.w*=.98,i?(e.v.mad(this.lambda_acc,e.m_inv),e.w+=r.cross(this.r2,this.lambda_acc)*e.i_inv):this.lambda_acc.set(0,0)};Y.prototype.solveVelocityConstraints=function(){var t=this.body2,i=r.mad(t.v,r.perp(this.r2),t.w),s=r.mad(this.beta_c,this.lambda_acc,this.gamma),e=this.em_inv.solve(r.add(i,s).neg()),o=this.lambda_acc.duplicate();this.lambda_acc.addself(e);var n=this.lambda_acc.lengthsq();n>this.maxImpulse*this.maxImpulse&&this.lambda_acc.scale(this.maxImpulse/Math.sqrt(n)),e=r.sub(this.lambda_acc,o),t.v.mad(e,t.m_inv),t.w+=r.cross(this.r2,e)*t.i_inv};Y.prototype.solvePositionConstraints=function(){return!0};Y.prototype.getReactionForce=function(t){return r.scale(this.lambda_acc,t)};Y.prototype.getReactionTorque=function(t){return 0};var at=nt(2.5),et=nt(1),gt=["#BEB","#48B","#CAA","#8D5","#6BE","#98D","#E78","#7BC","#E9E","#BCD","#EB6","#EE7"];function At(t){return t.isDynamic()?t.isAwake()?gt[t.id%gt.length]:"#999":"#777"}var ht=Symbol("app"),tt=Symbol("pause"),Tt=(t,i,s,e)=>Object.defineProperty(t,i,{get(){return this[s]},set:e});function Q(t,i,s={}){this.renderer=t,this[ht]=i,this.settings=Object.assign({gravity:new r(0,-10),frameRateHz:60,velocityIterations:8,positionIterations:4,warmStarting:!0,allowSleep:!0,enableDirtyBounds:!0,showJoints:!0,backgroundColor:"rgb(95, 105, 118)",jointAnchorColor:"#11cf00"},s),this.camera={origin:new r(0,0),scale:1,minScale:.5,maxScale:8,bounds:new M,scroll:new r(0,0)},this.dirtyBounds=new M,this.onResize=()=>{this.renderer.resize(),this.dirtyBounds.set(this.canvasToWorld(new r(0,this.renderer.height)),this.canvasToWorld(new r(this.renderer.width,0))),this.static_outdated=!0,this[tt]&&this.drawFrame(0)},window.addEventListener("resize",this.onResize),window.addEventListener("orientationchange",this.onResize),this.onResize(),j.init(),this.world=new L,this.resetScene(),Tt(this,"app",ht,e=>{this[ht]=e,this.resetScene(),this[tt]&&this.start()}),Tt(this,"pause",tt,e=>{e?this[tt]=!0:this.start()}),this.start()}Q.prototype.start=function(){this[tt]=!1;let t=()=>{this.runFrame(),this[tt]||window.requestAnimationFrame(t)};window.requestAnimationFrame(t)};Q.prototype.destroy=function(){window.removeEventListener("resize",this.onResize),window.removeEventListener("orientationchange",this.onResize),this[tt]=!0,this.world.clear()};Q.prototype.resetScene=function(){this.world.clear(),this.world.gravity.copy(this.settings.gravity),this[ht].init(this.world),this.initFrame()};Q.prototype.initFrame=function(){this.time={fps:0,fps_frameCount:0,fps_time:0,frameCount:0,lastTime:Date.now(),timeDelta:0},this.dirtyBounds.set(this.canvasToWorld(new r(0,this.renderer.height)),this.canvasToWorld(new r(this.renderer.width,0))),this.static_outdated=!0};Q.prototype.runFrame=function(){var t=Date.now(),i=(t-this.time.lastTime)/1e3;if(i=Math.floor(i*60+.5)/60,this.time.lastTime=t,!this[tt]||this.step){var s=1/this.settings.frameRateHz;this.time.timeDelta+=i,this.step&&(this.step=!1,this.time.timeDelta=s),W.timeStep=0,W.stepCount=0;for(var e=4;e>0&&this.time.timeDelta>=s;e--){var o=Date.now();this.world.step(s,this.settings.velocityIterations,this.settings.positionIterations,this.settings.warmStarting,this.settings.allowSleep),W.timeStep+=Date.now()-o,W.stepCount++,this.time.timeDelta-=s}this.time.timeDelta>s&&(this.time.timeDelta=0),this[ht].runFrame()}W.stepCount>0&&this.render(i),this.time.frameCount++,this.time.fps_frameCount++,this.time.fps_time+=i,this.time.fps_time>=1&&(this.time.fps=this.time.fps_frameCount/this.time.fps_time,this.time.fps_time-=1,this.time.fps_frameCount=0)};Q.prototype.render=function(t){var i=Date.now();this.drawFrame(t),W.timeDrawFrame=Date.now()-i};Q.prototype.drawFrame=function(t){this.camera.bounds.set(this.canvasToWorld(new r(0,this.renderer.height)),this.canvasToWorld(new r(this.renderer.width,0)));for(var i=0;i<this.world.bodyArr.length;i++){var s=this.world.bodyArr[i];s.visible=!1;for(var e=0;e<s.shapeArr.length;e++){var o=s.shapeArr[e],n=new M(o.bounds.mins,o.bounds.maxs);this.camera.bounds.intersectsBounds(n)?(o.visible=!0,s.visible=!0):o.visible=!1}}if(this.static_outdated){this.static_outdated=!1,this.renderer.beginStatic(this.camera,this.settings.backgroundColor);for(var i=0;i<this.world.bodyArr.length;i++){var s=this.world.bodyArr[i];if(s.isStatic())for(var a=At(s),h=0;h<s.shapeArr.length;h++){var o=s.shapeArr[h];o.visible&&this.renderer.drawShape(o,!0,et,"#000",a)}}this.renderer.endStatic()}if(this.settings.enableDirtyBounds){if(!this.dirtyBounds.isEmpty()){var d=this.worldToCanvas(this.dirtyBounds.mins),v=this.worldToCanvas(this.dirtyBounds.maxs),p=Math.max(Math.floor(d.x),0),_=Math.max(Math.floor(v.y),0),f=Math.min(Math.ceil(v.x),this.renderer.width)-p,T=Math.min(Math.ceil(d.y),this.renderer.height)-_;f>0&&T>0&&this.renderer.copyBackground(p,_,f,T,p,_,f,T)}}else this.renderer.copyBackground(0,0);this.dirtyBounds.clear(),this.renderer.beginDynamic(this.camera);for(var i=0;i<this.world.bodyArr.length;i++){var s=this.world.bodyArr[i];if(s.visible&&!s.isStatic())for(var a=At(s),h=0;h<s.shapeArr.length;h++){var o=s.shapeArr[h];if(o.visible){this.renderer.drawShape(o,!1,et,"#000",a);var u=et*3;this.dirtyBounds.addBounds(M.expand(o.bounds,u,u))}}}if(this.settings.showJoints)for(var i=0;i<this.world.jointArr.length;i++){var c=this.world.jointArr[i];if(c){var m=c.getWorldAnchor1(),y=c.getWorldAnchor2();this.renderer.drawHelperJointAnchors(m,y,at,et,this.settings.jointAnchorColor);var n=new M;n.addExtents(m,at,at),n.addExtents(y,at,at),n.addPoint(m),n.addPoint(y),(!c.body1.isStatic()||!c.body2.isStatic())&&(n.expand(et*2,et*2),this.dirtyBounds.addBounds(n))}}this.renderer.endDynamic()};Q.prototype.worldToCanvas=function(t){return new r(this.renderer.width*.5+(t.x*(this.camera.scale*B(1))-this.camera.origin.x),this.renderer.height-(t.y*(this.camera.scale*B(1))-this.camera.origin.y))};Q.prototype.canvasToWorld=function(t){return new r((this.camera.origin.x+(t.x-this.renderer.width*.5))/(this.camera.scale*B(1)),(this.camera.origin.y-(t.y-this.renderer.height))/(this.camera.scale*B(1)))};function rt(t){this.runner=t,this.state={mouseDown:!1,mouseDownMoving:!1,mouseDownPosition:new r,mousePositionOld:new r,touchPosOld:new Array(2),touchDist:void 0,gestureStartScale:void 0},this.mouseJoint=null,this.mouseBody=new A(A.KINETIC),this.mouseBody.resetMassData(),this.runner.world.addBody(this.mouseBody),this.mousedown=i=>{var s=this.getMousePosition(i);this.state.mouseDown=!0,this.state.mouseDownMoving=!1,this.state.mouseDownPosition.x=s.x,this.state.mouseDownPosition.y=s.y,this.removeJoint();var e=this.runner.canvasToWorld(s),o=this.runner.world.findBodyByPoint(e);o&&(this.mouseBody.p.copy(e),this.mouseBody.syncTransform(),this.mouseJoint=new Y(this.mouseBody,o,e),this.mouseJoint.maxForce=o.m*1e3,this.runner.world.addJoint(this.mouseJoint)),this.state.mousePositionOld.x=s.x,this.state.mousePositionOld.y=s.y,i.preventDefault()},this.mousemove=i=>{var s=this.getMousePosition(i);if(s.x<0||s.x>this.runner.renderer.width||s.y<0||s.y>this.runner.renderer.height)return this.mouseleave(i);if(this.state.mouseDown)if(this.state.mouseDownMoving=!0,this.mouseJoint)this.mouseBody.p.copy(this.runner.canvasToWorld(s)),this.mouseBody.syncTransform();else{var e=s.x-this.state.mousePositionOld.x,o=s.y-this.state.mousePositionOld.y;this.scrollView(-e,o),this.state.mousePositionOld.x=s.x,this.state.mousePositionOld.y=s.y}i.preventDefault()},this.mouseup=this.mouseleave=i=>{this.removeJoint(),this.state.mouseDown=!1,this.state.mouseDownMoving=!1,i.preventDefault()},this.mousewheel=i=>{var s=0,e=0;i.detail?i.axis==i.HORIZONTAL_AXIS?s=-40*i.detail:e=-40*i.detail:i.wheelDeltaX?(s=i.wheelDeltaX,e=i.wheelDeltaY):i.wheelDelta&&(e=i.wheelDelta);var o=-e*.001,n=this.runner.camera.scale;this.runner.camera.scale=Math.clamp(n+o,this.runner.camera.minScale,this.runner.camera.maxScale),o=this.runner.camera.scale-n,o*=B(1);var a=this.runner.canvasToWorld(this.getMousePosition(i)),h=s*.2;this.scrollView(a.x*o-h,a.y*o),i.preventDefault()},this.touchstart=i=>{this.removeJoint(),i.touches.length===2&&(this.state.gestureStartScale=this.runner.camera.scale,this.state.touchPosOld[0]=this.getTouchPosition(i.touches[0]),this.state.touchPosOld[1]=this.getTouchPosition(i.touches[1]),this.state.touchDist=ct(this.state.touchPosOld[0].x,this.state.touchPosOld[0].y,this.state.touchPosOld[1].x,this.state.touchPosOld[1].y),i.preventDefault())},this.touchmove=i=>{if(i.touches.length===2){var s=this.getTouchPosition(i.touches[0]),e=this.getTouchPosition(i.touches[1]);if(s.x<0||s.x>this.runner.renderer.width||s.y<0||s.y>this.runner.renderer.height||e.x<0||e.x>this.runner.renderer.width||e.y<0||e.y>this.runner.renderer.height)return this.mouseleave(i);var o=ct(s.x,s.y,e.x,e.y)/this.state.touchDist,n=Math.clamp(o-1,-.1,.1),a=this.state.gestureStartScale*(o-n),h=r.sub(s,this.state.touchPosOld[0]),d=r.sub(e,this.state.touchPosOld[1]),v=h.length(),p=d.length();if(v>0||p>0){var _=this.runner.canvasToWorld(r.lerp(s,e,v/(v+p))),f=this.runner.camera.scale;this.runner.camera.scale=Math.clamp(a,this.runner.camera.minScale,this.runner.camera.maxScale);var T=this.runner.camera.scale-f;T*=B(1),this.scrollView(-(h.x+d.x)*.5+_.x*T,(h.y+d.y)*.5+_.y*T)}this.state.touchPosOld[0]=s,this.state.touchPosOld[1]=e,i.preventDefault()}},this.touchHandler=i=>{if(i.touches.length<=1){var s={touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"}[i.type]||"",e=i.changedTouches[0],o=document.createEvent("MouseEvent");o.initMouseEvent(s,!0,!0,window,1,e.screenX,e.screenY,e.clientX,e.clientY,!1,!1,!1,!1,0,null),e.target.dispatchEvent(o)}else this[i.type]&&this[i.type](i);i.preventDefault()},["mousedown","mousemove","mouseup","mouseleave","mousewheel"].forEach(i=>this.runner.renderer.canvas.addEventListener(i,this[i])),this.runner.renderer.canvas.addEventListener("touchstart",this.touchHandler),this.runner.renderer.canvas.addEventListener("touchmove",this.touchHandler),this.runner.renderer.canvas.addEventListener("touchend",this.touchHandler),this.runner.renderer.canvas.addEventListener("touchcancel",this.touchHandler)}rt.prototype.destroy=function(){["mousedown","mousemove","mouseup","mouseleave","mousewheel"].forEach(t=>this.runner.renderer.canvas.removeEventListener(t,this[t])),this.runner.renderer.canvas.removeEventListener("touchstart",this.touchHandler),this.runner.renderer.canvas.removeEventListener("touchmove",this.touchHandler),this.runner.renderer.canvas.removeEventListener("touchend",this.touchHandler),this.runner.renderer.canvas.removeEventListener("touchcancel",this.touchHandler),this.removeJoint(),this.runner.world.removeBody(this.mouseBody)};rt.prototype.removeJoint=function(){this.mouseJoint&&(this.runner.world.removeJoint(this.mouseJoint),this.mouseJoint=null)};rt.prototype.getMousePosition=function(t){return new r(t.offsetX,t.offsetY)};rt.prototype.getTouchPosition=function(t){var i=this.runner.renderer.canvas.getBoundingClientRect();return new r(t.clientX-i.left,t.clientY-i.top)};rt.prototype.scrollView=function(t,i){this.runner.camera.origin.x+=t,this.runner.camera.origin.y+=i,this.runner.dirtyBounds.set(this.runner.canvasToWorld(new r(0,this.runner.renderer.height)),this.runner.canvasToWorld(new r(this.runner.renderer.width,0))),this.runner.static_outdated=!0};var V=function(t,i,s,e){l.call(this,l.TYPE_ROPE,t,i,!0),this.anchor1=this.body1.getLocalPoint(s),this.anchor2=this.body2.getLocalPoint(e),this.maxDistance=r.dist(s,e),this.lambda_acc=0};V.prototype=new l;V.prototype.constructor=V;V.prototype.setWorldAnchor1=function(t){this.anchor1=this.body1.getLocalPoint(t),this.maxDistance=r.dist(t,this.getWorldAnchor2())};V.prototype.setWorldAnchor2=function(t){this.anchor2=this.body2.getLocalPoint(t),this.maxDistance=r.dist(t,this.getWorldAnchor1())};V.prototype.serialize=function(){return{type:"RopeJoint",body1:this.body1.id,body2:this.body2.id,anchor1:this.body1.getWorldPoint(this.anchor1),anchor2:this.body2.getWorldPoint(this.anchor2),collideConnected:this.collideConnected,maxForce:this.maxForce,breakable:this.breakable}};V.prototype.initSolver=function(t,i){var s=this.body1,e=this.body2;this.maxImpulse=this.maxForce*t,this.r1=s.xf.rotate(r.sub(this.anchor1,s.centroid)),this.r2=e.xf.rotate(r.sub(this.anchor2,e.centroid));var o=r.sub(r.add(e.p,this.r2),r.add(s.p,this.r1));this.distance=o.length();var n=this.distance-this.maxDistance;n>0?(this.cdt=0,this.limitState=l.LIMIT_STATE_AT_UPPER):(this.cdt=n/t,this.limitState=l.LIMIT_STATE_INACTIVE),this.distance>l.LINEAR_SLOP?this.u=r.scale(o,1/this.distance):this.u=r.zero,this.s1=r.cross(this.r1,this.u),this.s2=r.cross(this.r2,this.u);var a=s.m_inv+e.m_inv+s.i_inv*this.s1*this.s1+e.i_inv*this.s2*this.s2;if(this.em=a==0?0:1/a,i){var h=r.scale(this.u,this.lambda_acc);s.v.mad(h,-s.m_inv),s.w-=this.s1*this.lambda_acc*s.i_inv,e.v.mad(h,e.m_inv),e.w+=this.s2*this.lambda_acc*e.i_inv}else this.lambda_acc=0};V.prototype.solveVelocityConstraints=function(){var t=this.body1,i=this.body2,s=this.u.dot(r.sub(i.v,t.v))+this.s2*i.w-this.s1*t.w,e=-this.em*(s+this.cdt),o=this.lambda_acc;this.lambda_acc=Math.min(o+e,0),e=this.lambda_acc-o;var n=r.scale(this.u,e);t.v.mad(n,-t.m_inv),t.w-=this.s1*e*t.i_inv,i.v.mad(n,i.m_inv),i.w+=this.s2*e*i.i_inv};V.prototype.solvePositionConstraints=function(){var t=this.body1,i=this.body2,s=r.rotate(r.sub(this.anchor1,t.centroid),t.a),e=r.rotate(r.sub(this.anchor2,i.centroid),i.a),o=r.sub(r.add(i.p,e),r.add(t.p,s)),n=o.length(),a=r.scale(o,1/n),h=n-this.maxDistance,d=Math.clamp(h,0,l.MAX_LINEAR_CORRECTION),v=r.cross(s,a),p=r.cross(e,a),_=t.m_inv+i.m_inv+t.i_inv*v*v+i.i_inv*p*p,f=_==0?0:-d/_,T=r.scale(a,f);return t.p.mad(T,-t.m_inv),t.a-=v*f*t.i_inv,i.p.mad(T,i.m_inv),i.a+=p*f*i.i_inv,h<l.LINEAR_SLOP};V.prototype.getReactionForce=function(t){return r.scale(this.u,this.lambda_acc*t)};V.prototype.getReactionTorque=function(t){return 0};var F=function(t,i,s){l.call(this,l.TYPE_WELD,t,i,!1),this.anchor1=this.body1.getLocalPoint(s),this.anchor2=this.body2.getLocalPoint(s),this.gamma=0,this.beta_c=0,this.frequencyHz=0,this.dampingRatio=0,this.lambda_acc=new S(0,0,0)};F.prototype=new l;F.prototype.constructor=F;F.prototype.setWorldAnchor1=function(t){this.anchor1=this.body1.getLocalPoint(t),this.anchor2=this.body2.getLocalPoint(t)};F.prototype.setWorldAnchor2=function(t){this.anchor1=this.body1.getLocalPoint(t),this.anchor2=this.body2.getLocalPoint(t)};F.prototype.serialize=function(){return{type:"WeldJoint",body1:this.body1.id,body2:this.body2.id,anchor1:this.body1.getWorldPoint(this.anchor1),anchor2:this.body2.getWorldPoint(this.anchor2),collideConnected:this.collideConnected,maxForce:this.maxForce,breakable:this.breakable,frequencyHz:this.frequencyHz,dampingRatio:this.dampingRatio}};F.prototype.setSpringFrequencyHz=function(t){this.frequencyHz=t};F.prototype.setSpringDampingRatio=function(t){this.dampingRatio=t};F.prototype.initSolver=function(t,i){var s=this.body1,e=this.body2;this.maxImpulse=this.maxForce*t,this.r1=s.xf.rotate(r.sub(this.anchor1,s.centroid)),this.r2=e.xf.rotate(r.sub(this.anchor2,e.centroid));var o=s.m_inv+e.m_inv,n=this.r1,a=this.r2,h=n.x*s.i_inv,d=n.y*s.i_inv,v=a.x*e.i_inv,p=a.y*e.i_inv,_=o+n.y*d+a.y*p,f=-n.x*d-a.x*p,T=-d-p,u=o+n.x*h+a.x*v,c=h+v,m=s.i_inv+e.i_inv;if(this.em_inv=new q(_,f,T,f,u,c,T,c,m),this.frequencyHz>0){var y=m>0?1/m:0,b=2*Math.PI*this.frequencyHz,x=y*b*b,w=y*2*this.dampingRatio*b;this.gamma=(w+x*t)*t,this.gamma=this.gamma==0?0:1/this.gamma;var g=t*x*this.gamma,E=e.a-s.a;this.beta_c=g*E,this.em_inv._33+=this.gamma}else this.gamma=0,this.beta_c=0;if(i){var R=new r(this.lambda_acc.x,this.lambda_acc.y),C=this.lambda_acc.z;s.v.mad(R,-s.m_inv),s.w-=(r.cross(this.r1,R)+C)*s.i_inv,e.v.mad(R,e.m_inv),e.w+=(r.cross(this.r2,R)+C)*e.i_inv}else this.lambda_acc.set(0,0,0)};F.prototype.solveVelocityConstraints=function(){var t=this.body1,i=this.body2;if(this.frequencyHz>0){var s=i.w-t.w,e=-(s+this.beta_c+this.gamma*this.lambda_acc.z)/this.em_inv._33;t.w-=e*t.i_inv,i.w+=e*i.i_inv;var o=r.mad(t.v,r.perp(this.r1),t.w),n=r.mad(i.v,r.perp(this.r2),i.w),a=r.sub(n,o),h=this.em_inv.solve2x2(a.neg());this.lambda_acc.x+=h.x,this.lambda_acc.y+=h.y,this.lambda_acc.z+=e,t.v.mad(h,-t.m_inv),t.w-=r.cross(this.r1,h)*t.i_inv,i.v.mad(h,i.m_inv),i.w+=r.cross(this.r2,h)*i.i_inv}else{var o=r.mad(t.v,r.perp(this.r1),t.w),n=r.mad(i.v,r.perp(this.r2),i.w),a=r.sub(n,o),s=i.w-t.w,d=S.fromVec2(a,s),v=this.em_inv.solve(d.neg());this.lambda_acc.addself(v);var h=new r(v.x,v.y);t.v.mad(h,-t.m_inv),t.w-=(r.cross(this.r1,h)+v.z)*t.i_inv,i.v.mad(h,i.m_inv),i.w+=(r.cross(this.r2,h)+v.z)*i.i_inv}};F.prototype.solvePositionConstraints=function(){var t=this.body1,i=this.body2,s=r.rotate(r.sub(this.anchor1,t.centroid),t.a),e=r.rotate(r.sub(this.anchor2,i.centroid),i.a),o=t.m_inv+i.m_inv,n=s.x*t.i_inv,a=s.y*t.i_inv,h=e.x*i.i_inv,d=e.y*i.i_inv,v=o+s.y*a+e.y*d,p=-s.x*a-e.x*d,_=-a-d,f=o+s.x*n+e.x*h,T=n+h,u=t.i_inv+i.i_inv,c=new q(v,p,_,p,f,T,_,T,u);if(this.frequencyHz>0){var m=r.sub(r.add(i.p,e),r.add(t.p,s)),y=0,b=r.truncate(m,l.MAX_LINEAR_CORRECTION),x=c.solve2x2(b.neg());t.p.mad(x,-t.m_inv),t.a-=r.cross(s,x)*t.i_inv,i.p.mad(x,i.m_inv),i.a+=r.cross(e,x)*i.i_inv}else{var m=r.sub(r.add(i.p,e),r.add(t.p,s)),y=i.a-t.a,b=S.fromVec2(r.truncate(m,l.MAX_LINEAR_CORRECTION),Math.clamp(y,-l.MAX_ANGULAR_CORRECTION,l.MAX_ANGULAR_CORRECTION)),w=c.solve(b.neg()),x=new r(w.x,w.y);t.p.mad(x,-t.m_inv),t.a-=(r.cross(s,x)+w.z)*t.i_inv,i.p.mad(x,i.m_inv),i.a+=(r.cross(e,x)+w.z)*i.i_inv}return m.length()<l.LINEAR_SLOP&&Math.abs(y)<=l.ANGULAR_SLOP};F.prototype.getReactionForce=function(t){return r.scale(this.lambda_acc.toVec2(),t)};F.prototype.getReactionTorque=function(t){return this.lambda_acc.z*t};var k=function(t,i,s,e){l.call(this,l.TYPE_WHEEL,t,i,!0),this.anchor1=this.body1.getLocalPoint(s),this.anchor2=this.body2.getLocalPoint(e);var o=r.sub(e,s);this.restLength=o.length(),this.u_local=this.body1.getLocalVector(r.normalize(o)),this.n_local=r.perp(this.u_local),this.lambda_acc=0,this.motorLambda_acc=0,this.springLambda_acc=0,this.motorEnabled=!1,this.motorSpeed=0,this.maxMotorTorque=0,this.gamma=0,this.beta_c=0,this.frequencyHz=0,this.dampingRatio=0};k.prototype=new l;k.prototype.constructor=k;k.prototype.setWorldAnchor1=function(t){this.anchor1=this.body1.getLocalPoint(t);var i=r.sub(this.getWorldAnchor2(),t);this.u_local=this.body1.getLocalVector(r.normalize(i)),this.n_local=r.perp(this.u_local)};k.prototype.setWorldAnchor2=function(t){this.anchor2=this.body2.getLocalPoint(t);var i=r.sub(t,this.getWorldAnchor1());this.u_local=this.body1.getLocalVector(r.normalize(i)),this.n_local=r.perp(this.u_local)};k.prototype.serialize=function(){return{type:"WheelJoint",body1:this.body1.id,body2:this.body2.id,anchor1:this.body1.getWorldPoint(this.anchor1),anchor2:this.body2.getWorldPoint(this.anchor2),collideConnected:this.collideConnected,maxForce:this.maxForce,breakable:this.breakable,motorEnabled:this.motorEnabled,motorSpeed:this.motorSpeed,maxMotorTorque:this.maxMotorTorque,frequencyHz:this.frequencyHz,dampingRatio:this.dampingRatio}};k.prototype.setSpringFrequencyHz=function(t){this.frequencyHz=t};k.prototype.setSpringDampingRatio=function(t){this.dampingRatio=t};k.prototype.enableMotor=function(t){this.motorEnabled=t};k.prototype.setMotorSpeed=function(t){this.motorSpeed=t};k.prototype.setMaxMotorTorque=function(t){this.maxMotorTorque=t};k.prototype.initSolver=function(t,i){var s=this.body1,e=this.body2;this.maxImpulse=this.maxForce*t,this.r1=s.xf.rotate(r.sub(this.anchor1,s.centroid)),this.r2=e.xf.rotate(r.sub(this.anchor2,e.centroid));var o=r.add(s.p,this.r1),n=r.add(e.p,this.r2),a=r.sub(n,o);this.r1_d=r.add(this.r1,a),this.n=r.rotate(this.n_local,s.a),this.sn1=r.cross(this.r1_d,this.n),this.sn2=r.cross(this.r2,this.n);var h=s.m_inv+e.m_inv+s.i_inv*this.sn1*this.sn1+e.i_inv*this.sn2*this.sn2;if(this.em=h>0?1/h:h,this.frequencyHz>0){this.u=r.rotate(this.u_local,s.a),this.su1=r.cross(this.r1_d,this.u),this.su2=r.cross(this.r2,this.u);var d=s.m_inv+e.m_inv+s.i_inv*this.su1*this.su1+e.i_inv*this.su2*this.su2,v=d==0?0:1/d,p=2*Math.PI*this.frequencyHz,_=v*p*p,f=v*2*this.dampingRatio*p;this.gamma=(f+_*t)*t,this.gamma=this.gamma==0?0:1/this.gamma;var T=t*_*this.gamma,u=r.dot(a,this.u)-this.restLength;this.beta_c=T*u,d=d+this.gamma,this.springEm=d==0?0:1/d}else this.gamma=0,this.beta_c=0,this.springLambda_acc=0;if(this.motorEnabled){this.maxMotorImpulse=this.maxMotorTorque*t;var c=s.i_inv+e.i_inv;this.motorEm=c>0?1/c:c}else this.motorEm=0,this.motorLambda_acc=0;if(i){var m=r.scale(this.n,this.lambda_acc),y=this.sn1*this.lambda_acc+this.motorLambda_acc,b=this.sn2*this.lambda_acc+this.motorLambda_acc;this.frequencyHz>0&&(m.addself(r.scale(this.u,this.springLambda_acc)),y+=this.su1*this.springLambda_acc,b+=this.su2*this.springLambda_acc),s.v.mad(m,-s.m_inv),s.w-=y*s.i_inv,e.v.mad(m,e.m_inv),e.w+=b*e.i_inv}else this.lambda_acc=0,this.springLambda_acc=0,this.motorLambda_acc=0};k.prototype.solveVelocityConstraints=function(){var t=this.body1,i=this.body2;if(this.frequencyHz>0){var o=this.u.dot(r.sub(i.v,t.v))+this.su2*i.w-this.su1*t.w,s=this.beta_c+this.gamma*this.springLambda_acc,n=-this.springEm*(o+s);this.springLambda_acc+=n;var a=r.scale(this.u,n);t.v.mad(a,-t.m_inv),t.w-=this.su1*n*t.i_inv,i.v.mad(a,i.m_inv),i.w+=this.su2*n*i.i_inv}if(this.motorEnabled){var o=i.w-t.w-this.motorSpeed,n=-this.motorEm*o,e=this.motorLambda_acc;this.motorLambda_acc=Math.clamp(this.motorLambda_acc+n,-this.maxMotorImpulse,this.maxMotorImpulse),n=this.motorLambda_acc-e,t.w-=n*t.i_inv,i.w+=n*i.i_inv}var o=this.n.dot(r.sub(i.v,t.v))+this.sn2*i.w-this.sn1*t.w,n=-this.em*o;this.lambda_acc+=n;var a=r.scale(this.n,n);t.v.mad(a,-t.m_inv),t.w-=this.sn1*n*t.i_inv,i.v.mad(a,i.m_inv),i.w+=this.sn2*n*i.i_inv};k.prototype.solvePositionConstraints=function(){var t=this.body1,i=this.body2,s=r.rotate(r.sub(this.anchor1,t.centroid),t.a),e=r.rotate(r.sub(this.anchor2,i.centroid),i.a),o=r.add(t.p,s),n=r.add(i.p,e),a=r.sub(n,o),h=r.add(s,a),d=r.rotate(this.n_local,t.a),v=r.dot(d,a),p=Math.clamp(v,-l.MAX_LINEAR_CORRECTION,l.MAX_LINEAR_CORRECTION),_=r.cross(h,d),f=r.cross(e,d),T=t.m_inv+i.m_inv+t.i_inv*_*_+i.i_inv*f*f,u=T==0?0:1/T,c=u*-p,m=r.scale(d,c);return t.p.mad(m,-t.m_inv),t.a-=_*c*t.i_inv,i.p.mad(m,i.m_inv),i.a+=f*c*i.i_inv,Math.abs(v)<l.LINEAR_SLOP};k.prototype.getReactionForce=function(t){return r.scale(this.n,this.lambda_acc*t)};k.prototype.getReactionTorque=function(t){return 0};var U=function(t,i){l.call(this,l.TYPE_ANGLE,t,i,!0),this.anchor1=new r(0,0),this.anchor2=new r(0,0),this.refAngle=i.a-t.a,this.lambda_acc=0};U.prototype=new l;U.prototype.constructor=U;U.prototype.setWorldAnchor1=function(t){this.anchor1=new r(0,0)};U.prototype.setWorldAnchor2=function(t){this.anchor2=new r(0,0)};U.prototype.serialize=function(){return{type:"AngleJoint",body1:this.body1.id,body2:this.body2.id,collideConnected:this.collideConnected}};U.prototype.initSolver=function(t,i){var s=this.body1,e=this.body2;this.maxImpulse=this.maxForce*t;var o=s.i_inv+e.i_inv;this.em=o==0?0:1/o,i?(s.w-=this.lambda_acc*s.i_inv,e.w+=this.lambda_acc*e.i_inv):this.lambda_acc=0};U.prototype.solveVelocityConstraints=function(){var t=this.body1,i=this.body2,s=i.w-t.w,e=-this.em*s;this.lambda_acc+=e,t.w-=e*t.i_inv,i.w+=e*i.i_inv};U.prototype.solvePositionConstraints=function(){var t=this.body1,i=this.body2,s=i.a-t.a-this.refAngle,e=Math.clamp(s,-l.MAX_ANGULAR_CORRECTION,l.MAX_ANGULAR_CORRECTION),o=this.em*-e;return t.a-=o*t.i_inv,i.a+=o*i.i_inv,Math.abs(s)<l.ANGULAR_SLOP};U.prototype.getReactionForce=function(t){return r.zero};U.prototype.getReactionTorque=function(t){return this.lambda_acc*t};var H=function(t,i,s,e){l.call(this,l.TYPE_DISTANCE,t,i,!0),this.anchor1=this.body1.getLocalPoint(s),this.anchor2=this.body2.getLocalPoint(e),this.restLength=r.dist(s,e),this.gamma=0,this.beta_c=0,this.frequencyHz=0,this.dampingRatio=0,this.lambda_acc=0};H.prototype=new l;H.prototype.constructor=H;H.prototype.setWorldAnchor1=function(t){this.anchor1=this.body1.getLocalPoint(t),this.restLength=r.dist(t,this.getWorldAnchor2())};H.prototype.setWorldAnchor2=function(t){this.anchor2=this.body2.getLocalPoint(t),this.restLength=r.dist(t,this.getWorldAnchor1())};H.prototype.serialize=function(){return{type:"DistanceJoint",body1:this.body1.id,body2:this.body2.id,anchor1:this.body1.getWorldPoint(this.anchor1),anchor2:this.body2.getWorldPoint(this.anchor2),collideConnected:this.collideConnected,maxForce:this.maxForce,breakable:this.breakable,frequencyHz:this.frequencyHz,dampingRatio:this.dampingRatio}};H.prototype.setSpringFrequencyHz=function(t){this.frequencyHz=t};H.prototype.setSpringDampingRatio=function(t){this.dampingRatio=t};H.prototype.initSolver=function(t,i){var s=this.body1,e=this.body2;this.maxImpulse=this.maxForce*t,this.r1=s.xf.rotate(r.sub(this.anchor1,s.centroid)),this.r2=e.xf.rotate(r.sub(this.anchor2,e.centroid));var o=r.sub(r.add(e.p,this.r2),r.add(s.p,this.r1)),n=o.length();n>l.LINEAR_SLOP?this.u=r.scale(o,1/n):this.u=r.zero,this.s1=r.cross(this.r1,this.u),this.s2=r.cross(this.r2,this.u);var a=s.m_inv+e.m_inv+s.i_inv*this.s1*this.s1+e.i_inv*this.s2*this.s2;if(this.em=a==0?0:1/a,this.frequencyHz>0){var h=2*Math.PI*this.frequencyHz,d=this.em*h*h,v=this.em*2*this.dampingRatio*h;this.gamma=(v+d*t)*t,this.gamma=this.gamma==0?0:1/this.gamma;var p=t*d*this.gamma,_=n-this.restLength;this.beta_c=p*_,a=a+this.gamma,this.em=a==0?0:1/a}else this.gamma=0,this.beta_c=0;if(i){var f=r.scale(this.u,this.lambda_acc);s.v.mad(f,-s.m_inv),s.w-=this.s1*this.lambda_acc*s.i_inv,e.v.mad(f,e.m_inv),e.w+=this.s2*this.lambda_acc*e.i_inv}else this.lambda_acc=0};H.prototype.solveVelocityConstraints=function(){var t=this.body1,i=this.body2,s=this.u.dot(r.sub(i.v,t.v))+this.s2*i.w-this.s1*t.w,e=this.beta_c+this.gamma*this.lambda_acc,o=-this.em*(s+e);this.lambda_acc+=o;var n=r.scale(this.u,o);t.v.mad(n,-t.m_inv),t.w-=this.s1*o*t.i_inv,i.v.mad(n,i.m_inv),i.w+=this.s2*o*i.i_inv};H.prototype.solvePositionConstraints=function(){if(this.frequencyHz>0)return!0;var t=this.body1,i=this.body2,s=r.rotate(r.sub(this.anchor1,t.centroid),t.a),e=r.rotate(r.sub(this.anchor2,i.centroid),i.a),o=r.sub(r.add(i.p,e),r.add(t.p,s)),n=o.length(),a=r.scale(o,1/n),h=n-this.restLength,d=Math.clamp(h,-l.MAX_LINEAR_CORRECTION,l.MAX_LINEAR_CORRECTION),v=r.cross(s,a),p=r.cross(e,a),_=t.m_inv+i.m_inv+t.i_inv*v*v+i.i_inv*p*p,f=_==0?0:-d/_,T=r.scale(a,f);return t.p.mad(T,-t.m_inv),t.a-=v*f*t.i_inv,i.p.mad(T,i.m_inv),i.a+=p*f*i.i_inv,Math.abs(h)<l.LINEAR_SLOP};H.prototype.getReactionForce=function(t){return r.scale(this.u,this.lambda_acc*t)};H.prototype.getReactionTorque=function(t){return 0};var D=function(t,i,s){l.call(this,l.TYPE_REVOLUTE,t,i,!1),this.anchor1=this.body1.getLocalPoint(s),this.anchor2=this.body2.getLocalPoint(s),this.refAngle=i.a-t.a,this.lambda_acc=new S(0,0,0),this.motorLambda_acc=0,this.limitEnabled=!1,this.limitLowerAngle=0,this.limitUpperAngle=0,this.limitState=l.LIMIT_STATE_INACTIVE,this.motorEnabled=!1,this.motorSpeed=0,this.maxMotorTorque=0};D.prototype=new l;D.prototype.constructor=D;D.prototype.setWorldAnchor1=function(t){this.anchor1=this.body1.getLocalPoint(t),this.anchor2=this.body2.getLocalPoint(t)};D.prototype.setWorldAnchor2=function(t){this.anchor1=this.body1.getLocalPoint(t),this.anchor2=this.body2.getLocalPoint(t)};D.prototype.serialize=function(){return{type:"RevoluteJoint",body1:this.body1.id,body2:this.body2.id,anchor:this.body1.getWorldPoint(this.anchor1),collideConnected:this.collideConnected,maxForce:this.maxForce,breakable:this.breakable,limitEnabled:this.limitEnabled,limitLowerAngle:this.limitLowerAngle,limitUpperAngle:this.limitUpperAngle,motorEnabled:this.motorEnabled,motorSpeed:this.motorSpeed,maxMotorTorque:this.maxMotorTorque}};D.prototype.enableMotor=function(t){this.motorEnabled=t};D.prototype.setMotorSpeed=function(t){this.motorSpeed=t};D.prototype.setMaxMotorTorque=function(t){this.maxMotorTorque=t};D.prototype.enableLimit=function(t){this.limitEnabled=t};D.prototype.setLimits=function(t,i){this.limitLowerAngle=t,this.limitUpperAngle=i};D.prototype.initSolver=function(t,i){var s=this.body1,e=this.body2;if(this.maxImpulse=this.maxForce*t,this.motorEnabled?this.maxMotorImpulse=this.maxMotorTorque*t:this.motorLambda_acc=0,this.limitEnabled){var o=e.a-s.a-this.refAngle;Math.abs(this.limitUpperAngle-this.limitLowerAngle)<l.ANGULAR_SLOP?this.limitState=l.LIMIT_STATE_EQUAL_LIMITS:o<=this.limitLowerAngle?(this.limitState!=l.LIMIT_STATE_AT_LOWER&&(this.lambda_acc.z=0),this.limitState=l.LIMIT_STATE_AT_LOWER):o>=this.limitUpperAngle?(this.limitState!=l.LIMIT_STATE_AT_UPPER&&(this.lambda_acc.z=0),this.limitState=l.LIMIT_STATE_AT_UPPER):(this.limitState=l.LIMIT_STATE_INACTIVE,this.lambda_acc.z=0)}else this.limitState=l.LIMIT_STATE_INACTIVE;this.r1=s.xf.rotate(r.sub(this.anchor1,s.centroid)),this.r2=e.xf.rotate(r.sub(this.anchor2,e.centroid));var n=s.m_inv+e.m_inv,a=this.r1,h=this.r2,d=a.x*s.i_inv,v=a.y*s.i_inv,p=h.x*e.i_inv,_=h.y*e.i_inv,f=n+a.y*v+h.y*_,T=-a.x*v-h.x*_,u=-v-_,c=n+a.x*d+h.x*p,m=d+p,y=s.i_inv+e.i_inv;if(this.em_inv=new q(f,T,u,T,c,m,u,m,y),y!=0&&(this.em2=1/y),i){var b=new r(this.lambda_acc.x,this.lambda_acc.y),x=this.lambda_acc.z+this.motorLambda_acc;s.v.mad(b,-s.m_inv),s.w-=(r.cross(this.r1,b)+x)*s.i_inv,e.v.mad(b,e.m_inv),e.w+=(r.cross(this.r2,b)+x)*e.i_inv}else this.lambda_acc.set(0,0,0),this.motorLambda_acc=0};D.prototype.solveVelocityConstraints=function(){var t=this.body1,i=this.body2;if(this.motorEnabled&&this.limitState!=l.LIMIT_STATE_EQUAL_LIMITS){var s=i.w-t.w-this.motorSpeed,e=-this.em2*s,o=this.motorLambda_acc;this.motorLambda_acc=Math.clamp(this.motorLambda_acc+e,-this.maxMotorImpulse,this.maxMotorImpulse),e=this.motorLambda_acc-o,t.w-=e*t.i_inv,i.w+=e*i.i_inv}if(this.limitEnabled&&this.limitState!=l.LIMIT_STATE_INACTIVE){var n=r.mad(t.v,r.perp(this.r1),t.w),a=r.mad(i.v,r.perp(this.r2),i.w),h=r.sub(a,n),d=i.w-t.w,s=S.fromVec2(h,d),e=this.em_inv.solve(s.neg());if(this.limitState==l.LIMIT_STATE_EQUAL_LIMITS)this.lambda_acc.addself(e);else if(this.limitState==l.LIMIT_STATE_AT_LOWER||this.limitState==l.LIMIT_STATE_AT_UPPER){var v=this.lambda_acc.z+e.z,p=this.limitState==l.LIMIT_STATE_AT_LOWER&&v<0,_=this.limitState==l.LIMIT_STATE_AT_UPPER&&v>0;if(p||_){var f=r.add(h,r.scale(new r(this.em_inv._13,this.em_inv._23),v)),T=this.em_inv.solve2x2(f.neg());e.x=T.x,e.y=T.y,e.z=-this.lambda_acc.z,this.lambda_acc.x+=e.x,this.lambda_acc.y+=e.y,this.lambda_acc.z=0}else this.lambda_acc.addself(e)}var u=new r(e.x,e.y);t.v.mad(u,-t.m_inv),t.w-=(r.cross(this.r1,u)+e.z)*t.i_inv,i.v.mad(u,i.m_inv),i.w+=(r.cross(this.r2,u)+e.z)*i.i_inv}else{var n=r.mad(t.v,r.perp(this.r1),t.w),a=r.mad(i.v,r.perp(this.r2),i.w),s=r.sub(a,n),e=this.em_inv.solve2x2(s.neg());this.lambda_acc.addself(S.fromVec2(e,0)),t.v.mad(e,-t.m_inv),t.w-=r.cross(this.r1,e)*t.i_inv,i.v.mad(e,i.m_inv),i.w+=r.cross(this.r2,e)*i.i_inv}};D.prototype.solvePositionConstraints=function(){var t=this.body1,i=this.body2,s=0,e=0;if(this.limitEnabled&&this.limitState!=l.LIMIT_STATE_INACTIVE){var o=i.a-t.a-this.refAngle,n=0;if(this.limitState==l.LIMIT_STATE_EQUAL_LIMITS){var a=Math.clamp(o-this.limitLowerAngle,-l.MAX_ANGULAR_CORRECTION,l.MAX_ANGULAR_CORRECTION);s=Math.abs(a),n=-this.em2*a}else if(this.limitState==l.LIMIT_STATE_AT_LOWER){var a=o-this.limitLowerAngle;s=-a,a=Math.clamp(a+l.ANGULAR_SLOP,-l.MAX_ANGULAR_CORRECTION,0),n=-this.em2*a}else if(this.limitState==l.LIMIT_STATE_AT_UPPER){var a=o-this.limitUpperAngle;s=a,a=Math.clamp(a-l.ANGULAR_SLOP,0,l.MAX_ANGULAR_CORRECTION),n=-this.em2*a}t.a-=n*t.i_inv,i.a+=n*i.i_inv}{var h=r.rotate(r.sub(this.anchor1,t.centroid),t.a),d=r.rotate(r.sub(this.anchor2,i.centroid),i.a),a=r.sub(r.add(i.p,d),r.add(t.p,h)),v=r.truncate(a,l.MAX_LINEAR_CORRECTION);e=v.length();var p=t.m_inv+i.m_inv,_=h.y*t.i_inv,f=d.y*i.i_inv,T=p+h.y*_+d.y*f,u=-h.x*_-d.x*f,c=p+h.x*h.x*t.i_inv+d.x*d.x*i.i_inv,m=new z(T,u,u,c),y=m.solve(v.neg());t.p.mad(y,-t.m_inv),t.a-=r.cross(h,y)*t.i_inv,i.p.mad(y,i.m_inv),i.a+=r.cross(d,y)*i.i_inv}return e<l.LINEAR_SLOP&&s<l.ANGULAR_SLOP};D.prototype.getReactionForce=function(t){return r.scale(this.lambda_acc,t)};D.prototype.getReactionTorque=function(t){return 0};var X=function(t,i,s,e){l.call(this,l.TYPE_PRISMATIC,t,i,!0),this.anchor1=this.body1.getLocalPoint(s),this.anchor2=this.body2.getLocalPoint(e);var o=r.sub(e,s);this.n_local=this.body1.getLocalVector(r.normalize(r.perp(o))),this.da=i.a-t.a,this.lambda_acc=new r(0,0)};X.prototype=new l;X.prototype.constructor=X;X.prototype.setWorldAnchor1=function(t){this.anchor1=this.body1.getLocalPoint(t);var i=r.sub(this.getWorldAnchor2(),t);this.n_local=this.body1.getLocalVector(r.normalize(r.perp(i)))};X.prototype.setWorldAnchor2=function(t){this.anchor2=this.body2.getLocalPoint(t);var i=r.sub(t,this.getWorldAnchor1());this.n_local=this.body1.getLocalVector(r.normalize(r.perp(i)))};X.prototype.serialize=function(){return{type:"PrismaticJoint",body1:this.body1.id,body2:this.body2.id,anchor1:this.body1.getWorldPoint(this.anchor1),anchor2:this.body2.getWorldPoint(this.anchor2),collideConnected:this.collideConnected,maxForce:this.maxForce,breakable:this.breakable}};X.prototype.initSolver=function(t,i){var s=this.body1,e=this.body2;this.maxImpulse=this.maxForce*t,this.r1=s.xf.rotate(r.sub(this.anchor1,s.centroid)),this.r2=e.xf.rotate(r.sub(this.anchor2,e.centroid));var o=r.add(s.p,this.r1),n=r.add(e.p,this.r2),a=r.sub(n,o);this.r1_d=r.add(this.r1,a),this.n=r.normalize(r.perp(a)),this.s1=r.cross(this.r1_d,this.n),this.s2=r.cross(this.r2,this.n);var h=this.s1,d=this.s2,v=h*s.i_inv,p=d*e.i_inv,_=s.m_inv+e.m_inv+h*v+d*p,f=v+p,T=s.i_inv+e.i_inv;if(this.em_inv=new z(_,f,f,T),i){var u=r.scale(this.n,this.lambda_acc.x);s.v.mad(u,-s.m_inv),s.w-=(this.s1*this.lambda_acc.x+this.lambda_acc.y)*s.i_inv,e.v.mad(u,e.m_inv),e.w+=(this.s2*this.lambda_acc.x+this.lambda_acc.y)*e.i_inv}else this.lambda_acc.set(0,0)};X.prototype.solveVelocityConstraints=function(){var t=this.body1,i=this.body2,s=this.n.dot(r.sub(i.v,t.v))+this.s2*i.w-this.s1*t.w,e=i.w-t.w,o=this.em_inv.solve(new r(-s,-e));this.lambda_acc.addself(o);var n=r.scale(this.n,o.x);t.v.mad(n,-t.m_inv),t.w-=(this.s1*o.x+o.y)*t.i_inv,i.v.mad(n,i.m_inv),i.w+=(this.s2*o.x+o.y)*i.i_inv};X.prototype.solvePositionConstraints=function(){var t=this.body1,i=this.body2,s=r.rotate(r.sub(this.anchor1,t.centroid),t.a),e=r.rotate(r.sub(this.anchor2,i.centroid),i.a),o=r.add(t.p,s),n=r.add(i.p,e),a=r.sub(n,o),h=r.add(s,a),d=r.rotate(this.n_local,t.a),v=r.dot(d,a),p=i.a-t.a-this.da,_=new r;_.x=Math.clamp(v,-l.MAX_LINEAR_CORRECTION,l.MAX_LINEAR_CORRECTION),_.y=Math.clamp(p,-l.MAX_ANGULAR_CORRECTION,l.MAX_ANGULAR_CORRECTION);var f=r.cross(h,d),T=r.cross(e,d),u=f*t.i_inv,c=T*i.i_inv,m=t.m_inv+i.m_inv+f*u+T*c,y=u+c,b=t.i_inv+i.i_inv,x=new z(m,y,y,b),w=x.solve(_.neg()),g=r.scale(d,w.x);return t.p.mad(g,-t.m_inv),t.a-=(r.cross(h,g)+w.y)*t.i_inv,i.p.mad(g,i.m_inv),i.a+=(r.cross(e,g)+w.y)*i.i_inv,Math.abs(v)<=l.LINEAR_SLOP&&Math.abs(p)<=l.ANGULAR_SLOP};X.prototype.getReactionForce=function(t){return r.scale(this.n,this.lambda_acc.x*t)};X.prototype.getReactionTorque=function(t){return this.lambda_acc.y*t};function St(t,i,s,e,o){t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(s.x,s.y),t.lineWidth=e,t.strokeStyle=o,t.stroke()}function Pt(t,i,s,e,o,n,a){t.beginPath();var h=r.sub(i,s),d=r.add(i,s),v=r.sub(h,e),p=r.add(h,e),_=r.sub(d,e),f=r.add(d,e);t.moveTo(v.x,v.y),t.lineTo(_.x,_.y),t.lineTo(f.x,f.y),t.lineTo(p.x,p.y),t.lineTo(v.x,v.y),t.closePath(),a&&(t.fillStyle=a,t.fill()),n&&(t.lineWidth=o,t.strokeStyle=n,t.stroke())}function Lt(t,i,s,e,o,n,a){if(t.beginPath(),t.arc(i.x,i.y,s,0,Math.PI*2,!1),a&&(t.fillStyle=a,t.fill()),n){if(typeof e=="number"){t.moveTo(i.x,i.y);var h=r.add(i,r.scale(r.rotation(e),s));t.lineTo(h.x,h.y)}t.lineWidth=o,t.strokeStyle=n,t.stroke()}}function Mt(t,i,s,e,o,n,a){t.beginPath();var h=r.normalize(r.perp(r.sub(s,i))),d=h.toAngle();t.arc(i.x,i.y,e,d,d+Math.PI,!1);var v=r.scale(h,-e),p=r.add(s,v);t.lineTo(p.x,p.y),d+=Math.PI,t.arc(s.x,s.y,e,d,d+Math.PI,!1),v=r.scale(h,e);var _=r.add(i,v);t.lineTo(_.x,_.y),t.closePath(),a&&(t.fillStyle=a,t.fill()),n&&(t.lineWidth=o,t.strokeStyle=n,t.stroke())}function Et(t,i,s,e,o){t.beginPath(),t.moveTo(i[0].x,i[0].y);for(var n=0;n<i.length;n++)t.lineTo(i[n].x,i[n].y);t.lineTo(i[i.length-1].x,i[i.length-1].y),t.closePath(),o&&(t.fillStyle=o,t.fill()),e&&(t.lineWidth=s,t.strokeStyle=e,t.stroke())}function $(t){this.canvas=t,this.fg={canvas:t,ctx:t.getContext("2d")},this.bg={canvas:document.createElement("canvas")},this.bg.ctx=this.bg.canvas.getContext("2d"),this.resize()}$.prototype.drawShape=function(t,i,s,e,o){switch(t.type){case P.TYPE_CIRCLE:Lt(i?this.bg.ctx:this.fg.ctx,t.tc,t.r,t.body.a,s,e,o);break;case P.TYPE_SEGMENT:Mt(i?this.bg.ctx:this.fg.ctx,t.ta,t.tb,t.r,s,e,o);break;case P.TYPE_POLY:t.convexity?Et(i?this.bg.ctx:this.fg.ctx,t.tverts,s,e,o):Et(i?this.bg.ctx:this.fg.ctx,t.tverts,s,e,o);break}};$.prototype.copyBackground=function(t,i,s,e,o,n,a,h){this.fg.ctx.drawImage(this.bg.canvas,t,i,s,e,o,n,a,h)};$.prototype.beginStatic=function(t,i){this.bg.ctx.fillStyle=i,this.bg.ctx.fillRect(0,0,this.width,this.height),this.bg.ctx.save(),this.bg.ctx.setTransform(t.scale*B(1),0,0,-(t.scale*B(1)),this.width*.5-t.origin.x,this.height+t.origin.y)};$.prototype.endStatic=function(){this.bg.ctx.restore()};$.prototype.beginDynamic=function(t){this.fg.ctx.save(),this.fg.ctx.setTransform(t.scale*B(1),0,0,-(t.scale*B(1)),this.width*.5-t.origin.x,this.height+t.origin.y)};$.prototype.endDynamic=function(){this.fg.ctx.restore()};$.prototype.resize=function(){this.width=this.fg.canvas.width=this.bg.canvas.width=this.canvas.width=this.canvas.offsetWidth,this.height=this.fg.canvas.height=this.bg.canvas.height=this.canvas.height=this.canvas.offsetHeight};$.prototype.drawHelperJointAnchors=function(t,i,s,e,o){var n=new r(s,0),a=new r(0,s);Pt(this.fg.ctx,t,n,a,0,"",o),Pt(this.fg.ctx,i,n,a,0,"",o),St(this.fg.ctx,t,i,e,o)};var Er={Interaction:rt,Runner:Q,World:L,Body:A,Shape:P,ShapeBox:wt,ShapePoly:I,ShapeCircle:O,ShapeTriangle:xt,ShapeSegment:N,RopeJoint:V,WeldJoint:F,WheelJoint:k,AngleJoint:U,MouseJoint:Y,DistanceJoint:H,RevoluteJoint:D,PrismaticJoint:X,Bounds:M,collision:j,stats:W,pixel2meter:nt,meter2pixel:B,vec2:r,deg2rad:it,CanvasRenderer:$};export{U as AngleJoint,A as Body,M as Bounds,$ as CanvasRenderer,H as DistanceJoint,rt as Interaction,Y as MouseJoint,X as PrismaticJoint,D as RevoluteJoint,V as RopeJoint,Q as Runner,P as Shape,wt as ShapeBox,O as ShapeCircle,I as ShapePoly,N as ShapeSegment,xt as ShapeTriangle,F as WeldJoint,k as WheelJoint,L as World,j as collision,Er as default,it as deg2rad,B as meter2pixel,nt as pixel2meter,W as stats,r as vec2};

var tt=Object.defineProperty;var yt=Object.getOwnPropertyDescriptor;var mt=Object.getOwnPropertyNames;var _t=Object.prototype.hasOwnProperty;var xt=(t,r)=>{for(var i in r)tt(t,i,{get:r[i],enumerable:!0})},wt=(t,r,i,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of mt(r))!_t.call(t,n)&&n!==i&&tt(t,n,{get:()=>r[n],enumerable:!(e=yt(r,n))||e.enumerable});return t};var bt=t=>wt(tt({},"__esModule",{value:!0}),t);var Tt={};xt(Tt,{Body:()=>_,Bounds:()=>E,CanvasRenderer:()=>V,Interaction:()=>G,MouseJoint:()=>N,Runner:()=>J,Shape:()=>A,World:()=>T,collision:()=>U,meter2pixel:()=>q,pixel2meter:()=>$,stats:()=>k,vec2:()=>s});module.exports=bt(Tt);function H(t,r,i,e){this.hash=e,this.p=t,this.n=r,this.d=i,this.lambda_n_acc=0,this.lambda_t_acc=0}Math.clamp=function(t,r,i){return t<r?r:t>i?i:t};Math.log2=function(t){return Math.log(t)/Math.log(2)};function Z(t){return t/180*Math.PI}function $(t){return t*.02}function q(t){return t*50}function s(t,r){this.x=t||0,this.y=r||0}s.zero=new s(0,0);s.prototype.toString=function(){return["x:",this.x,"y:",this.y].join(" ")};s.prototype.set=function(t,r){return this.x=t,this.y=r,this};s.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this};s.prototype.duplicate=function(){return new s(this.x,this.y)};s.prototype.equal=function(t){return!(this.x!=t.x||this.y!=t.y)};s.prototype.add=function(t,r){return this.x=t.x+r.x,this.y=t.y+r.y,this};s.prototype.addself=function(t){return this.x+=t.x,this.y+=t.y,this};s.prototype.sub=function(t,r){return this.x=t.x-r.x,this.y=t.y-r.y,this};s.prototype.subself=function(t){return this.x-=t.x,this.y-=t.y,this};s.prototype.scale=function(t){return this.x*=t,this.y*=t,this};s.prototype.scale2=function(t){return this.x*=t.x,this.y*=t.y,this};s.prototype.mad=function(t,r){this.x+=t.x*r,this.y+=t.y*r};s.prototype.neg=function(){return this.x*=-1,this.y*=-1,this};s.prototype.rcp=function(){return this.x=1/this.x,this.y=1/this.y,this};s.prototype.lengthsq=function(){return this.x*this.x+this.y*this.y};s.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};s.prototype.normalize=function(){var t=this.x!=0||this.y!=0?1/Math.sqrt(this.x*this.x+this.y*this.y):0;return this.x*=t,this.y*=t,this};s.prototype.dot=function(t){return this.x*t.x+this.y*t.y};s.prototype.cross=function(t){return this.x*t.y-this.y*t.x};s.prototype.toAngle=function(){return Math.atan2(this.y,this.x)};s.prototype.rotation=function(t){return this.x=Math.cos(t),this.y=Math.sin(t),this};s.prototype.rotate=function(t){var r=Math.cos(t),i=Math.sin(t);return this.set(this.x*r-this.y*i,this.x*i+this.y*r)};s.prototype.lerp=function(t,r,i){return this.add(s.scale(t,1-i),s.scale(r,i))};s.add=function(t,r){return new s(t.x+r.x,t.y+r.y)};s.sub=function(t,r){return new s(t.x-r.x,t.y-r.y)};s.scale=function(t,r){return new s(t.x*r,t.y*r)};s.scale2=function(t,r){return new s(t.x*r.x,t.y*r.y)};s.mad=function(t,r,i){return new s(t.x+r.x*i,t.y+r.y*i)};s.neg=function(t){return new s(-t.x,-t.y)};s.rcp=function(t){return new s(1/t.x,1/t.y)};s.normalize=function(t){var r=t.x!=0||t.y!=0?1/Math.sqrt(t.x*t.x+t.y*t.y):0;return new s(t.x*r,t.y*r)};s.dot=function(t,r){return t.x*r.x+t.y*r.y};s.cross=function(t,r){return t.x*r.y-t.y*r.x};s.toAngle=function(t){return Math.atan2(t.y,t.x)};s.rotation=function(t){return new s(Math.cos(t),Math.sin(t))};s.rotate=function(t,r){var i=Math.cos(r),e=Math.sin(r);return new s(t.x*i-t.y*e,t.x*e+t.y*i)};s.perp=function(t){return new s(-t.y,t.x)};s.rperp=function(t){return new s(t.y,-t.x)};s.dist=function(t,r){var i=r.x-t.x,e=r.y-t.y;return Math.sqrt(i*i+e*e)};s.distsq=function(t,r){var i=r.x-t.x,e=r.y-t.y;return i*i+e*e};s.lerp=function(t,r,i){return s.add(s.scale(t,1-i),s.scale(r,i))};s.truncate=function(t,r){var i=t.duplicate(),e=t.x*t.x+t.y*t.y;return e>r*r&&i.scale(r/Math.sqrt(e)),i};function M(t,r,i){this.x=t||0,this.y=r||0,this.z=i||0}M.zero=new M(0,0,0);M.prototype.toString=function(){return["x:",this.x,"y:",this.y,"z:",this.z].join(" ")};M.prototype.set=function(t,r,i){return this.x=t,this.y=r,this.z=i,this};M.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this};M.prototype.duplicate=function(){return new M(this.x,this.y,this.z)};M.prototype.equal=function(t){return!(this.x!=t.x||this.y!=t.y||this.z!=t.z)};M.prototype.add=function(t,r){return this.x=t.x+r.x,this.y=t.y+r.y,this.z=t.z+r.z,this};M.prototype.addself=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this};M.prototype.sub=function(t,r){return this.x=t.x-r.x,this.y=t.y-r.y,this.z=t.z-r.z,this};M.prototype.subself=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this};M.prototype.scale=function(t){return this.x*=t,this.y*=t,this.z*=t,this};M.prototype.mad=function(t,r){this.x+=t.x*r,this.y+=t.y*r,this.z+=t.z*r};M.prototype.neg=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this};M.prototype.rcp=function(){return this.x=1/this.x,this.y=1/this.y,this.z=1/this.z,this};M.prototype.lengthsq=function(){return this.x*this.x+this.y*this.y+this.z*this.z};M.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};M.prototype.normalize=function(){var t=this.x!=0||this.y!=0||this.z!=0?1/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z):0;return this.x*=t,this.y*=t,this.z*=t,this};M.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z};M.prototype.toVec2=function(){return new s(this.x,this.y)};M.fromVec2=function(t,r){return new M(t.x,t.y,r)};M.truncate=function(t,r){var i=t.duplicate(),e=t.x*t.x+t.y*t.y+t.z*t.z;return e>r*r&&i.scale(r/Math.sqrt(e)),i};function I(t,r,i,e){this._11=t||0,this._12=r||0,this._21=i||0,this._22=e||0}I.zero=new I(0,0,0,0);I.prototype.toString=function(){return["[",this._11,this._12,this_21,this._22,"]"].join(" ")};I.prototype.set=function(t,r,i,e){return this._11=t,this._12=r,this._21=i,this._22=e,this};I.prototype.copy=function(t){return this._11=t._11,this._12=t._12,this._21=t._21,this._22=t._22,this};I.prototype.duplicate=function(){return new I(this._11,this._12,this._21,this._22)};I.prototype.scale=function(t){return this._11*=t,this._12*=t,this._21*=t,this._22*=t,this};I.prototype.mul=function(t){return this.set(this._11*m2._11+this._12*m2._21,this._11*m2._12+this._12*m2._22,this._21*m2._11+this._22*m2._21,this._21*m2._12+this._22*m2._22)};I.prototype.mulvec=function(t){return new s(this._11*t.x+this._12*t.y,this._21*t.x+this._22*t.y)};I.prototype.invert=function(){var t=this._11*this._22-this._12*this._21;return t!=0&&(t=1/t),this.set(this._22*t,-this._12*t,-this._21*t,this._11*t)};I.prototype.solve=function(t){var r=this._11*this._22-this._12*this._21;return r!=0&&(r=1/r),new s(r*(this._22*t.x-this._12*t.y),r*(this._11*t.y-this._21*t.x))};I.mul=function(t,r){return new I(t._11*r._11+t._12*r._21,t._11*r._12+t._12*r._22,t._21*r._11+t._22*r._21,t._21*r._12+t._22*r._22)};function O(t,r,i,e,n,o,a,h,d){this._11=t||0,this._12=r||0,this._13=i||0,this._21=e||0,this._22=n||0,this._23=o||0,this._31=a||0,this._32=h||0,this._33=d||0}O.zero=new O(0,0,0,0,0,0,0,0,0);O.prototype.toString=function(){return["[",this._11,this._12,this._13,this_21,this._22,this._23,this._31,this._32,this._33,"]"].join(" ")};O.prototype.set=function(t,r,i,e,n,o,a,h,d){return this._11=t,this._12=r,this._13=i,this._21=e,this._22=n,this._23=o,this._31=a,this._32=h,this._33=d,this};O.prototype.copy=function(t){return this._11=t._11,this._12=t._12,this._13=t._13,this._21=t._21,this._22=t._22,this._23=t._23,this._31=t._31,this._32=t._32,this._33=t._33,this};O.prototype.duplicate=function(){return new O(this._11,this._12,this._13,this._21,this._22,this._23,this._31,this._32,this._33)};O.prototype.scale=function(t){return this._11*=t,this._12*=t,this._13*=t,this._21*=t,this._22*=t,this._23*=t,this._31*=t,this._32*=t,this._33*=t,this};O.prototype.mul=function(t){return this.set(this._11*m2._11+this._12*m2._21+this._13*m2._31,this._11*m2._12+this._12*m2._22+this._13*m2._32,this._11*m2._13+this._12*m2._23+this._13*m2._33,this._21*m2._11+this._22*m2._21+this._23*m2._31,this._21*m2._12+this._22*m2._22+this._23*m2._32,this._21*m2._13+this._22*m2._23+this._23*m2._33,this._31*m2._11+this._32*m2._21+this._33*m2._31,this._31*m2._12+this._32*m2._22+this._33*m2._32,this._31*m2._13+this._32*m2._23+this._33*m2._33)};O.prototype.mulvec=function(t){return new s(this._11*t.x+this._12*t.y+this._13*t.z,this._21*t.x+this._22*t.y+this._23*t.z,this._31*t.x+this._32*t.y+this._33*t.z)};O.prototype.invert=function(){var t=this._22*this._33-this._23*this._32,r=this._23*this._31-this._21*this._33,i=this._21*this._32-this._22*this._31,e=this._11*t+this._12*r+this._13*i;e!=0&&(e=1/e);var n=this._13*this._32-this._12*this._33,o=this._11*this._33-this._13*this._31,a=this._12*this._31-this._11*this._32,h=this._12*this._23-this._13*this._22,d=this._13*this._21-this._11*this._23,c=this._11*this._22-this._12*this._21;return this.set(t*e,r*e,i*e,n*e,o*e,a*e,h*e,d*e,c*e)};O.prototype.solve2x2=function(t){var r=this._11*this._22-this._12*this._21;return r!=0&&(r=1/r),new s(r*(this._22*t.x-this._12*t.y),r*(this._11*t.y-this._21*t.x))};O.prototype.solve=function(t){var r=this._22*this._33-this._23*this._32,i=this._23*this._31-this._21*this._33,e=this._21*this._32-this._22*this._31,n=this._11*r+this._12*i+this._13*e;n!=0&&(n=1/n);var o=this._13*this._32-this._12*this._33,a=this._11*this._33-this._13*this._31,h=this._12*this._31-this._11*this._32,d=this._12*this._23-this._13*this._22,c=this._13*this._21-this._11*this._23,y=this._11*this._22-this._12*this._21;return new M(n*(r*t.x+i*t.y+e*t.z),n*(o*t.x+a*t.y+h*t.z),n*(d*t.x+c*t.y+y*t.z))};O.mul=function(t,r){return new O(t._11*r._11+t._12*r._21+t._13*r._31,t._11*r._12+t._12*r._22+t._13*r._32,t._11*r._13+t._12*r._23+t._13*r._33,t._21*r._11+t._22*r._21+t._23*r._31,t._21*r._12+t._22*r._22+t._23*r._32,t._21*r._13+t._22*r._23+t._23*r._33,t._31*r._11+t._32*r._21+t._33*r._31,t._31*r._12+t._32*r._22+t._33*r._32,t._31*r._13+t._32*r._23+t._33*r._33)};var W=function(t,r){this.t=t.duplicate(),this.c=Math.cos(r),this.s=Math.sin(r)};W.prototype.set=function(t,r){return this.t.copy(t),this.c=Math.cos(r),this.s=Math.sin(r),this};W.prototype.setRotation=function(t){return this.c=Math.cos(t),this.s=Math.sin(t),this};W.prototype.setPosition=function(t){return this.t.copy(t),this};W.prototype.identity=function(){return this.t.set(0,0),this.c=1,this.s=0,this};W.prototype.rotate=function(t){return new s(t.x*this.c-t.y*this.s,t.x*this.s+t.y*this.c)};W.prototype.unrotate=function(t){return new s(t.x*this.c+t.y*this.s,-t.x*this.s+t.y*this.c)};W.prototype.transform=function(t){return new s(t.x*this.c-t.y*this.s+this.t.x,t.x*this.s+t.y*this.c+this.t.y)};W.prototype.untransform=function(t){var r=t.x-this.t.x,i=t.y-this.t.y;return new s(r*this.c+i*this.s,-r*this.s+i*this.c)};var E=function(t,r){this.mins=t?new s(t.x,t.y):new s(999999,999999),this.maxs=r?new s(r.x,r.y):new s(-999999,-999999)};E.prototype.toString=function(){return["mins:",this.mins.toString(),"maxs:",this.maxs.toString()].join(" ")};E.prototype.set=function(t,r){this.mins.set(t.x,t.y),this.maxs.set(r.x,r.y)};E.prototype.copy=function(t){return this.mins.copy(t.mins),this.maxs.copy(t.maxs),this};E.prototype.clear=function(){return this.mins.set(999999,999999),this.maxs.set(-999999,-999999),this};E.prototype.isEmpty=function(){if(this.mins.x>this.maxs.x||this.mins.y>this.maxs.y)return!0};E.prototype.getCenter=function(){return s.scale(s.add(this.mins,this.maxs),.5)};E.prototype.getExtent=function(){return s.scale(s.sub(this.maxs,this.mins),.5)};E.prototype.getPerimeter=function(){return(maxs.x-mins.x+maxs.y-mins.y)*2};E.prototype.addPoint=function(t){return this.mins.x>t.x&&(this.mins.x=t.x),this.maxs.x<t.x&&(this.maxs.x=t.x),this.mins.y>t.y&&(this.mins.y=t.y),this.maxs.y<t.y&&(this.maxs.y=t.y),this};E.prototype.addBounds=function(t){return this.mins.x>t.mins.x&&(this.mins.x=t.mins.x),this.maxs.x<t.maxs.x&&(this.maxs.x=t.maxs.x),this.mins.y>t.mins.y&&(this.mins.y=t.mins.y),this.maxs.y<t.maxs.y&&(this.maxs.y=t.maxs.y),this};E.prototype.addBounds2=function(t,r){return this.mins.x>t.x&&(this.mins.x=t.x),this.maxs.x<r.x&&(this.maxs.x=r.x),this.mins.y>t.y&&(this.mins.y=t.y),this.maxs.y<r.y&&(this.maxs.y=r.y),this};E.prototype.addExtents=function(t,r,i){return this.mins.x>t.x-r&&(this.mins.x=t.x-r),this.maxs.x<t.x+r&&(this.maxs.x=t.x+r),this.mins.y>t.y-i&&(this.mins.y=t.y-i),this.maxs.y<t.y+i&&(this.maxs.y=t.y+i),this};E.prototype.expand=function(t,r){return this.mins.x-=t,this.mins.y-=r,this.maxs.x+=t,this.maxs.y+=r,this};E.prototype.containPoint=function(t){return!(t.x<this.mins.x||t.x>this.maxs.x||t.y<this.mins.y||t.y>this.maxs.y)};E.prototype.intersectsBounds=function(t){return!(this.mins.x>t.maxs.x||this.maxs.x<t.mins.x||this.mins.y>t.maxs.y||this.maxs.y<t.mins.y)};E.expand=function(e,r,i){var e=new E(e.mins,e.maxs);return e.expand(r,i),e};function rt(t,r,i,e){var n=t-i,o=r-e;return Math.sqrt(n*n+o*o)}var A=function(t){arguments.length!=0&&(A.id_counter==null&&(A.id_counter=0),this.id=A.id_counter++,this.type=t,this.e=0,this.u=1,this.density=1,this.bounds=new E)};A.TYPE_CIRCLE=0;A.TYPE_SEGMENT=1;A.TYPE_POLY=2;A.NUM_TYPES=3;var U={};(function(){var t=[];function r(f,u,l){t[f*A.NUM_TYPES+u]=l}function i(f,u,l,p,x){var b=u+p,v=s.sub(l,f),g=v.lengthsq();if(g>b*b)return 0;var P=Math.sqrt(g),D=s.mad(f,v,.5+(u-p)*.5/P),R=P!=0?s.scale(v,1/P):s.zero,F=P-b;return x.push(new H(D,R,F,0)),1}function e(f,u,l){return i(f.tc,f.r,u.tc,u.r,l)}function n(f,u,l){var p=f.r+u.r,x=s.dot(f.tc,u.tn)-s.dot(u.ta,u.tn),b=(x<0?x*-1:x)-p;if(b>0)return 0;var v=s.cross(f.tc,u.tn),g=s.cross(u.ta,u.tn),P=s.cross(u.tb,u.tn);if(v<g)return v<g-p?0:i(f.tc,f.r,u.ta,u.r,l);if(v>P)return v>P+p?0:i(f.tc,f.r,u.tb,u.r,l);var D=x>0?u.tn:s.neg(u.tn);return l.push(new H(s.mad(f.tc,D,-(f.r+b*.5)),s.neg(D),b,0)),1}function o(f,u,l){for(var p=-999999,x=-1,b=0;b<u.verts.length;b++){var v=u.tplanes[b],g=s.dot(f.tc,v.n)-v.d-f.r;if(g>0)return 0;g>p&&(p=g,x=b)}var P=u.tplanes[x].n,D=u.tverts[x],R=u.tverts[(x+1)%u.verts.length],F=s.cross(D,P),X=s.cross(R,P),K=s.cross(f.tc,P);return K>F?i(f.tc,f.r,D,0,l):K<X?i(f.tc,f.r,R,0,l):(l.push(new H(s.mad(f.tc,P,-(f.r+p*.5)),s.neg(P),p,0)),1)}function a(f,u){var l=s.sub(u,f.ta),p=s.sub(f.tb,f.ta),x=l.dot(p);if(x<=0)return l.dot(l);var b=p.dot(p);return x>=b?l.dot(l)-2*x+b:l.dot(l)-x*x/b}function h(f,u,l){var p=[];p[0]=a(f,u.ta),p[1]=a(f,u.tb),p[2]=a(u,f.ta),p[3]=a(u,f.tb);var x=p[0]<p[1]?0:1,b=p[2]<p[3]?2:3,v=p[x]<p[b]?x:b,g,P,D=s.sub(f.tb,f.ta),R=s.sub(u.tb,u.ta);switch(v){case 0:g=s.dot(s.sub(u.ta,f.ta),D)/s.dot(D,D),g=g<0?0:g>1?1:g,P=0;break;case 1:g=s.dot(s.sub(u.tb,f.ta),D)/s.dot(D,D),g=g<0?0:g>1?1:g,P=1;break;case 2:g=0,P=s.dot(s.sub(f.ta,u.ta),R)/s.dot(R,R),P=P<0?0:P>1?1:P;break;case 3:g=1,P=s.dot(s.sub(f.tb,u.ta),R)/s.dot(R,R),P=P<0?0:P>1?1:P;break}var F=s.mad(f.ta,D,g),X=s.mad(u.ta,R,P);return i(F,f.r,X,u.r,l)}function d(f,u,l,p,x){for(var b=s.cross(u.tn,u.ta),v=s.cross(u.tn,u.tb),g=s.scale(u.tn,x),P=0;P<l.verts.length;P++){var D=l.tverts[P];if(s.dot(D,g)<s.dot(u.tn,u.ta)*x+u.r){var R=s.cross(u.tn,D);b>=R&&R>=v&&f.push(new H(D,g,p,l.id<<16|P))}}}function c(f,u,l){var p=s.dot(f.tn,f.ta),x=u.distanceOnPlane(f.tn,p)-f.r;if(x>0)return 0;var b=u.distanceOnPlane(s.neg(f.tn),-p)-f.r;if(b>0)return 0;for(var v=-999999,g=-1,P=0;P<u.verts.length;P++){var D=u.tplanes[P],R=f.distanceOnPlane(D.n,D.d);if(R>0)return 0;R>v&&(v=R,g=P)}var F=s.neg(u.tplanes[g].n),X=s.mad(f.ta,F,f.r),K=s.mad(f.tb,F,f.r);if(u.containPoint(X)&&l.push(new H(X,F,v,f.id<<16|0)),u.containPoint(K)&&l.push(new H(K,F,v,f.id<<16|1)),v-=.1,(x>=v||b>=v)&&(x>b?d(l,f,u,x,1):d(l,f,u,b,-1)),l.length==0){var it=u.tverts[g],st=u.tverts[(g+1)%u.verts.length];if(i(f.ta,f.r,it,0,l)||i(f.tb,f.r,it,0,l)||i(f.ta,f.r,st,0,l)||i(f.tb,f.r,st,0,l))return 1}return l.length}function y(f,u,l){for(var p=-999999,x=-1,b=0;b<l;b++){var v=f.distanceOnPlane(u[b].n,u[b].d);if(v>0)return{dist:0,index:-1};v>p&&(p=v,x=b)}return{dist:p,index:x}}function w(f,u,l,p,x){for(var b=0,v=0;v<u.verts.length;v++){var g=u.tverts[v];l.containPointPartial(g,p)&&(f.push(new H(g,p,x,u.id<<16|v)),b++)}for(var v=0;v<l.verts.length;v++){var g=l.tverts[v];u.containPointPartial(g,p)&&(f.push(new H(g,p,x,l.id<<16|v)),b++)}return b}function m(f,u,l,p,x){for(var b=0,v=0;v<u.verts.length;v++){var g=u.tverts[v];l.containPoint(g)&&(f.push(new H(g,p,x,u.id<<16|v)),b++)}for(var v=0;v<l.verts.length;v++){var g=l.tverts[v];u.containPoint(g)&&(f.push(new H(g,p,x,l.id<<16|v)),b++)}return b>0?b:w(f,u,l,p,x)}function C(f,u,l){var p=y(u,f.tplanes,f.verts.length);if(p.index==-1)return 0;var x=y(f,u.tplanes,u.verts.length);return x.index==-1?0:p.dist>x.dist?m(l,f,u,f.tplanes[p.index].n,p.dist):m(l,f,u,s.neg(u.tplanes[x.index].n),x.dist)}U.init=function(){r(A.TYPE_CIRCLE,A.TYPE_CIRCLE,e),r(A.TYPE_CIRCLE,A.TYPE_SEGMENT,n),r(A.TYPE_CIRCLE,A.TYPE_POLY,o),r(A.TYPE_SEGMENT,A.TYPE_SEGMENT,h),r(A.TYPE_SEGMENT,A.TYPE_POLY,c),r(A.TYPE_POLY,A.TYPE_POLY,C)},U.collide=function(f,u,l){if(f.type>u.type){var p=f;f=u,u=p}return t[f.type*A.NUM_TYPES+u.type](f,u,l)}})();function et(t,r){return Math.PI*(t*t-r*r)}function nt(t,r,i,e){return t*((i*i+e*e)*.5+r.lengthsq())}function ot(t,r,i){return i*(Math.PI*i+2*s.dist(t,r))}function at(t,r){return s.scale(s.add(t,r),.5)}function ht(t,r,i){var e=s.distsq(i,r),n=s.scale(s.add(r,i),.5);return t*(e/12+n.lengthsq())}function ut(t){for(var r=0,i=0;i<t.length;i++)r+=s.cross(t[i],t[(i+1)%t.length]);return r/2}function ft(t){for(var r=0,i=new s(0,0),e=0;e<t.length;e++){var n=t[e],o=t[(e+1)%t.length],a=s.cross(n,o);r+=a,i.addself(s.scale(s.add(n,o),a))}return s.scale(i,1/(3*r))}function dt(t,r,i){for(var e=0,n=0,o=0;o<r.length;o++){var a=s.add(r[o],i),h=s.add(r[(o+1)%r.length],i),d=s.cross(h,a),c=s.dot(a,a)+s.dot(a,h)+s.dot(h,h);e+=d*c,n+=d}return t*e/(6*n)}var z=function(t,r,i){A.call(this,A.TYPE_CIRCLE),this.c=new s(t||0,r||0),this.r=i,this.tc=s.zero,this.finishVerts()};z.prototype=new A;z.prototype.constructor=z;z.prototype.finishVerts=function(){this.r=Math.abs(this.r)};z.prototype.duplicate=function(){return new z(this.c.x,this.c.y,this.r)};z.prototype.serialize=function(){return{type:"ShapeCircle",e:this.e,u:this.u,density:this.density,center:this.c,radius:this.r}};z.prototype.recenter=function(t){this.c.subself(t)};z.prototype.transform=function(t){this.c=t.transform(this.c)};z.prototype.untransform=function(t){this.c=t.untransform(this.c)};z.prototype.area=function(){return et(this.r,0)};z.prototype.centroid=function(){return this.c.duplicate()};z.prototype.inertia=function(t){return nt(t,this.c,this.r,0)};z.prototype.cacheData=function(t){this.tc=t.transform(this.c),this.bounds.mins.set(this.tc.x-this.r,this.tc.y-this.r),this.bounds.maxs.set(this.tc.x+this.r,this.tc.y+this.r)};z.prototype.pointQuery=function(t){return s.distsq(this.tc,t)<this.r*this.r};z.prototype.findVertexByPoint=function(t,r){var i=r*r;return s.distsq(this.tc,t)<i?0:-1};z.prototype.distanceOnPlane=function(t,r){return s.dot(t,this.tc)-this.r-r};var B=function(t,r,i){A.call(this,A.TYPE_SEGMENT),this.a=t.duplicate(),this.b=r.duplicate(),this.r=i,this.n=s.perp(s.sub(r,t)),this.n.normalize(),this.ta=s.zero,this.tb=s.zero,this.tn=s.zero,this.finishVerts()};B.prototype=new A;B.prototype.constructor=B;B.prototype.finishVerts=function(){this.n=s.perp(s.sub(this.b,this.a)),this.n.normalize(),this.r=Math.abs(this.r)};B.prototype.duplicate=function(){return new B(this.a,this.b,this.r)};B.prototype.serialize=function(){return{type:"ShapeSegment",e:this.e,u:this.u,density:this.density,a:this.a,b:this.b,radius:this.r}};B.prototype.recenter=function(t){this.a.subself(t),this.b.subself(t)};B.prototype.transform=function(t){this.a=t.transform(this.a),this.b=t.transform(this.b)};B.prototype.untransform=function(t){this.a=t.untransform(this.a),this.b=t.untransform(this.b)};B.prototype.area=function(){return ot(this.a,this.b,this.r)};B.prototype.centroid=function(){return at(this.a,this.b)};B.prototype.inertia=function(t){return ht(t,this.a,this.b)};B.prototype.cacheData=function(t){if(this.ta=t.transform(this.a),this.tb=t.transform(this.b),this.tn=s.perp(s.sub(this.tb,this.ta)).normalize(),this.ta.x<this.tb.x)var r=this.ta.x,i=this.tb.x;else var r=this.tb.x,i=this.ta.x;if(this.ta.y<this.tb.y)var e=this.ta.y,n=this.tb.y;else var e=this.tb.y,n=this.ta.y;this.bounds.mins.set(r-this.r,e-this.r),this.bounds.maxs.set(i+this.r,n+this.r)};B.prototype.pointQuery=function(t){if(!this.bounds.containPoint(t))return!1;var r=s.dot(this.tn,t)-s.dot(this.ta,this.tn),i=Math.abs(r);if(i>this.r)return!1;var e=s.cross(t,this.tn),n=s.cross(this.ta,this.tn),o=s.cross(this.tb,this.tn);return e<=n?e<n-this.r?!1:s.distsq(this.ta,t)<this.r*this.r:e>o?e>o+this.r?!1:s.distsq(this.tb,t)<this.r*this.r:!0};B.prototype.findVertexByPoint=function(t,r){var i=r*r;return s.distsq(this.ta,t)<i?0:s.distsq(this.tb,t)<i?1:-1};B.prototype.distanceOnPlane=function(t,r){var i=s.dot(t,this.ta)-this.r,e=s.dot(t,this.tb)-this.r;return Math.min(i,e)-r};var L=function(t){if(A.call(this,A.TYPE_POLY),this.verts=[],this.planes=[],this.tverts=[],this.tplanes=[],t)for(var r=0;r<t.length;r++)this.verts[r]=t[r].duplicate(),this.tverts[r]=this.verts[r],this.tplanes[r]={},this.tplanes[r].n=s.zero,this.tplanes[r].d=0;this.finishVerts()};L.prototype=new A;L.prototype.constructor=L;L.prototype.finishVerts=function(){if(this.verts.length<2){this.convexity=!1,this.planes=[];return}this.convexity=!0,this.tverts=[],this.tplanes=[];for(var t=0;t<this.verts.length;t++){var r=this.verts[t],i=this.verts[(t+1)%this.verts.length],e=s.normalize(s.perp(s.sub(r,i)));this.planes[t]={},this.planes[t].n=e,this.planes[t].d=s.dot(e,r),this.tverts[t]=this.verts[t],this.tplanes[t]={},this.tplanes[t].n=s.zero,this.tplanes[t].d=0}for(var t=0;t<this.verts.length;t++){var i=this.verts[(t+2)%this.verts.length],e=this.planes[t].n,n=this.planes[t].d;s.dot(e,i)-n>0&&(this.convexity=!1)}};L.prototype.duplicate=function(){return new L(this.verts)};L.prototype.serialize=function(){return{type:"ShapePoly",e:this.e,u:this.u,density:this.density,verts:this.verts}};L.prototype.recenter=function(t){for(var r=0;r<this.verts.length;r++)this.verts[r].subself(t)};L.prototype.transform=function(t){for(var r=0;r<this.verts.length;r++)this.verts[r]=t.transform(this.verts[r])};L.prototype.untransform=function(t){for(var r=0;r<this.verts.length;r++)this.verts[r]=t.untransform(this.verts[r])};L.prototype.area=function(){return ut(this.verts)};L.prototype.centroid=function(){return ft(this.verts)};L.prototype.inertia=function(t){return dt(t,this.verts,s.zero)};L.prototype.cacheData=function(t){this.bounds.clear();var r=this.verts.length;if(r!=0){for(var i=0;i<r;i++)this.tverts[i]=t.transform(this.verts[i]);if(r<2){this.bounds.addPoint(this.tverts[0]);return}for(var i=0;i<r;i++){var e=this.tverts[i],n=this.tverts[(i+1)%r],o=s.normalize(s.perp(s.sub(e,n)));this.tplanes[i].n=o,this.tplanes[i].d=s.dot(o,e),this.bounds.addPoint(e)}}};L.prototype.pointQuery=function(t){return this.bounds.containPoint(t)?this.containPoint(t):!1};L.prototype.findVertexByPoint=function(t,r){for(var i=r*r,e=0;e<this.tverts.length;e++)if(s.distsq(this.tverts[e],t)<i)return e;return-1};L.prototype.findEdgeByPoint=function(t,r){for(var i=r*r,e=this.tverts.length,n=0;n<this.tverts.length;n++){var o=this.tverts[n],a=this.tverts[(n+1)%e],h=this.tplanes[n].n,d=s.cross(o,h),c=s.cross(a,h),y=s.cross(t,h);if(y>d){if(s.distsq(o,t)<i)return n}else if(y<c){if(s.distsq(a,t)<i)return n}else{var w=s.dot(h,t)-s.dot(h,o);if(w*w<i)return n}}return-1};L.prototype.distanceOnPlane=function(t,r){for(var i=999999,e=0;e<this.verts.length;e++)i=Math.min(i,s.dot(t,this.tverts[e]));return i-r};L.prototype.containPoint=function(t){for(var r=0;r<this.verts.length;r++){var i=this.tplanes[r];if(s.dot(i.n,t)-i.d>0)return!1}return!0};L.prototype.containPointPartial=function(t,r){for(var i=0;i<this.verts.length;i++){var e=this.tplanes[i];if(!(s.dot(e.n,r)<1e-4)&&s.dot(e.n,t)-e.d>0)return!1}return!0};var _=function(t,r,i){_.id_counter==null&&(_.id_counter=0),this.id=_.id_counter++,this.name="body"+this.id,this.type=t,r=r||new s(0,0),i=i||0,this.xf=new W(r,i),this.centroid=new s(0,0),this.p=new s(r.x,r.y),this.v=new s(0,0),this.f=new s(0,0),this.a=i,this.w=0,this.t=0,this.linearDamping=0,this.angularDamping=0,this.sleepTime=0,this.awaked=!1,this.shapeArr=[],this.jointArr=[],this.jointHash={},this.bounds=new E,this.fixedRotation=!1,this.categoryBits=1,this.maskBits=65535,this.stepCount=0};_.STATIC=0;_.KINETIC=1;_.DYNAMIC=2;_.prototype.duplicate=function(){for(var t=new _(this.type,this.xf.t,this.a),r=0;r<this.shapeArr.length;r++)t.addShape(this.shapeArr[r].duplicate());return t.resetMassData(),t};_.prototype.serialize=function(){for(var t=[],r=0;r<this.shapeArr.length;r++){var i=this.shapeArr[r].serialize();t.push(i)}return{type:["static","kinetic","dynamic"][this.type],name:this.name,position:this.xf.t,angle:this.xf.a,shapes:t}};_.prototype.isStatic=function(){return this.type==_.STATIC};_.prototype.isDynamic=function(){return this.type==_.DYNAMIC};_.prototype.isKinetic=function(){return this.type==_.KINETIC};_.prototype.setType=function(t){t!=this.type&&(this.f.set(0,0),this.v.set(0,0),this.t=0,this.w=0,this.type=t,this.awake(!0))};_.prototype.addShape=function(t){t.body=this,this.shapeArr.push(t)};_.prototype.removeShape=function(t){var r=this.shapeArr.indexOf(t);r!=-1&&(this.shapeArr.splice(r,1),t.body=void 0)};_.prototype.setMass=function(t){this.m=t,this.m_inv=t>0?1/t:0};_.prototype.setInertia=function(t){this.i=t,this.i_inv=t>0?1/t:0};_.prototype.setTransform=function(t,r){this.xf.set(t,r),this.p=this.xf.transform(this.centroid),this.a=r};_.prototype.syncTransform=function(){this.xf.setRotation(this.a),this.xf.setPosition(s.sub(this.p,this.xf.rotate(this.centroid)))};_.prototype.getWorldPoint=function(t){return this.xf.transform(t)};_.prototype.getWorldVector=function(t){return this.xf.rotate(t)};_.prototype.getLocalPoint=function(t){return this.xf.untransform(t)};_.prototype.getLocalVector=function(t){return this.xf.unrotate(t)};_.prototype.setFixedRotation=function(t){this.fixedRotation=t,this.resetMassData()};_.prototype.resetMassData=function(){if(this.centroid.set(0,0),this.m=0,this.m_inv=0,this.i=0,this.i_inv=0,!this.isDynamic()){this.p=this.xf.transform(this.centroid);return}for(var t=new s(0,0),r=0,i=0,e=0;e<this.shapeArr.length;e++){var n=this.shapeArr[e],o=n.centroid(),a=n.area()*n.density,h=n.inertia(a);t.mad(o,a),r+=a,i+=h}this.centroid.copy(s.scale(t,1/r)),this.setMass(r),this.fixedRotation||this.setInertia(i-r*s.dot(this.centroid,this.centroid));var d=this.p;this.p=this.xf.transform(this.centroid),this.v.mad(s.perp(s.sub(this.p,d)),this.w)};_.prototype.resetJointAnchors=function(){for(var t=0;t<this.jointArr.length;t++){var r=this.jointArr[t];if(r){var i=r.getWorldAnchor1(),e=r.getWorldAnchor2();r.setWorldAnchor1(i),r.setWorldAnchor2(e)}}};_.prototype.cacheData=function(){this.bounds.clear();for(var t=0;t<this.shapeArr.length;t++){var r=this.shapeArr[t];r.cacheData(this.xf),this.bounds.addBounds(r.bounds)}};_.prototype.updateVelocity=function(t,r,i){this.v=s.mad(this.v,s.mad(t,this.f,this.m_inv),r),this.w=this.w+this.t*this.i_inv*r,this.v.scale(Math.clamp(1-r*(i+this.linearDamping),0,1)),this.w*=Math.clamp(1-r*(i+this.angularDamping),0,1),this.f.set(0,0),this.t=0};_.prototype.updatePosition=function(t){this.p.addself(s.scale(this.v,t)),this.a+=this.w*t};_.prototype.resetForce=function(){this.f.set(0,0),this.t=0};_.prototype.applyForce=function(t,r){this.isDynamic()&&(this.isAwake()||this.awake(!0),this.f.addself(t),this.t+=s.cross(s.sub(r,this.p),t))};_.prototype.applyForceToCenter=function(t){this.isDynamic()&&(this.isAwake()||this.awake(!0),this.f.addself(t))};_.prototype.applyTorque=function(t){this.isDynamic()&&(this.isAwake()||this.awake(!0),this.t+=t)};_.prototype.applyLinearImpulse=function(t,r){this.isDynamic()&&(this.isAwake()||this.awake(!0),this.v.mad(t,this.m_inv),this.w+=s.cross(s.sub(r,this.p),t)*this.i_inv)};_.prototype.applyAngularImpulse=function(t){this.isDynamic()&&(this.isAwake()||this.awake(!0),this.w+=t*this.i_inv)};_.prototype.kineticEnergy=function(){var t=this.v.dot(this.v),r=this.w*this.w;return .5*(this.m*t+this.i*r)};_.prototype.isAwake=function(){return this.awaked};_.prototype.awake=function(t){this.awaked=t,t?this.sleepTime=0:(this.v.set(0,0),this.w=0,this.f.set(0,0),this.t=0)};_.prototype.isCollidable=function(t){if(this==t||!this.isDynamic()&&!t.isDynamic()||!(this.maskBits&t.categoryBits)||!(t.maskBits&this.categoryBits))return!1;for(var r=0;r<this.jointArr.length;r++){var i=this.jointArr[r];if(i&&!i.collideConnected&&t.jointHash[i.id]!=null)return!1}return!0};var S=function(t,r,i,e){arguments.length!=0&&(S.id_counter==null&&(S.id_counter=0),this.id=S.id_counter++,this.type=t,this.body1=r,this.body2=i,this.collideConnected=e,this.maxForce=9999999999,this.breakable=!1)};S.TYPE_ANGLE=0;S.TYPE_REVOLUTE=1;S.TYPE_WELD=2;S.TYPE_WHEEL=3;S.TYPE_PRISMATIC=4;S.TYPE_DISTANCE=5;S.TYPE_ROPE=6;S.TYPE_MOUSE=7;S.LINEAR_SLOP=8e-4;S.ANGULAR_SLOP=Z(2);S.MAX_LINEAR_CORRECTION=.5;S.MAX_ANGULAR_CORRECTION=Z(8);S.LIMIT_STATE_INACTIVE=0;S.LIMIT_STATE_AT_LOWER=1;S.LIMIT_STATE_AT_UPPER=2;S.LIMIT_STATE_EQUAL_LIMITS=3;S.prototype.getWorldAnchor1=function(){return this.body1.getWorldPoint(this.anchor1)};S.prototype.getWorldAnchor2=function(){return this.body2.getWorldPoint(this.anchor2)};S.prototype.setWorldAnchor1=function(t){this.anchor1=this.body1.getLocalPoint(t)};S.prototype.setWorldAnchor2=function(t){this.anchor2=this.body2.getLocalPoint(t)};function Y(t,r){this.shape1=t,this.shape2=r,this.contactArr=[],this.e=1,this.u=1}Y.COLLISION_SLOP=8e-4;Y.BAUMGARTE=.28;Y.MAX_LINEAR_CORRECTION=1;Y.prototype.update=function(t){for(var r=0;r<t.length;r++){for(var i=t[r],e=-1,n=0;n<this.contactArr.length;n++)if(i.hash==this.contactArr[n].hash){e=n;break}e>-1&&(i.lambda_n_acc=this.contactArr[e].lambda_n_acc,i.lambda_t_acc=this.contactArr[e].lambda_t_acc)}this.contactArr=t};Y.prototype.initSolver=function(t){for(var r=this.shape1.body,i=this.shape2.body,e=r.m_inv+i.m_inv,n=0;n<this.contactArr.length;n++){var o=this.contactArr[n];o.r1=s.sub(o.p,r.p),o.r2=s.sub(o.p,i.p),o.r1_local=r.xf.unrotate(o.r1),o.r2_local=i.xf.unrotate(o.r2);var a=o.n,h=s.perp(o.n),d=s.cross(o.r1,a),c=s.cross(o.r2,a),y=e+r.i_inv*d*d+i.i_inv*c*c;o.emn=y==0?0:1/y;var w=s.cross(o.r1,h),m=s.cross(o.r2,h),C=e+r.i_inv*w*w+i.i_inv*m*m;o.emt=C==0?0:1/C;var f=s.mad(r.v,s.perp(o.r1),r.w),u=s.mad(i.v,s.perp(o.r2),i.w),l=s.sub(u,f);o.bounce=s.dot(l,o.n)*this.e}};Y.prototype.warmStart=function(){for(var t=this.shape1.body,r=this.shape2.body,i=0;i<this.contactArr.length;i++){var e=this.contactArr[i],n=e.n,o=e.lambda_n_acc,a=e.lambda_t_acc,h=new s(o*n.x-a*n.y,a*n.x+o*n.y);t.v.mad(h,-t.m_inv),t.w-=s.cross(e.r1,h)*t.i_inv,r.v.mad(h,r.m_inv),r.w+=s.cross(e.r2,h)*r.i_inv}};Y.prototype.solveVelocityConstraints=function(){for(var t=this.shape1.body,r=this.shape2.body,i=t.m_inv,e=t.i_inv,n=r.m_inv,o=r.i_inv,a=0;a<this.contactArr.length;a++){var h=this.contactArr[a],d=h.n,c=s.perp(d),y=h.r1,w=h.r2,m=s.mad(t.v,s.perp(y),t.w),C=s.mad(r.v,s.perp(w),r.w),f=s.sub(C,m),u=-h.emn*(s.dot(d,f)+h.bounce),l=h.lambda_n_acc;h.lambda_n_acc=Math.max(l+u,0),u=h.lambda_n_acc-l;var p=-h.emt*s.dot(c,f),x=h.lambda_n_acc*this.u,b=h.lambda_t_acc;h.lambda_t_acc=Math.clamp(b+p,-x,x),p=h.lambda_t_acc-b;var v=new s(u*d.x-p*d.y,p*d.x+u*d.y);t.v.mad(v,-i),t.w-=s.cross(y,v)*e,r.v.mad(v,n),r.w+=s.cross(w,v)*o}};Y.prototype.solvePositionConstraints=function(){for(var t=this.shape1.body,r=this.shape2.body,i=t.m_inv,e=t.i_inv,n=r.m_inv,o=r.i_inv,a=i+n,h=0,d=0;d<this.contactArr.length;d++){var c=this.contactArr[d],y=c.n,w=s.rotate(c.r1_local,t.a),m=s.rotate(c.r2_local,r.a),C=s.add(t.p,w),f=s.add(r.p,m),u=s.sub(f,C),l=s.dot(u,y)+c.d,p=Math.clamp(Y.BAUMGARTE*(l+Y.COLLISION_SLOP),-Y.MAX_LINEAR_CORRECTION,0);if(p!=0){h=Math.max(h,-l);var x=s.cross(w,y),b=s.cross(m,y),v=a+t.i_inv*x*x+r.i_inv*b*b,g=v==0?0:-p/v,P=s.scale(y,g);t.p.mad(P,-i),t.a-=x*g*e,r.p.mad(P,n),r.a+=b*g*o}}return h<=Y.COLLISION_SLOP*3};var k={};function T(){this.bodyArr=[],this.bodyHash={},this.jointArr=[],this.jointHash={},this.numContacts=0,this.contactSolverArr=[],this.postSolve=function(t){},this.gravity=new s(0,0),this.damping=0}T.TIME_TO_SLEEP=.5;T.SLEEP_LINEAR_TOLERANCE=.5;T.SLEEP_ANGULAR_TOLERANCE=Z(2);T.prototype.clear=function(){A.id_counter=0,_.id_counter=0,S.id_counter=0;for(var t=0;t<this.bodyArr.length;t++)this.bodyArr[t]&&this.removeBody(this.bodyArr[t]);this.bodyArr=[],this.bodyHash={},this.jointArr=[],this.jointHash={},this.contactSolverArr=[],this.stepCount=0};T.prototype.toJSON=function(t){for(var r=[],i=0;i<this.bodyArr.length;i++)this.bodyArr[i]&&r.push(this.bodyArr[i].serialize());for(var e=[],i=0;i<this.jointArr.length;i++)this.jointArr[i]&&e.push(this.jointHash[i].serialize());return{bodies:r,joints:e}};T.prototype.create=function(t){var r=JSON.parse(t);this.clear();for(var i=0;i<r.bodies.length;i++){for(var e=r.bodies[i],n={static:_.Static,kinetic:_.KINETIC,dynamic:_.DYNAMIC}[e.type],o=new _(n,e.position.x,e.position.y,e.angle),a=0;a<e.shapes.length;a++){var h=e.shapes[a],d;switch(h.type){case"ShapeCircle":d=new z(h.center.x,h.center.y,h.radius);break;case"ShapeSegment":d=new B(h.a,h.b,h.radius);break;case"ShapePoly":d=new L(h.verts);break}d.e=h.e,d.u=h.u,d.density=h.density,o.addShape(d)}o.resetMassData(),this.addBody(o)}for(var i=0;i<r.joints.length;i++){var c=r.joints[i],y=this.bodyArr[this.bodyHash[c.body1]],w=this.bodyArr[this.bodyHash[c.body2]],m;switch(c.type){case"AngleJoint":m=new AngleJoint(y,w);break;case"RevoluteJoint":m=new RevoluteJoint(y,w,c.anchor),m.enableLimit(c.limitEnabled),m.setLimits(c.limitLowerAngle,c.limitUpperAngle),m.enableMotor(c.motorEnabled),m.setMotorSpeed(c.motorSpeed),m.setMaxMotorTorque(c.maxMotorTorque);break;case"WeldJoint":m=new WeldJoint(y,w,c.anchor),m.setSpringFrequencyHz(c.frequencyHz),m.setSpringDampingRatio(c.dampingRatio);break;case"WheelJoint":m=new WheelJoint(y,w,c.anchor1,c.anchor2),m.enableMotor(c.motorEnabled),m.setMotorSpeed(c.motorSpeed),m.setMaxMotorTorque(c.maxMotorTorque);break;case"PrismaticJoint":m=new PrismaticJoint(y,w,c.anchor1,c.anchor2);break;case"DistanceJoint":m=new DistanceJoint(y,w,c.anchor1,c.anchor2),m.setSpringFrequencyHz(c.frequencyHz),m.setSpringDampingRatio(c.dampingRatio);break;case"RopeJoint":m=new RopeJoint(y,w,c.anchor1,c.anchor2);break}m.collideConnected=c.collideConnected,m.maxForce=c.maxForce,m.breakable=c.breakable,this.addJoint(m)}};T.prototype.addBody=function(t){if(this.bodyHash[t.id]==null){var r=this.bodyArr.push(t)-1;this.bodyHash[t.id]=r,t.awake(!0),t.world=this,t.cacheData()}};T.prototype.removeBody=function(t){if(this.bodyHash[t.id]!=null){for(var r=0;r<t.jointArr.length;r++)t.jointArr[r]&&this.removeJoint(t.jointArr[r]);t.world=null;var i=this.bodyHash[t.id];delete this.bodyHash[t.id],delete this.bodyArr[i]}};T.prototype.addJoint=function(t){if(this.jointHash[t.id]==null){t.body1.awake(!0),t.body2.awake(!0);var r=this.jointArr.push(t)-1;this.jointHash[t.id]=r;var r=t.body1.jointArr.push(t)-1;t.body1.jointHash[t.id]=r;var r=t.body2.jointArr.push(t)-1;t.body2.jointHash[t.id]=r}};T.prototype.removeJoint=function(t){if(this.jointHash[t.id]!=null){t.body1.awake(!0),t.body2.awake(!0);var r=t.body1.jointHash[t.id];delete t.body1.jointHash[t.id],delete t.body1.jointArr[r];var r=t.body2.jointHash[t.id];delete t.body2.jointHash[t.id],delete t.body2.jointArr[r];var r=this.jointHash[t.id];delete this.jointHash[t.id],delete this.jointArr[r]}};T.prototype.findShapeByPoint=function(t,r){for(var i,e=0;e<this.bodyArr.length;e++){var n=this.bodyArr[e];if(n)for(var o=0;o<n.shapeArr.length;o++){var a=n.shapeArr[o];if(a.pointQuery(t)){if(!r)return a;i||(i=a),a==r&&(r=null)}}}return i};T.prototype.findBodyByPoint=function(t,r){for(var i,e=0;e<this.bodyArr.length;e++){var n=this.bodyArr[e];if(n)for(var o=0;o<n.shapeArr.length;o++){var a=n.shapeArr[o];if(a.pointQuery(t)){if(!r)return a.body;i||(i=a.body),a.body==r&&(r=null);break}}}return i};T.prototype.shapeById=function(t){for(var r,i=0;i<this.bodyArr.length;i++){var e=this.bodyArr[i];if(e){for(var n=0;n<e.shapeArr.length;n++)if(e.shapeArr[n].id==t)return e.shapeArr[n]}}return null};T.prototype.jointById=function(t){var r=this.jointHash[t];return r!=null?this.jointArr[r]:null};T.prototype.findVertexByPoint=function(t,r,i){var e=-1;i=i||-1;for(var n=0;n<this.bodyArr.length;n++){var o=this.bodyArr[n];if(o)for(var a=0;a<o.shapeArr.length;a++){var h=o.shapeArr[a],d=h.findVertexByPoint(t,r);if(d!=-1){var c=h.id<<16|d;if(i==-1)return c;e==-1&&(e=c),c==i&&(i=-1)}}}return e};T.prototype.findEdgeByPoint=function(t,r,i){var e=-1;i=i||-1;for(var n=0;n<this.bodyArr.length;n++){var o=this.bodyArr[n];if(o)for(var a=0;a<o.shapeArr.length;a++){var h=o.shapeArr[a];if(h.type==A.TYPE_POLY){var d=h.findEdgeByPoint(t,r);if(d!=-1){var c=h.id<<16|d;if(i==-1)return c;e==-1&&(e=c),c==i&&(i=-1)}}}}return e};T.prototype.findJointByPoint=function(t,r,i){var e=-1,n=r*r;i=i||-1;for(var o=0;o<this.jointArr.length;o++){var a=this.jointArr[o];if(a){var h=-1;if(s.distsq(t,a.getWorldAnchor1())<n?h=a.id<<16|0:s.distsq(t,a.getWorldAnchor2())<n&&(h=a.id<<16|1),h!=-1){if(i==-1)return h;e==-1&&(e=h),h==i&&(i=-1)}}}return e};T.prototype.findContactSolver=function(t,r){for(var i=0;i<this.contactSolverArr.length;i++){var e=this.contactSolverArr[i];if(t==e.shape1&&r==e.shape2)return e}return null};T.prototype.genTemporalContactSolvers=function(){var t=Date.now(),r=[];this.numContacts=0;for(var i=0;i<this.bodyArr.length;i++){var e=this.bodyArr[i];if(e){e.stepCount=this.stepCount;for(var n=0;n<this.bodyArr.length;n++){var o=this.bodyArr[n];if(o&&e.stepCount!=o.stepCount){var a=e.isAwake()&&!e.isStatic(),h=o.isAwake()&&!o.isStatic();if(!(!a&&!h)&&e.isCollidable(o)&&e.bounds.intersectsBounds(o.bounds))for(var d=0;d<e.shapeArr.length;d++)for(var c=0;c<o.shapeArr.length;c++){var y=e.shapeArr[d],w=o.shapeArr[c],m=[];if(U.collide(y,w,m)){if(y.type>w.type){var C=y;y=w,w=C}this.numContacts+=m.length;var f=this.findContactSolver(y,w);if(f)f.update(m),r.push(f);else{e.awake(!0),o.awake(!0);var u=new Y(y,w);u.contactArr=m,u.e=Math.max(y.e,w.e),u.u=Math.sqrt(y.u*w.u),r.push(u)}}}}}}}return k.timeCollision=Date.now()-t,r};T.prototype.initSolver=function(t,r,i){for(var e=Date.now(),n=0;n<this.contactSolverArr.length;n++)this.contactSolverArr[n].initSolver(r);for(var n=0;n<this.jointArr.length;n++)this.jointArr[n]&&this.jointArr[n].initSolver(t,i);if(i)for(var n=0;n<this.contactSolverArr.length;n++)this.contactSolverArr[n].warmStart();k.timeInitSolver=Date.now()-e};T.prototype.velocitySolver=function(t){for(var r=Date.now(),i=0;i<t;i++){for(var e=0;e<this.jointArr.length;e++)this.jointArr[e]&&this.jointArr[e].solveVelocityConstraints();for(var e=0;e<this.contactSolverArr.length;e++)this.contactSolverArr[e].solveVelocityConstraints()}k.timeVelocitySolver=Date.now()-r};T.prototype.positionSolver=function(t){var r=Date.now(),i=!1;k.positionIterations=0;for(var e=0;e<t;e++){for(var n=!0,o=!0,a=0;a<this.contactSolverArr.length;a++){var h=this.contactSolverArr[a].solvePositionConstraints();n=h&&n}for(var a=0;a<this.jointArr.length;a++)if(this.jointArr[a]){var d=this.jointArr[a].solvePositionConstraints();o=d&&o}if(n&&o){i=!0;break}k.positionIterations++}return k.timePositionSolver=Date.now()-r,i};T.prototype.step=function(t,r,i,e,n){var o=1/t;this.stepCount++,this.contactSolverArr=this.genTemporalContactSolvers(),this.initSolver(t,o,e);for(var a=0;a<this.bodyArr.length;a++){var h=this.bodyArr[a];h&&h.isDynamic()&&h.isAwake()&&h.updateVelocity(this.gravity,t,this.damping)}for(var a=0;a<this.jointArr.length;a++){var d=this.jointArr[a];if(d){var c=d.body1,y=d.body2,w=c.isAwake()&&!c.isStatic(),m=y.isAwake()&&!y.isStatic();w^m&&(w||c.awake(!0),m||y.awake(!0))}}this.velocitySolver(r);for(var a=0;a<this.bodyArr.length;a++){var h=this.bodyArr[a];h&&h.isDynamic()&&h.isAwake()&&h.updatePosition(t)}for(var a=0;a<this.jointArr.length;a++){var d=this.jointArr[a];d&&d.breakable&&d.getReactionForce(o).lengthsq()>=d.maxForce*d.maxForce&&this.removeJoint(d)}for(var C=this.positionSolver(i),a=0;a<this.bodyArr.length;a++){var h=this.bodyArr[a];h&&h.syncTransform()}for(var a=0;a<this.contactSolverArr.length;a++){var f=this.contactSolverArr[a];this.postSolve(f)}for(var a=0;a<this.bodyArr.length;a++){var h=this.bodyArr[a];h&&h.isDynamic()&&h.isAwake()&&h.cacheData()}if(n){for(var u=999999,l=T.SLEEP_LINEAR_TOLERANCE*T.SLEEP_LINEAR_TOLERANCE,p=T.SLEEP_ANGULAR_TOLERANCE*T.SLEEP_ANGULAR_TOLERANCE,a=0;a<this.bodyArr.length;a++){var h=this.bodyArr[a];h&&h.isDynamic()&&(h.w*h.w>p||h.v.dot(h.v)>l?(h.sleepTime=0,u=0):(h.sleepTime+=t,u=Math.min(u,h.sleepTime)))}if(C&&u>=T.TIME_TO_SLEEP)for(var a=0;a<this.bodyArr.length;a++){var h=this.bodyArr[a];h&&h.awake(!1)}}};var N=function(t,r,i){arguments.length!=0&&(S.call(this,S.TYPE_MOUSE,t,r,!0),this.anchor1=this.body1.getLocalPoint(i),this.anchor2=this.body2.getLocalPoint(i),this.gamma=0,this.beta_c=0,this.frequencyHz=5,this.dampingRatio=.9,this.lambda_acc=new s(0,0))};N.prototype=new S;N.prototype.constructor=N;N.prototype.setSpringFrequencyHz=function(t){this.frequencyHz=t};N.prototype.setSpringDampingRatio=function(t){this.dampingRatio=t};N.prototype.initSolver=function(t,r){var i=this.body1,e=this.body2;this.maxImpulse=this.maxForce*t;var n=2*Math.PI*this.frequencyHz,o=e.m*(n*n),a=e.m*2*this.dampingRatio*n;this.gamma=(a+o*t)*t,this.gamma=this.gamma==0?0:1/this.gamma;var h=t*o*this.gamma;this.r2=e.xf.rotate(s.sub(this.anchor2,e.centroid));var d=this.r2,c=d.y*e.i_inv,y=e.m_inv+d.y*c+this.gamma,w=-d.x*c,m=e.m_inv+d.x*d.x*e.i_inv+this.gamma;this.em_inv=new I(y,w,w,m);var C=s.sub(s.add(e.p,this.r2),i.p);this.beta_c=s.scale(C,h),e.w*=.98,r?(e.v.mad(this.lambda_acc,e.m_inv),e.w+=s.cross(this.r2,this.lambda_acc)*e.i_inv):this.lambda_acc.set(0,0)};N.prototype.solveVelocityConstraints=function(){var t=this.body2,r=s.mad(t.v,s.perp(this.r2),t.w),i=s.mad(this.beta_c,this.lambda_acc,this.gamma),e=this.em_inv.solve(s.add(r,i).neg()),n=this.lambda_acc.duplicate();this.lambda_acc.addself(e);var o=this.lambda_acc.lengthsq();o>this.maxImpulse*this.maxImpulse&&this.lambda_acc.scale(this.maxImpulse/Math.sqrt(o)),e=s.sub(this.lambda_acc,n),t.v.mad(e,t.m_inv),t.w+=s.cross(this.r2,e)*t.i_inv};N.prototype.solvePositionConstraints=function(){return!0};N.prototype.getReactionForce=function(t){return s.scale(this.lambda_acc,t)};N.prototype.getReactionTorque=function(t){return 0};var j=$(2.5),Q=$(1),ct=["#BEB","#48B","#CAA","#8D5","#6BE","#98D","#E78","#7BC","#E9E","#BCD","#EB6","#EE7"];function lt(t){return t.isDynamic()?t.isAwake()?ct[t.id%ct.length]:"#999":"#777"}function J(t,r,i={}){this.renderer=t,this.app=r,this.settings=Object.assign({gravity:new s(0,-10),frameRateHz:60,velocityIterations:8,positionIterations:4,warmStarting:!0,allowSleep:!0,enableDirtyBounds:!0,showJoints:!0,backgroundColor:"rgb(95, 105, 118)",jointAnchorColor:"#11cf00"},i),this.camera={origin:new s(0,0),scale:1,minScale:.5,maxScale:8,bounds:new E,scroll:new s(0,0)},this.dirtyBounds=new E,this.onResize=()=>{this.renderer.resize(),this.dirtyBounds.set(this.canvasToWorld(new s(0,this.renderer.height)),this.canvasToWorld(new s(this.renderer.width,0))),this.static_outdated=!0,this.pause&&this.drawFrame(0)},window.addEventListener("resize",this.onResize),window.addEventListener("orientationchange",this.onResize),this.onResize(),U.init(),this.world=new T,this.resetScene();let e=()=>{this.runFrame(),this.pause||window.requestAnimationFrame(e)};window.requestAnimationFrame(e)}J.prototype.destroy=function(){this.pause=!0,this.world.clear(),window.removeEventListener("resize",this.onResize),window.removeEventListener("orientationchange",this.onResize)};J.prototype.resetScene=function(){this.world.clear(),this.world.gravity.copy(this.settings.gravity),this.app.init(this.world),this.initFrame()};J.prototype.initFrame=function(){this.time={fps:0,fps_frameCount:0,fps_time:0,frameCount:0,lastTime:Date.now(),timeDelta:0},this.dirtyBounds.set(this.canvasToWorld(new s(0,this.renderer.height)),this.canvasToWorld(new s(this.renderer.width,0))),this.static_outdated=!0};J.prototype.runFrame=function(){var t=Date.now(),r=(t-this.time.lastTime)/1e3;if(r=Math.floor(r*60+.5)/60,this.time.lastTime=t,!this.pause||this.step){var i=1/this.settings.frameRateHz;this.time.timeDelta+=r,this.step&&(this.step=!1,this.time.timeDelta=i),k.timeStep=0,k.stepCount=0;for(var e=4;e>0&&this.time.timeDelta>=i;e--){var n=Date.now();this.world.step(i,this.settings.velocityIterations,this.settings.positionIterations,this.settings.warmStarting,this.settings.allowSleep),k.timeStep+=Date.now()-n,k.stepCount++,this.time.timeDelta-=i}this.time.timeDelta>i&&(this.time.timeDelta=0),this.app.runFrame()}k.stepCount>0&&this.render(r),this.time.frameCount++,this.time.fps_frameCount++,this.time.fps_time+=r,this.time.fps_time>=1&&(this.time.fps=this.time.fps_frameCount/this.time.fps_time,this.time.fps_time-=1,this.time.fps_frameCount=0)};J.prototype.render=function(t){var r=Date.now();this.drawFrame(t),k.timeDrawFrame=Date.now()-r};J.prototype.drawFrame=function(t){this.camera.bounds.set(this.canvasToWorld(new s(0,this.renderer.height)),this.canvasToWorld(new s(this.renderer.width,0)));for(var r=0;r<this.world.bodyArr.length;r++){var i=this.world.bodyArr[r];i.visible=!1;for(var e=0;e<i.shapeArr.length;e++){var n=i.shapeArr[e],o=new E(n.bounds.mins,n.bounds.maxs);this.camera.bounds.intersectsBounds(o)?(n.visible=!0,i.visible=!0):n.visible=!1}}if(this.static_outdated){this.static_outdated=!1,this.renderer.beginStatic(this.camera,this.settings.backgroundColor);for(var r=0;r<this.world.bodyArr.length;r++){var i=this.world.bodyArr[r];if(i.isStatic())for(var a=lt(i),h=0;h<i.shapeArr.length;h++){var n=i.shapeArr[h];n.visible&&this.renderer.drawShape(n,!0,Q,"#000",a)}}this.renderer.endStatic()}if(this.settings.enableDirtyBounds){if(!this.dirtyBounds.isEmpty()){var d=this.worldToCanvas(this.dirtyBounds.mins),c=this.worldToCanvas(this.dirtyBounds.maxs),y=Math.max(Math.floor(d.x),0),w=Math.max(Math.floor(c.y),0),m=Math.min(Math.ceil(c.x),this.renderer.width)-y,C=Math.min(Math.ceil(d.y),this.renderer.height)-w;m>0&&C>0&&this.renderer.copyBackground(y,w,m,C,y,w,m,C)}}else this.renderer.copyBackground(0,0);this.dirtyBounds.clear(),this.renderer.beginDynamic(this.camera);for(var r=0;r<this.world.bodyArr.length;r++){var i=this.world.bodyArr[r];if(i.visible&&!i.isStatic())for(var a=lt(i),h=0;h<i.shapeArr.length;h++){var n=i.shapeArr[h];if(n.visible){this.renderer.drawShape(n,!1,Q,"#000",a);var f=Q*3;this.dirtyBounds.addBounds(E.expand(n.bounds,f,f))}}}if(this.settings.showJoints)for(var r=0;r<this.world.jointArr.length;r++){var u=this.world.jointArr[r];if(u){var l=u.getWorldAnchor1(),p=u.getWorldAnchor2();this.renderer.drawHelperJointAnchors(l,p,j,Q,this.settings.jointAnchorColor);var o=new E;o.addExtents(l,j,j),o.addExtents(p,j,j),o.addPoint(l),o.addPoint(p),(!u.body1.isStatic()||!u.body2.isStatic())&&(o.expand(Q*2,Q*2),this.dirtyBounds.addBounds(o))}}this.renderer.endDynamic()};J.prototype.worldToCanvas=function(t){return new s(this.renderer.width*.5+(t.x*(this.camera.scale*q(1))-this.camera.origin.x),this.renderer.height-(t.y*(this.camera.scale*q(1))-this.camera.origin.y))};J.prototype.canvasToWorld=function(t){return new s((this.camera.origin.x+(t.x-this.renderer.width*.5))/(this.camera.scale*q(1)),(this.camera.origin.y-(t.y-this.renderer.height))/(this.camera.scale*q(1)))};function G(t){this.runner=t,this.state={mouseDown:!1,mouseDownMoving:!1,mouseDownPosition:new s,mousePositionOld:new s,touchPosOld:new Array(2),touchDist:void 0,gestureStartScale:void 0},this.mouseJoint=null,this.mouseBody=new _(_.KINETIC),this.mouseBody.resetMassData(),this.runner.world.addBody(this.mouseBody),this.mousedown=r=>{var i=this.getMousePosition(r);this.state.mouseDown=!0,this.state.mouseDownMoving=!1,this.state.mouseDownPosition.x=i.x,this.state.mouseDownPosition.y=i.y,this.removeJoint();var e=this.runner.canvasToWorld(i),n=this.runner.world.findBodyByPoint(e);n&&(this.mouseBody.p.copy(e),this.mouseBody.syncTransform(),this.mouseJoint=new N(this.mouseBody,n,e),this.mouseJoint.maxForce=n.m*1e3,this.runner.world.addJoint(this.mouseJoint)),this.state.mousePositionOld.x=i.x,this.state.mousePositionOld.y=i.y,r.preventDefault()},this.mousemove=r=>{var i=this.getMousePosition(r);if(i.x<0||i.x>this.runner.renderer.width||i.y<0||i.y>this.runner.renderer.height)return this.mouseleave(r);if(this.state.mouseDown)if(this.state.mouseDownMoving=!0,this.mouseJoint)this.mouseBody.p.copy(this.runner.canvasToWorld(i)),this.mouseBody.syncTransform();else{var e=i.x-this.state.mousePositionOld.x,n=i.y-this.state.mousePositionOld.y;this.scrollView(-e,n),this.state.mousePositionOld.x=i.x,this.state.mousePositionOld.y=i.y}r.preventDefault()},this.mouseup=this.mouseleave=r=>{this.removeJoint(),this.state.mouseDown=!1,this.state.mouseDownMoving=!1,r.preventDefault()},this.mousewheel=r=>{var i=0,e=0;r.detail?r.axis==r.HORIZONTAL_AXIS?i=-40*r.detail:e=-40*r.detail:r.wheelDeltaX?(i=r.wheelDeltaX,e=r.wheelDeltaY):r.wheelDelta&&(e=r.wheelDelta);var n=-e*.001,o=this.runner.camera.scale;this.runner.camera.scale=Math.clamp(o+n,this.runner.camera.minScale,this.runner.camera.maxScale),n=this.runner.camera.scale-o,n*=q(1);var a=this.runner.canvasToWorld(this.getMousePosition(r)),h=i*.2;this.scrollView(a.x*n-h,a.y*n),r.preventDefault()},this.touchstart=r=>{this.removeJoint(),r.touches.length===2&&(this.state.gestureStartScale=this.runner.camera.scale,this.state.touchPosOld[0]=this.getTouchPosition(r.touches[0]),this.state.touchPosOld[1]=this.getTouchPosition(r.touches[1]),this.state.touchDist=rt(this.state.touchPosOld[0].x,this.state.touchPosOld[0].y,this.state.touchPosOld[1].x,this.state.touchPosOld[1].y),r.preventDefault())},this.touchmove=r=>{if(r.touches.length===2){var i=this.getTouchPosition(r.touches[0]),e=this.getTouchPosition(r.touches[1]);if(i.x<0||i.x>this.runner.renderer.width||i.y<0||i.y>this.runner.renderer.height||e.x<0||e.x>this.runner.renderer.width||e.y<0||e.y>this.runner.renderer.height)return this.mouseleave(r);var n=rt(i.x,i.y,e.x,e.y)/this.state.touchDist,o=Math.clamp(n-1,-.1,.1),a=this.state.gestureStartScale*(n-o),h=s.sub(i,this.state.touchPosOld[0]),d=s.sub(e,this.state.touchPosOld[1]),c=h.length(),y=d.length();if(c>0||y>0){var w=this.runner.canvasToWorld(s.lerp(i,e,c/(c+y))),m=this.runner.camera.scale;this.runner.camera.scale=Math.clamp(a,this.runner.camera.minScale,this.runner.camera.maxScale);var C=this.runner.camera.scale-m;C*=q(1),this.scrollView(-(h.x+d.x)*.5+w.x*C,(h.y+d.y)*.5+w.y*C)}this.state.touchPosOld[0]=i,this.state.touchPosOld[1]=e,r.preventDefault()}},this.touchHandler=r=>{if(r.touches.length<=1){var i={touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"}[r.type]||"",e=r.changedTouches[0],n=document.createEvent("MouseEvent");n.initMouseEvent(i,!0,!0,window,1,e.screenX,e.screenY,e.clientX,e.clientY,!1,!1,!1,!1,0,null),e.target.dispatchEvent(n)}else this[r.type]&&this[r.type](r);r.preventDefault()},["mousedown","mousemove","mouseup","mouseleave","mousewheel"].forEach(r=>this.runner.renderer.canvas.addEventListener(r,this[r])),this.runner.renderer.canvas.addEventListener("touchstart",this.touchHandler),this.runner.renderer.canvas.addEventListener("touchmove",this.touchHandler),this.runner.renderer.canvas.addEventListener("touchend",this.touchHandler),this.runner.renderer.canvas.addEventListener("touchcancel",this.touchHandler)}G.prototype.destroy=function(){["mousedown","mousemove","mouseup","mouseleave","mousewheel"].forEach(t=>this.runner.renderer.canvas.removeEventListener(t,this[t])),this.runner.renderer.canvas.removeEventListener("touchstart",this.touchHandler),this.runner.renderer.canvas.removeEventListener("touchmove",this.touchHandler),this.runner.renderer.canvas.removeEventListener("touchend",this.touchHandler),this.runner.renderer.canvas.removeEventListener("touchcancel",this.touchHandler),this.removeJoint(),this.runner.world.removeBody(this.mouseBody)};G.prototype.removeJoint=function(){this.mouseJoint&&(this.runner.world.removeJoint(this.mouseJoint),this.mouseJoint=null)};G.prototype.getMousePosition=function(t){return new s(t.offsetX,t.offsetY)};G.prototype.getTouchPosition=function(t){var r=this.runner.renderer.canvas.getBoundingClientRect();return new s(t.clientX-r.left,t.clientY-r.top)};G.prototype.scrollView=function(t,r){this.runner.camera.origin.x+=t,this.runner.camera.origin.y+=r,this.runner.dirtyBounds.set(this.runner.canvasToWorld(new s(0,this.runner.renderer.height)),this.runner.canvasToWorld(new s(this.runner.renderer.width,0))),this.runner.static_outdated=!0};function gt(t,r,i,e,n){t.beginPath(),t.moveTo(r.x,r.y),t.lineTo(i.x,i.y),t.lineWidth=e,t.strokeStyle=n,t.stroke()}function pt(t,r,i,e,n,o,a){t.beginPath();var h=s.sub(r,i),d=s.add(r,i),c=s.sub(h,e),y=s.add(h,e),w=s.sub(d,e),m=s.add(d,e);t.moveTo(c.x,c.y),t.lineTo(w.x,w.y),t.lineTo(m.x,m.y),t.lineTo(y.x,y.y),t.lineTo(c.x,c.y),t.closePath(),a&&(t.fillStyle=a,t.fill()),o&&(t.lineWidth=n,t.strokeStyle=o,t.stroke())}function At(t,r,i,e,n,o,a){if(t.beginPath(),t.arc(r.x,r.y,i,0,Math.PI*2,!1),a&&(t.fillStyle=a,t.fill()),o){if(typeof e=="number"){t.moveTo(r.x,r.y);var h=s.add(r,s.scale(s.rotation(e),i));t.lineTo(h.x,h.y)}t.lineWidth=n,t.strokeStyle=o,t.stroke()}}function Pt(t,r,i,e,n,o,a){t.beginPath();var h=s.normalize(s.perp(s.sub(i,r))),d=h.toAngle();t.arc(r.x,r.y,e,d,d+Math.PI,!1);var c=s.scale(h,-e),y=s.add(i,c);t.lineTo(y.x,y.y),d+=Math.PI,t.arc(i.x,i.y,e,d,d+Math.PI,!1),c=s.scale(h,e);var w=s.add(r,c);t.lineTo(w.x,w.y),t.closePath(),a&&(t.fillStyle=a,t.fill()),o&&(t.lineWidth=n,t.strokeStyle=o,t.stroke())}function vt(t,r,i,e,n){t.beginPath(),t.moveTo(r[0].x,r[0].y);for(var o=0;o<r.length;o++)t.lineTo(r[o].x,r[o].y);t.lineTo(r[r.length-1].x,r[r.length-1].y),t.closePath(),n&&(t.fillStyle=n,t.fill()),e&&(t.lineWidth=i,t.strokeStyle=e,t.stroke())}function V(t){this.canvas=t,this.fg={canvas:t,ctx:t.getContext("2d")},this.bg={canvas:document.createElement("canvas")},this.bg.ctx=this.bg.canvas.getContext("2d"),this.resize()}V.prototype.drawShape=function(t,r,i,e,n){switch(t.type){case A.TYPE_CIRCLE:At(r?this.bg.ctx:this.fg.ctx,t.tc,t.r,t.body.a,i,e,n);break;case A.TYPE_SEGMENT:Pt(r?this.bg.ctx:this.fg.ctx,t.ta,t.tb,t.r,i,e,n);break;case A.TYPE_POLY:t.convexity?vt(r?this.bg.ctx:this.fg.ctx,t.tverts,i,e,n):vt(r?this.bg.ctx:this.fg.ctx,t.tverts,i,e,n);break}};V.prototype.copyBackground=function(t,r,i,e,n,o,a,h){this.fg.ctx.drawImage(this.bg.canvas,t,r,i,e,n,o,a,h)};V.prototype.beginStatic=function(t,r){this.bg.ctx.fillStyle=r,this.bg.ctx.fillRect(0,0,this.width,this.height),this.bg.ctx.save(),this.bg.ctx.setTransform(t.scale*q(1),0,0,-(t.scale*q(1)),this.width*.5-t.origin.x,this.height+t.origin.y)};V.prototype.endStatic=function(){this.bg.ctx.restore()};V.prototype.beginDynamic=function(t){this.fg.ctx.save(),this.fg.ctx.setTransform(t.scale*q(1),0,0,-(t.scale*q(1)),this.width*.5-t.origin.x,this.height+t.origin.y)};V.prototype.endDynamic=function(){this.fg.ctx.restore()};V.prototype.resize=function(){this.width=this.fg.canvas.width=this.bg.canvas.width=this.canvas.width=this.canvas.offsetWidth,this.height=this.fg.canvas.height=this.bg.canvas.height=this.canvas.height=this.canvas.offsetHeight};V.prototype.drawHelperJointAnchors=function(t,r,i,e,n){var o=new s(i,0),a=new s(0,i);pt(this.fg.ctx,t,o,a,0,"",n),pt(this.fg.ctx,r,o,a,0,"",n),gt(this.fg.ctx,t,r,e,n)};
